<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWERGRID Material Demand Forecasting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: '#FDFBF7',
                        'jungle-green': '#064E3B',
                        'pop-pink': '#F472B6',
                        'lime-accent': '#D9F99D'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 40px -10px rgba(0,0,0,0.08)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Fade In Up Animation */
        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(50px);
            transition: all 1.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .reveal-on-scroll.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Glassmorphism for Hero SVG */
        .glass-panel {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        /* Hide scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #FDFBF7;
        }

        ::-webkit-scrollbar-thumb {
            background: #E5E7EB;
            border-radius: 4px;
        }

        /* Dashboard Styles */
        .nav-link {
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: #334155;
            color: #2dd4bf;
        }

        .nav-link.active {
            background: #1e293b;
            color: #2dd4bf;
            border-left: 4px solid #2dd4bf;
        }

        /* Dark Theme Styles */
        body.dark-theme #app .flex.h-screen {
            background: #0f172a;
        }

        body.dark-theme #sidebar {
            background: #020617;
            border-color: #1e293b;
        }

        body.dark-theme header {
            background: #1e293b;
            border-color: #334155;
        }

        body.dark-theme #page-title {
            color: #e2e8f0;
        }

        body.dark-theme #main-content {
            background: #0f172a;
        }

        body.dark-theme .bg-white {
            background: #1e293b !important;
        }

        body.dark-theme .text-slate-800 {
            color: #e2e8f0 !important;
        }

        body.dark-theme .text-slate-700 {
            color: #cbd5e1 !important;
        }

        body.dark-theme .text-slate-600 {
            color: #94a3b8 !important;
        }

        body.dark-theme .text-slate-500 {
            color: #64748b !important;
        }

        body.dark-theme .border-slate-200 {
            border-color: #334155 !important;
        }

        body.dark-theme .bg-slate-50 {
            background: #1e293b !important;
        }

        body.dark-theme .bg-slate-100 {
            background: #0f172a !important;
        }

        body.dark-theme input,
        body.dark-theme select,
        body.dark-theme textarea {
            background: #0f172a !important;
            color: #e2e8f0 !important;
            border-color: #334155 !important;
        }

        body.dark-theme .badge {
            background: #1e293b !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #2dd4bf;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .material-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .material-card:hover {
            transform: translateX(4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2dd4bf, #14b8a6);
            transition: width 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2dd4bf;
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: #2dd4bf;
            color: #0f172a;
        }

        .btn-primary:hover {
            background: #14b8a6;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(45, 212, 191, 0.3);
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #2dd4bf;
            color: #2dd4bf;
        }

        .btn-outline:hover {
            background: #2dd4bf;
            color: #0f172a;
        }

        /* Sidebar Toggle */
        #sidebar {
            width: 256px;
            transition: width 0.3s ease, margin-left 0.3s ease;
        }

        #sidebar.collapsed {
            width: 80px;
        }

        #sidebar.collapsed .nav-link span,
        #sidebar.collapsed .ml-3 {
            display: none;
        }

        #sidebar.collapsed .nav-link {
            justify-content: center;
        }

        .sidebar-toggle {
            transition: transform 0.3s ease;
        }

        #sidebar.collapsed .sidebar-toggle {
            transform: rotate(180deg);
        }

        /* Map Container */
        .map-container {
            height: 400px;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #f1f5f9;
            position: relative;
        }

        .map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .location-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .location-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
        }

        /* Procurement Tab Buttons */
        .procurement-tab-btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .procurement-tab-btn:hover {
            color: #2dd4bf;
            background: #f1f5f9;
        }

        .procurement-tab-btn.active {
            color: #2dd4bf;
            border-bottom-color: #2dd4bf;
            background: #f0fdfa;
        }

        .procurement-tab-content {
            display: none;
        }

        .procurement-tab-content:not(.hidden) {
            display: block;
        }

        /* Inventory Tab Buttons */
        .inventory-tab-btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .inventory-tab-btn:hover {
            color: #7c3aed;
            background: #f1f5f9;
        }

        .inventory-tab-btn.active {
            color: #7c3aed;
            border-bottom-color: #7c3aed;
            background: #faf5ff;
        }

        /* Forecast Tab Buttons */
        .forecast-tab {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .forecast-tab:hover {
            color: #0d9488;
            background: #f0fdfa;
        }

        .forecast-tab.active {
            color: #0d9488;
            border-bottom-color: #0d9488;
            background: #f0fdfa;
        }

        /* Forecast Tab Content */
        .tab-content {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .inventory-tab-content {
            display: none;
        }

        .inventory-tab-content:not(.hidden) {
            display: block;
        }

        /* Pagination Styles */
        .pagination-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .pagination-btn.active {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Print Styles */
        @media print {

            /* Hide all non-report elements */
            #home-page,
            #login-page,
            #sidebar,
            header,
            .nav-link,
            .btn,
            button,
            .no-print,
            #app>.flex>aside,
            #app>.flex>.flex-1>header,
            .grid.grid-cols-1.md\:grid-cols-3.gap-6.mb-8 {
                display: none !important;
            }

            /* Show only the report content */
            body {
                background: white !important;
                margin: 0;
                padding: 0;
            }

            #app {
                display: block !important;
            }

            #main-content {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            /* Show only generated report */
            #report-display {
                display: block !important;
                margin: 0 !important;
                padding: 20px !important;
            }

            .printable-report {
                display: block !important;
                page-break-inside: avoid;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
            }

            /* Optimize tables for print */
            .data-table {
                font-size: 9pt;
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 1rem;
            }

            .data-table th {
                background: #f8fafc !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 8px;
                border: 1px solid #e2e8f0;
            }

            .data-table td {
                page-break-inside: avoid;
                padding: 6px 8px;
                border: 1px solid #e2e8f0;
            }

            /* Ensure colored backgrounds print */
            .bg-gradient-to-br,
            .badge,
            .progress-fill {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Header styling for print */
            .printable-report h2 {
                font-size: 24pt;
                margin-bottom: 0.5rem;
            }

            .printable-report h3 {
                font-size: 16pt;
                margin-top: 1.5rem;
                margin-bottom: 0.75rem;
            }

            .printable-report h4 {
                font-size: 12pt;
                margin-bottom: 0.5rem;
            }

            /* Optimize spacing for print */
            .mb-8 {
                margin-bottom: 1rem !important;
            }

            .mb-6 {
                margin-bottom: 0.75rem !important;
            }

            .mb-4 {
                margin-bottom: 0.5rem !important;
            }

            .mt-8 {
                margin-top: 1rem !important;
            }

            /* Hide modal overlay and show only content when printing from modal */
            #modal-overlay {
                background: white !important;
                position: static !important;
            }

            #modal-content {
                max-width: 100% !important;
                max-height: none !important;
                overflow: visible !important;
                margin: 0 !important;
                box-shadow: none !important;
                border-radius: 0 !important;
            }

            /* Show forecast results when printing */
            #forecast-results-display {
                display: block !important;
                visibility: visible !important;
                overflow: visible !important;
            }

            /* Hide back button and action buttons when printing */
            #forecast-results-display button:first-child,
            #forecast-results-display .btn-primary,
            #forecast-results-display .btn-outline {
                display: none !important;
            }

            /* Style forecast report header for print */
            .bg-gradient-to-r {
                background: linear-gradient(to right, #0d9488, #3b82f6) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                border-radius: 8px !important;
            }

            /* Ensure project details text is visible in print */
            .bg-gradient-to-r h2,
            .bg-gradient-to-r p,
            .bg-gradient-to-r span,
            .bg-gradient-to-r div {
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Ensure project details card has proper background */
            .backdrop-blur-sm {
                background: #f8fafc !important;
                border: 1px solid #cbd5e1 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                padding: 0.75rem !important;
            }

            /* Ensure text in project details is dark and visible */
            .backdrop-blur-sm p,
            .backdrop-blur-sm div {
                color: #334155 !important;
            }

            .backdrop-blur-sm .text-teal-100 {
                color: #64748b !important;
            }

            .backdrop-blur-sm .text-white {
                color: #0f172a !important;
                font-weight: 600 !important;
            }

            /* Ensure all content is visible */
            .overflow-x-auto,
            .overflow-y-auto {
                overflow: visible !important;
                max-height: none !important;
            }

            /* Ensure tables fit on page */
            .data-table {
                width: 100% !important;
                page-break-inside: auto !important;
                font-size: 8pt !important;
            }

            .data-table thead {
                display: table-header-group !important;
            }

            .data-table tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }

            .data-table td,
            .data-table th {
                font-size: 8pt !important;
                padding: 4px !important;
            }

            /* Print charts properly */
            #forecast-chart {
                max-width: 100% !important;
                height: 180px !important;
                page-break-inside: avoid !important;
            }

            /* Ensure grid layout displays properly in print */
            .grid {
                display: grid !important;
            }

            .lg\\:grid-cols-2 {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem !important;
                page-break-inside: avoid !important;
                margin-bottom: 0.5rem !important;
            }

            /* Ensure chart and recommendations containers are visible */
            .lg\\:grid-cols-2>div {
                height: auto !important;
                max-height: 250px !important;
                overflow: visible !important;
            }

            /* Make recommendations scrollable area fully visible */
            .lg\\:grid-cols-2 .overflow-y-auto {
                max-height: 220px !important;
                overflow: visible !important;
            }

            /* Ensure all sections are visible */
            .rounded-xl,
            .shadow-lg,
            .border {
                border: 1px solid #e2e8f0 !important;
                border-radius: 4px !important;
                box-shadow: none !important;
                page-break-inside: avoid !important;
                margin-bottom: 0.5rem !important;
            }

            /* Make sure recommendations are fully visible */
            .space-y-2>div {
                margin-bottom: 0.25rem !important;
                page-break-inside: avoid !important;
            }

            /* Page breaks */
            h2,
            h3 {
                page-break-after: avoid;
            }

            .overflow-x-auto {
                overflow: visible !important;
            }

            /* Grid layouts for print */
            .grid {
                page-break-inside: avoid;
            }

            /* Stat cards */
            .grid.grid-cols-1.md\:grid-cols-4 {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
                margin-bottom: 1rem !important;
            }

            .grid.grid-cols-1.lg\:grid-cols-2 {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            /* Text sizing */
            .text-3xl {
                font-size: 20pt !important;
            }

            .text-xl {
                font-size: 14pt !important;
            }

            .text-sm {
                font-size: 9pt !important;
            }

            .text-xs {
                font-size: 8pt !important;
            }

            /* Padding adjustments */
            .p-8 {
                padding: 1rem !important;
            }

            .p-6 {
                padding: 0.75rem !important;
            }

            .p-4 {
                padding: 0.5rem !important;
            }
        }
    </style>
</head>

<body class="bg-cream antialiased text-gray-800">

    <div id="home-page">
        <header class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-40 transition-all duration-300"
            id="main-header">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center">
                    <svg class="h-8 w-auto text-jungle-green" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75" />
                    </svg>
                    <span class="ml-3 font-black text-xl text-jungle-green tracking-tight">POWERGRID</span>
                </div>
                <div class="hidden md:flex items-center space-x-8" id="home-page-nav">
                    <a href="#features"
                        class="text-gray-600 hover:text-pop-pink font-bold transition-colors">Features</a>
                    <a href="#how-it-works" class="text-gray-600 hover:text-pop-pink font-bold transition-colors">How it
                        works</a>
                    <a href="#solution"
                        class="text-gray-600 hover:text-pop-pink font-bold transition-colors">Solution</a>
                    <a href="#contact" class="text-gray-600 hover:text-pop-pink font-bold transition-colors">Contact</a>
                </div>
                <div class="flex items-center">
                    <button id="home-signin-btn"
                        class="bg-jungle-green text-white py-2.5 px-6 rounded-xl hover:bg-black font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">Sign
                        In</button>
                </div>
            </nav>
        </header>

        <main>
            <!-- HERO SECTION -->
            <section id="hero-section" class="relative min-h-screen flex items-center overflow-hidden bg-slate-900">
                <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-[#0f172a] to-slate-900"></div>
                <div class="absolute top-0 left-0 w-full h-full opacity-20"
                    style="background-image: radial-gradient(#3b82f6 1px, transparent 1px); background-size: 40px 40px;">
                </div>
                <div
                    class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-600/20 rounded-full blur-3xl filter mix-blend-screen animate-pulse">
                </div>
                <div
                    class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-teal-500/10 rounded-full blur-3xl filter mix-blend-screen">
                </div>

                <div class="container mx-auto px-6 grid lg:grid-cols-2 gap-12 items-center relative z-10 pt-20 lg:pt-0">
                    <div class="text-center lg:text-left">
                        <div
                            class="inline-flex items-center px-3 py-1 rounded-full border border-blue-500/30 bg-blue-500/10 text-blue-300 text-xs font-medium mb-6">
                            <span class="flex h-2 w-2 rounded-full bg-blue-400 mr-2 animate-pulse"></span>
                            Next-Gen AI Forecasting
                        </div>
                        <h1
                            class="text-3xl md:text-4xl lg:text-5xl font-extrabold text-white mb-6 leading-tight tracking-tight">
                            Optimize Material Demand with <span
                                class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">Intelligent
                                AI</span>
                        </h1>
                        <p class="text-base text-slate-300 max-w-xl mx-auto lg:mx-0 mb-8 leading-relaxed">
                            Eliminate shortages and reduce overstocking. Our predictive platform analyzes historical
                            data to forecast procurement needs for POWERGRID projects across India.
                        </p>
                        <div class="flex flex-col sm:flex-row justify-center lg:justify-start gap-4">
                            <button id="get-started-btn"
                                class="bg-blue-600 text-white py-3.5 px-8 rounded-full font-semibold hover:bg-blue-500 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">Get
                                Started</button>
                            <button id="learn-more-btn"
                                class="bg-slate-800/50 text-white backdrop-blur-sm border border-white/10 py-3.5 px-8 rounded-full font-semibold hover:bg-white/10 transition-all hover:border-white/30">Learn
                                More</button>
                        </div>
                        <div
                            class="mt-10 pt-8 border-t border-white/5 flex flex-col sm:flex-row items-center justify-center lg:justify-start gap-6 text-slate-400 text-sm">
                            <div class="flex items-center gap-2"><svg class="w-5 h-5 text-teal-400" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg><span>98% Forecast Accuracy</span></div>
                            <div class="flex items-center gap-2"><svg class="w-5 h-5 text-teal-400" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg><span>Real-time Analytics</span></div>
                        </div>
                    </div>
                    <div class="relative animate-float hidden lg:block">
                        <svg viewBox="0 0 600 450" fill="none" xmlns="http://www.w3.org/2000/svg"
                            class="w-full h-auto drop-shadow-2xl">
                            <defs>
                                <linearGradient id="cardGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="rgba(30, 41, 59, 0.8)" />
                                    <stop offset="100%" stop-color="rgba(15, 23, 42, 0.9)" />
                                </linearGradient>
                                <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="#2dd4bf" stop-opacity="0.5" />
                                    <stop offset="100%" stop-color="#2dd4bf" stop-opacity="0" />
                                </linearGradient>
                                <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur" />
                                    <feMerge>
                                        <feMergeNode in="coloredBlur" />
                                        <feMergeNode in="SourceGraphic" />
                                    </feMerge>
                                </filter>
                            </defs>
                            <rect x="50" y="50" width="500" height="320" rx="16" fill="url(#cardGradient)"
                                stroke="rgba(255,255,255,0.1)" stroke-width="1" class="glass-panel" />
                            <circle cx="80" cy="80" r="4" fill="#ef4444" opacity="0.8" />
                            <circle cx="96" cy="80" r="4" fill="#f59e0b" opacity="0.8" />
                            <circle cx="112" cy="80" r="4" fill="#22c55e" opacity="0.8" />
                            <rect x="75" y="110" width="80" height="8" rx="4" fill="rgba(255,255,255,0.1)" />
                            <rect x="75" y="135" width="60" height="6" rx="3" fill="rgba(255,255,255,0.05)" />
                            <rect x="75" y="155" width="50" height="6" rx="3" fill="rgba(255,255,255,0.05)" />
                            <rect x="75" y="175" width="65" height="6" rx="3" fill="rgba(255,255,255,0.05)" />
                            <line x1="180" y1="110" x2="180" y2="330" stroke="rgba(255,255,255,0.05)"
                                stroke-width="1" />
                            <line x1="210" y1="300" x2="520" y2="300" stroke="rgba(255,255,255,0.05)"
                                stroke-width="1" />
                            <line x1="210" y1="250" x2="520" y2="250" stroke="rgba(255,255,255,0.05)"
                                stroke-width="1" />
                            <line x1="210" y1="200" x2="520" y2="200" stroke="rgba(255,255,255,0.05)"
                                stroke-width="1" />
                            <path d="M210 280 Q 260 270, 310 220 T 410 200 T 520 160 V 300 H 210 Z"
                                fill="url(#chartGradient)" opacity="0.3" />
                            <path d="M210 280 Q 260 270, 310 220 T 410 200 T 520 160" stroke="#2dd4bf" stroke-width="3"
                                fill="none" stroke-linecap="round" filter="url(#glow)" />
                            <circle cx="310" cy="220" r="4" fill="#1e293b" stroke="#2dd4bf" stroke-width="2" />
                            <circle cx="410" cy="200" r="4" fill="#1e293b" stroke="#2dd4bf" stroke-width="2" />
                            <circle cx="520" cy="160" r="4" fill="#1e293b" stroke="#2dd4bf" stroke-width="2" />
                            <g transform="translate(420, 90)">
                                <rect width="140" height="60" rx="8" fill="rgba(30, 41, 59, 0.9)"
                                    stroke="rgba(45, 212, 191, 0.3)" stroke-width="1" class="glass-panel" />
                                <circle cx="30" cy="30" r="12" fill="rgba(45, 212, 191, 0.2)" />
                                <path d="M24 30 L28 34 L36 26" stroke="#2dd4bf" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <text x="50" y="25" fill="#94a3b8" font-size="10"
                                    font-family="sans-serif">Efficiency</text>
                                <text x="50" y="42" fill="white" font-size="14" font-family="sans-serif"
                                    font-weight="bold">+24.5%</text>
                            </g>
                            <g transform="translate(20, 280)">
                                <rect width="130" height="50" rx="8" fill="rgba(30, 41, 59, 0.9)"
                                    stroke="rgba(255,255,255,0.1)" stroke-width="1" class="glass-panel" />
                                <circle cx="25" cy="25" r="8" fill="#3b82f6" />
                                <rect x="45" y="18" width="60" height="6" rx="3" fill="rgba(255,255,255,0.8)" />
                                <rect x="45" y="30" width="40" height="4" rx="2" fill="rgba(255,255,255,0.3)" />
                            </g>
                        </svg>
                    </div>
                </div>
            </section>

            <!-- 1. Challenges Section -->
            <section id="challenges" class="py-32 bg-cream relative overflow-hidden">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-20 reveal-on-scroll">
                        <span
                            class="text-sm font-black uppercase text-pop-pink tracking-widest mb-4 block">Challenges</span>
                        <h2 class="text-5xl md:text-7xl font-black text-jungle-green mt-2 uppercase leading-none">The
                            Complexity<br>of Scale</h2>
                        <p class="text-gray-500 mt-8 text-lg max-w-2xl mx-auto font-medium">
                            POWERGRID executes numerous national projects. We help you manage variables like budgets,
                            locations, and taxes to prevent cost overruns.
                        </p>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 text-center max-w-7xl mx-auto">
                        <div
                            class="reveal-on-scroll group bg-white p-8 rounded-3xl shadow-card hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 cursor-pointer border border-transparent hover:border-lime-accent">
                            <div
                                class="bg-lime-accent/30 text-jungle-green rounded-2xl p-4 mb-4 inline-block group-hover:scale-110 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                            </div>
                            <p class="font-bold text-jungle-green text-lg">Budgets</p>
                        </div>
                        <div class="reveal-on-scroll group bg-white p-8 rounded-3xl shadow-card hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 cursor-pointer border border-transparent hover:border-lime-accent"
                            style="transition-delay: 200ms;">
                            <div
                                class="bg-lime-accent/30 text-jungle-green rounded-2xl p-4 mb-4 inline-block group-hover:scale-110 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                            </div>
                            <p class="font-bold text-jungle-green text-lg">Locations</p>
                        </div>
                        <div class="reveal-on-scroll group bg-white p-8 rounded-3xl shadow-card hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 cursor-pointer border border-transparent hover:border-lime-accent"
                            style="transition-delay: 400ms;">
                            <div
                                class="bg-lime-accent/30 text-jungle-green rounded-2xl p-4 mb-4 inline-block group-hover:scale-110 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="m12 2 7 10H5Z"></path>
                                    <path d="m12 22 7-10H5Z"></path>
                                </svg>
                            </div>
                            <p class="font-bold text-jungle-green text-lg">Tower Types</p>
                        </div>
                        <div class="reveal-on-scroll group bg-white p-8 rounded-3xl shadow-card hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 cursor-pointer border border-transparent hover:border-lime-accent"
                            style="transition-delay: 600ms;">
                            <div
                                class="bg-lime-accent/30 text-jungle-green rounded-2xl p-4 mb-4 inline-block group-hover:scale-110 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <rect x="3" y="14" width="18" height="7" rx="2" ry="2"></rect>
                                    <line x1="6" y1="14" x2="6" y2="11"></line>
                                    <line x1="18" y1="14" x2="18" y2="11"></line>
                                    <path d="M6 11h.01"></path>
                                    <path d="M18 11h.01"></path>
                                    <path d="M12 11h.01"></path>
                                    <path d="M4 11h16"></path>
                                    <path d="M12 14v-3"></path>
                                </svg>
                            </div>
                            <p class="font-bold text-jungle-green text-lg">Sub-stations</p>
                        </div>
                        <div class="reveal-on-scroll group bg-white p-8 rounded-3xl shadow-card hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 cursor-pointer border border-transparent hover:border-lime-accent"
                            style="transition-delay: 800ms;">
                            <div
                                class="bg-lime-accent/30 text-jungle-green rounded-2xl p-4 mb-4 inline-block group-hover:scale-110 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M19 5c-1.5 0-2.8 1.4-3 2-3.5-1.5-11-.3-11 5 0 1.8 0 3 2 4.5V20h4v-2h3v2h4v-4s1.7-1 2-4c0-2.2-2.3-3.5-5-5-1.3-1-2-1.3-3-1.3-1 0-1.7.3-3 1 .3-1.7 1.5-3 3-3z">
                                    </path>
                                </svg>
                            </div>
                            <p class="font-bold text-jungle-green text-lg">Taxes</p>
                        </div>
                        <div class="reveal-on-scroll group bg-white p-8 rounded-3xl shadow-card hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 cursor-pointer border border-transparent hover:border-lime-accent"
                            style="transition-delay: 1000ms;">
                            <div
                                class="bg-lime-accent/30 text-jungle-green rounded-2xl p-4 mb-4 inline-block group-hover:scale-110 transition-transform">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z">
                                    </path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                            </div>
                            <p class="font-bold text-jungle-green text-lg">Geography</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. Features Section -->
            <section id="features" class="py-32 bg-white">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-20 reveal-on-scroll">
                        <span class="text-sm font-black uppercase text-pop-pink tracking-widest mb-4 block">Platform
                            Features</span>
                        <h2 class="text-5xl md:text-6xl font-black text-jungle-green mt-2 uppercase leading-none">
                            Everything You Need<br>To Forecast</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Feature 1 -->
                        <div
                            class="reveal-on-scroll bg-[#F5F5F0] p-10 rounded-[2.5rem] shadow-lg hover:shadow-2xl transition-all duration-500 hover:-translate-y-4 border border-gray-200">
                            <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mb-8 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                    fill="none" stroke="#064E3B" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
                                    <path d="M22 12A10 10 0 0 0 12 2v10z" />
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-jungle-green mb-4">Accurate Forecasting</h3>
                            <p class="text-gray-500 font-medium leading-relaxed">Leverage AI to predict material needs
                                with high accuracy based on project variables.</p>
                        </div>
                        <!-- Feature 2 -->
                        <div class="reveal-on-scroll bg-[#F5F5F0] p-10 rounded-[2.5rem] shadow-lg hover:shadow-2xl transition-all duration-500 hover:-translate-y-4 border border-gray-200"
                            style="transition-delay: 200ms;">
                            <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mb-8 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                    fill="none" stroke="#064E3B" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                                    </path>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-jungle-green mb-4">Inventory Control</h3>
                            <p class="text-gray-500 font-medium leading-relaxed">Maintain optimal stock levels, automate
                                reorder points, and prevent costly shortages.</p>
                        </div>
                        <!-- Feature 3 -->
                        <div class="reveal-on-scroll bg-[#F5F5F0] p-10 rounded-[2.5rem] shadow-lg hover:shadow-2xl transition-all duration-500 hover:-translate-y-4 border border-gray-200"
                            style="transition-delay: 400ms;">
                            <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mb-8 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                    fill="none" stroke="#064E3B" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 20V10"></path>
                                    <path d="M18 20V4"></path>
                                    <path d="M6 20V16"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-jungle-green mb-4">Real-Time Dashboards</h3>
                            <p class="text-gray-500 font-medium leading-relaxed">Access dynamic visualizations and
                                reports for informed, data-driven decision-making.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. How it Works Section -->
            <section id="how-it-works" class="py-32 bg-jungle-green text-white">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-24 reveal-on-scroll">
                        <span class="text-sm font-black uppercase text-lime-accent tracking-widest mb-4 block">Our
                            Process</span>
                        <h2 class="text-5xl md:text-6xl font-black mt-2 uppercase leading-none">Four Steps<br>To
                            Efficiency</h2>
                    </div>
                    <div class="max-w-4xl mx-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Step 1 -->
                            <div
                                class="reveal-on-scroll bg-white/5 p-8 rounded-3xl backdrop-blur-sm border border-white/10 hover:bg-white/10 transition-all duration-300">
                                <div class="flex items-center mb-4">
                                    <div
                                        class="flex items-center justify-center h-12 w-12 rounded-full bg-lime-accent text-jungle-green text-xl font-black mr-4">
                                        1</div>
                                    <h3 class="text-2xl font-bold">Input Data</h3>
                                </div>
                                <p class="text-gray-300 font-medium">Securely upload your project details including
                                    budget, locations, and material specifications.</p>
                            </div>
                            <!-- Step 2 -->
                            <div class="reveal-on-scroll bg-white/5 p-8 rounded-3xl backdrop-blur-sm border border-white/10 hover:bg-white/10 transition-all duration-300"
                                style="transition-delay: 200ms;">
                                <div class="flex items-center mb-4">
                                    <div
                                        class="flex items-center justify-center h-12 w-12 rounded-full bg-lime-accent text-jungle-green text-xl font-black mr-4">
                                        2</div>
                                    <h3 class="text-2xl font-bold">AI Analysis</h3>
                                </div>
                                <p class="text-gray-300 font-medium">Our intelligent model analyzes the data,
                                    identifying patterns and forecasting future needs.</p>
                            </div>
                            <!-- Step 3 -->
                            <div class="reveal-on-scroll bg-white/5 p-8 rounded-3xl backdrop-blur-sm border border-white/10 hover:bg-white/10 transition-all duration-300"
                                style="transition-delay: 400ms;">
                                <div class="flex items-center mb-4">
                                    <div
                                        class="flex items-center justify-center h-12 w-12 rounded-full bg-lime-accent text-jungle-green text-xl font-black mr-4">
                                        3</div>
                                    <h3 class="text-2xl font-bold">Get Forecast</h3>
                                </div>
                                <p class="text-gray-300 font-medium">Receive a detailed breakdown of required materials
                                    and smart procurement suggestions.</p>
                            </div>
                            <!-- Step 4 -->
                            <div class="reveal-on-scroll bg-white/5 p-8 rounded-3xl backdrop-blur-sm border border-white/10 hover:bg-white/10 transition-all duration-300"
                                style="transition-delay: 600ms;">
                                <div class="flex items-center mb-4">
                                    <div
                                        class="flex items-center justify-center h-12 w-12 rounded-full bg-lime-accent text-jungle-green text-xl font-black mr-4">
                                        4</div>
                                    <h3 class="text-2xl font-bold">Optimize</h3>
                                </div>
                                <p class="text-gray-300 font-medium">Track your inventory in real-time and continuously
                                    optimize your supply chain.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Solution Section -->
            <section id="solution" class="py-32 bg-cream">
                <div class="container mx-auto px-6">
                    <div class="text-center mb-20 reveal-on-scroll">
                        <span class="text-sm font-black uppercase text-pop-pink tracking-widest mb-4 block">The
                            Solution</span>
                        <h2 class="text-5xl md:text-6xl font-black text-jungle-green mt-2 uppercase leading-none">Unlock
                            Tangible<br>Business Value</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Card 1 -->
                        <div
                            class="reveal-on-scroll bg-white p-8 rounded-3xl shadow-card hover:-translate-y-2 transition-transform duration-300">
                            <div
                                class="flex justify-start items-center mb-6 h-14 w-14 rounded-2xl bg-lime-accent/40 text-jungle-green">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-jungle-green mb-2">Minimize Costs</h3>
                            <p class="text-gray-500 font-medium">Prevent over-stocking and leverage bulk purchasing
                                insights.</p>
                        </div>
                        <!-- Card 2 -->
                        <div class="reveal-on-scroll bg-white p-8 rounded-3xl shadow-card hover:-translate-y-2 transition-transform duration-300"
                            style="transition-delay: 200ms;">
                            <div
                                class="flex justify-start items-center mb-6 h-14 w-14 rounded-2xl bg-lime-accent/40 text-jungle-green">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 6 9 17l-5-5"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-jungle-green mb-2">Avoid Shortages</h3>
                            <p class="text-gray-500 font-medium">Ensure materials are available when needed, eliminating
                                costly delays.</p>
                        </div>
                        <!-- Card 3 -->
                        <div class="reveal-on-scroll bg-white p-8 rounded-3xl shadow-card hover:-translate-y-2 transition-transform duration-300"
                            style="transition-delay: 400ms;">
                            <div
                                class="flex justify-start items-center mb-6 h-14 w-14 rounded-2xl bg-lime-accent/40 text-jungle-green">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="m12 14 4-4"></path>
                                    <path d="M3.34 19a10 10 0 1 1 17.32 0"></path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-jungle-green mb-2">Improve Efficiency</h3>
                            <p class="text-gray-500 font-medium">Streamline your supply chain and reduce manual planning
                                efforts.</p>
                        </div>
                        <!-- Card 4 -->
                        <div class="reveal-on-scroll bg-white p-8 rounded-3xl shadow-card hover:-translate-y-2 transition-transform duration-300"
                            style="transition-delay: 600ms;">
                            <div
                                class="flex justify-start items-center mb-6 h-14 w-14 rounded-2xl bg-lime-accent/40 text-jungle-green">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path
                                        d="M15.03 5.39a2.4 2.4 0 0 0-3.46 0l-3.03 3.03a2.4 2.4 0 0 0 0 3.46l3.03 3.03a2.4 2.4 0 0 0 3.46 0l3.03-3.03a2.4 2.4 0 0 0 0-3.46Z">
                                    </path>
                                    <path d="m9.01 15.01 3-3"></path>
                                    <path
                                        d="M2.39 15.03a2.4 2.4 0 0 0 0 3.46l3.03 3.03a2.4 2.4 0 0 0 3.46 0l3.03-3.03a2.4 2.4 0 0 0 0-3.46Z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-jungle-green mb-2">Enhance Decisions</h3>
                            <p class="text-gray-500 font-medium">Make strategic choices with confidence, backed by
                                reliable data.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 5. Contact Section -->
            <section id="contact" class="py-32 bg-white relative">
                <div class="container mx-auto px-6">
                    <div class="grid md:grid-cols-2 gap-12 max-w-6xl mx-auto items-center">
                        <div class="reveal-on-scroll">
                            <span class="text-sm font-black uppercase text-pop-pink tracking-widest mb-4 block">Get in
                                Touch</span>
                            <h2 class="text-5xl font-black text-jungle-green mb-6 leading-none">READY TO
                                OPTIMIZE<br>YOUR PROJECTS?</h2>
                            <p class="text-gray-500 text-lg font-medium mb-8">Contact our team to schedule a demo or
                                learn more about how POWERGRID is transforming material forecasting.</p>

                            <div class="bg-cream p-8 rounded-3xl border border-gray-100">
                                <h3 class="text-xl font-bold text-jungle-green mb-6">Contact Information</h3>
                                <div class="space-y-6">
                                    <div class="flex items-start space-x-4">
                                        <div class="flex-shrink-0 bg-white p-3 rounded-xl shadow-sm text-jungle-green">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                                </path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="font-bold text-jungle-green">Headquarters</p>
                                            <p class="text-gray-500 mt-1 font-medium text-sm">POWERGRID Corporation of
                                                India Ltd.<br>Gurgaon (Haryana) - 122001, INDIA</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-4">
                                        <div class="flex-shrink-0 bg-white p-3 rounded-xl shadow-sm text-jungle-green">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="font-bold text-jungle-green">Email Us</p>
                                            <p class="text-gray-500 mt-1 font-medium text-sm">support@powergrid.in</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form class="bg-jungle-green p-10 rounded-[2.5rem] shadow-2xl reveal-on-scroll">
                            <div class="grid grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label
                                        class="block text-sm font-bold text-lime-accent mb-2 uppercase tracking-wider">First
                                        Name</label>
                                    <input type="text"
                                        class="w-full px-4 py-4 rounded-xl bg-white/10 border border-white/10 text-white focus:border-lime-accent focus:ring-0 outline-none transition font-medium placeholder-white/30"
                                        placeholder="John">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-bold text-lime-accent mb-2 uppercase tracking-wider">Last
                                        Name</label>
                                    <input type="text"
                                        class="w-full px-4 py-4 rounded-xl bg-white/10 border border-white/10 text-white focus:border-lime-accent focus:ring-0 outline-none transition font-medium placeholder-white/30"
                                        placeholder="Doe">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label
                                    class="block text-sm font-bold text-lime-accent mb-2 uppercase tracking-wider">Work
                                    Email</label>
                                <input type="email"
                                    class="w-full px-4 py-4 rounded-xl bg-white/10 border border-white/10 text-white focus:border-lime-accent focus:ring-0 outline-none transition font-medium placeholder-white/30"
                                    placeholder="john@company.com">
                            </div>
                            <div class="mb-6">
                                <label
                                    class="block text-sm font-bold text-lime-accent mb-2 uppercase tracking-wider">Message</label>
                                <textarea rows="4"
                                    class="w-full px-4 py-4 rounded-xl bg-white/10 border border-white/10 text-white focus:border-lime-accent focus:ring-0 outline-none transition font-medium placeholder-white/30"
                                    placeholder="Tell us about your project needs..."></textarea>
                            </div>
                            <button type="submit"
                                class="w-full bg-pop-pink text-white font-black py-4 rounded-xl hover:bg-white hover:text-pop-pink transition-colors duration-300 text-lg shadow-lg">
                                SEND MESSAGE
                            </button>
                        </form>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-cream border-t border-gray-200 text-jungle-green">
            <div class="container mx-auto px-6 py-12">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-6 md:mb-0">
                        <h3 class="font-black text-2xl">POWERGRID</h3>
                        <p class="text-gray-500 mt-2 text-sm font-medium">AI-Powered Material Demand Forecasting</p>
                    </div>
                    <div class="text-gray-400 text-sm font-medium">
                        <p>&copy; 2025 POWERGRID Corporation of India Ltd.</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Login Page (Modified for Real Firebase Auth) -->
    <div id="login-page" class="hidden flex items-center justify-center min-h-screen bg-slate-900">
        <div
            class="w-full max-w-md p-8 space-y-6 bg-slate-800 rounded-2xl shadow-2xl text-center border border-slate-700 relative">
            <button id="close-login-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <div class="flex justify-center">
                <svg class="h-10 w-auto text-teal-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75" />
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-white">POWERGRID</h2>

            <!-- Auth Tabs (Fixed Visibility with Classes) -->
            <div class="flex justify-center gap-8 border-b border-slate-700 pb-1" id="auth-tabs">
                <button
                    class="auth-tab active pb-2 border-b-2 border-teal-400 text-teal-400 font-medium transition-colors"
                    data-tab="signin">Sign In</button>
                <button
                    class="auth-tab pb-2 border-b-2 border-transparent text-slate-400 hover:text-white font-medium transition-colors"
                    data-tab="signup">Create Account</button>
            </div>

            <!-- Sign In Form -->
            <form id="login-form" class="mt-6 space-y-6">
                <div>
                    <label for="login-email" class="sr-only">Email Address</label>
                    <input id="login-email" name="email" type="email" required
                        class="relative block w-full px-4 py-3 bg-slate-700 border border-slate-600 placeholder-slate-400 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-teal-400 focus:border-teal-400 sm:text-sm"
                        placeholder="Email Address">
                </div>
                <div>
                    <label for="login-password" class="sr-only">Password</label>
                    <input id="login-password" name="password" type="password" required
                        class="relative block w-full px-4 py-3 bg-slate-700 border border-slate-600 placeholder-slate-400 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-teal-400 focus:border-teal-400 sm:text-sm"
                        placeholder="Password">
                </div>
                <div class="flex justify-end">
                    <button type="button" id="forgot-password-link"
                        class="text-xs text-teal-400 hover:text-teal-300">Forgot Password?</button>
                </div>
                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-semibold rounded-md text-slate-900 bg-teal-400 hover:bg-teal-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-teal-500 transition-colors duration-300">
                    Sign In
                </button>
                <p class="text-sm text-slate-400 mt-4">
                    Don't have an account? <button type="button" id="switch-to-signup"
                        class="text-teal-400 hover:underline font-medium">Create one</button>
                </p>
            </form>

            <!-- Sign Up Form (Hidden by default) -->
            <form id="signup-form" class="mt-6 space-y-6 hidden">
                <div>
                    <label for="signup-email" class="sr-only">Email Address</label>
                    <input id="signup-email" name="email" type="email" required
                        class="relative block w-full px-4 py-3 bg-slate-700 border border-slate-600 placeholder-slate-400 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-teal-400 focus:border-teal-400 sm:text-sm"
                        placeholder="Email Address">
                </div>
                <div>
                    <label for="signup-password" class="sr-only">Password</label>
                    <input id="signup-password" name="password" type="password" required minlength="6"
                        class="relative block w-full px-4 py-3 bg-slate-700 border border-slate-600 placeholder-slate-400 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-teal-400 focus:border-teal-400 sm:text-sm"
                        placeholder="Create Password (min 6 chars)">
                </div>
                <div>
                    <label for="signup-confirm-password" class="sr-only">Confirm Password</label>
                    <input id="signup-confirm-password" name="confirm-password" type="password" required
                        class="relative block w-full px-4 py-3 bg-slate-700 border border-slate-600 placeholder-slate-400 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-teal-400 focus:border-teal-400 sm:text-sm"
                        placeholder="Confirm Password">
                </div>
                <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-semibold rounded-md text-slate-900 bg-teal-400 hover:bg-teal-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-teal-500 transition-colors duration-300">
                    Create Account
                </button>
                <p class="text-sm text-slate-400 mt-4">
                    Already have an account? <button type="button" id="switch-to-signin"
                        class="text-teal-400 hover:underline font-medium">Sign in</button>
                </p>
            </form>
        </div>
    </div>

    <!-- App Logic (Dashboard) Remains Unchanged -->
    <div id="app" class="hidden">
        <!-- App content preserved from your provided code -->
        <div class="flex h-screen bg-slate-100">
            <div id="sidebar" class="sidebar sidebar-open bg-slate-800 text-slate-300 flex flex-col">
                <div class="flex items-center justify-between p-4 h-16 border-b border-slate-700">
                    <div class="flex items-center">
                        <svg class="h-8 w-auto text-teal-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75" />
                        </svg>
                        <span class="ml-3 font-semibold text-xl text-white">POWERGRID</span>
                    </div>
                </div>
                <!-- Sidebar content -->
                <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
                    <a href="#" class="nav-link active flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="dashboard">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                        <span class="ml-3">Dashboard</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="forecast">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                        <span class="ml-3">Demand Forecast</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="inventory">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <span class="ml-3">Inventory</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="projects">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                        <span class="ml-3">Projects</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="analytics">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        <span class="ml-3">Analytics</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="procurement">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                        <span class="ml-3">Procurement</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="reports">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="ml-3">Reports</span>
                    </a>
                    <a href="#" class="nav-link flex items-center p-3 text-base font-medium rounded-lg"
                        data-page="settings">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="ml-3">Settings</span>
                    </a>
                    <div class="border-t border-slate-700 my-2"></div>
                    <button id="logout-button"
                        class="w-full text-left flex items-center p-3 text-base font-medium rounded-lg hover:bg-slate-700 text-red-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                        <span class="ml-3">Logout</span>
                    </button>
                </nav>
            </div>
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="flex justify-between items-center px-6 h-16 bg-white border-b border-slate-200">
                    <div class="flex items-center gap-4">
                        <button id="sidebar-toggle"
                            class="p-2 rounded-lg hover:bg-slate-100 transition-colors sidebar-toggle">
                            <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <h1 id="page-title" class="text-xl font-semibold text-slate-800">Dashboard Overview</h1>
                    </div>
                    <div class="flex items-center space-x-6">
                        <div class="text-sm text-slate-500 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span id="last-updated">Loading...</span>
                        </div>
                    </div>
                </header>
                <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto bg-slate-100 p-8"></main>
            </div>
        </div>
    </div>

    <div id="loading-overlay"
        class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Generic Modal -->
    <div id="modal-overlay"
        class="fixed inset-0 bg-slate-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div id="modal-content"
            class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4 p-6">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- FIREBASE CONFIGURATION ---
        // TODO: 1. Go to Firebase Console > Project Settings.
        // TODO: 2. Scroll down to "Your apps" and copy the "firebaseConfig" object.
        // TODO: 3. Paste it below to replace the placeholders.

        const firebaseConfig = {
            apiKey: "AIzaSyBlBoR3z2vc-cnox7n3gsZYfiUY3jnUM2g",
            authDomain: "powergrid-f6fb7.firebaseapp.com",
            projectId: "powergrid-f6fb7",
            storageBucket: "powergrid-f6fb7.firebasestorage.app",
            messagingSenderId: "276511323418",
            appId: "1:276511323418:web:852ea3fbb40e7bbd9228a3",
            measurementId: "G-F48PGP6Q8P"
        };

        // (Internal logic: Uses environment config if running in preview, otherwise uses your config above)
        if (typeof __firebase_config !== 'undefined') {
            try { Object.assign(firebaseConfig, JSON.parse(__firebase_config)); } catch (e) { }
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ========================================
        // INTEGRATED SUPPLY CHAIN DATA MODEL
        // ========================================

        // Ensure home page is visible by default (before auth state loads)
        window.addEventListener('DOMContentLoaded', () => {
            const homePageEl = document.getElementById('home-page');
            const appEl = document.getElementById('app');
            const loginPageEl = document.getElementById('login-page');

            if (homePageEl) homePageEl.classList.remove('hidden');
            if (appEl) appEl.classList.add('hidden');
            if (loginPageEl) {
                loginPageEl.classList.add('hidden');
                loginPageEl.classList.remove('flex');
            }
        });

        // Material Master Data - Core reference for all materials
        let materialMasterData = [
            { id: 'MAT001', name: 'Steel Towers (Type A - 765kV)', category: 'Towers', unit: 'Units', costPerUnit: 850000, leadTimeDays: 45, reorderLevel: 50, safetyStock: 30, supplier: 'SUP001' },
            { id: 'MAT002', name: 'Steel Towers (Type B - 400kV)', category: 'Towers', unit: 'Units', costPerUnit: 520000, leadTimeDays: 40, reorderLevel: 40, safetyStock: 25, supplier: 'SUP001' },
            { id: 'MAT003', name: 'Steel Towers (Type C - 220kV)', category: 'Towers', unit: 'Units', costPerUnit: 320000, leadTimeDays: 35, reorderLevel: 35, safetyStock: 20, supplier: 'SUP001' },
            { id: 'MAT004', name: 'Conductors - ACSR 400mm', category: 'Conductors', unit: 'Meters', costPerUnit: 450, leadTimeDays: 30, reorderLevel: 5000, safetyStock: 3000, supplier: 'SUP002' },
            { id: 'MAT005', name: 'Conductors - ACSR 300mm', category: 'Conductors', unit: 'Meters', costPerUnit: 350, leadTimeDays: 30, reorderLevel: 4000, safetyStock: 2500, supplier: 'SUP002' },
            { id: 'MAT006', name: 'Insulators - Disc Type', category: 'Insulators', unit: 'Units', costPerUnit: 1200, leadTimeDays: 25, reorderLevel: 1000, safetyStock: 600, supplier: 'SUP003' },
            { id: 'MAT007', name: 'Insulators - Polymer Type', category: 'Insulators', unit: 'Units', costPerUnit: 1500, leadTimeDays: 28, reorderLevel: 800, safetyStock: 500, supplier: 'SUP003' },
            { id: 'MAT008', name: 'Circuit Breakers 765kV', category: 'Equipment', unit: 'Units', costPerUnit: 1250000, leadTimeDays: 90, reorderLevel: 5, safetyStock: 3, supplier: 'SUP004' },
            { id: 'MAT009', name: 'Circuit Breakers 400kV', category: 'Equipment', unit: 'Units', costPerUnit: 750000, leadTimeDays: 75, reorderLevel: 8, safetyStock: 5, supplier: 'SUP004' },
            { id: 'MAT010', name: 'Transformers 765/400kV', category: 'Equipment', unit: 'Units', costPerUnit: 8500000, leadTimeDays: 120, reorderLevel: 3, safetyStock: 2, supplier: 'SUP005' },
            { id: 'MAT011', name: 'Transformers 400/220kV', category: 'Equipment', unit: 'Units', costPerUnit: 5200000, leadTimeDays: 100, reorderLevel: 4, safetyStock: 2, supplier: 'SUP005' },
            { id: 'MAT012', name: 'Foundation Bolts M36', category: 'Hardware', unit: 'Units', costPerUnit: 850, leadTimeDays: 15, reorderLevel: 5000, safetyStock: 3000, supplier: 'SUP006' },
            { id: 'MAT013', name: 'Earth Wire ACSR', category: 'Conductors', unit: 'Meters', costPerUnit: 180, leadTimeDays: 25, reorderLevel: 3000, safetyStock: 2000, supplier: 'SUP002' },
            { id: 'MAT014', name: 'Spacers & Dampers', category: 'Hardware', unit: 'Sets', costPerUnit: 2500, leadTimeDays: 20, reorderLevel: 500, safetyStock: 300, supplier: 'SUP006' }
        ];

        // Supplier Master Data
        let suppliersData = [
            { id: 'SUP001', name: 'Tata Steel', category: 'Towers', rating: 4.8, onTimeDelivery: 95, qualityScore: 98, avgLeadTime: 40, contactEmail: 'orders@tatasteel.com', contactPhone: '+91-22-6665-8282' },
            { id: 'SUP002', name: 'Sterlite Power', category: 'Conductors', rating: 4.7, onTimeDelivery: 92, qualityScore: 96, avgLeadTime: 28, contactEmail: 'sales@sterlitepower.com', contactPhone: '+91-20-3082-4500' },
            { id: 'SUP003', name: 'NGK Insulators', category: 'Insulators', rating: 4.9, onTimeDelivery: 97, qualityScore: 99, avgLeadTime: 26, contactEmail: 'india@ngk.com', contactPhone: '+91-44-4299-6200' },
            { id: 'SUP004', name: 'Siemens India', category: 'Equipment', rating: 4.8, onTimeDelivery: 94, qualityScore: 98, avgLeadTime: 80, contactEmail: 'energy@siemens.com', contactPhone: '+91-22-3967-7000' },
            { id: 'SUP005', name: 'ABB India', category: 'Equipment', rating: 4.9, onTimeDelivery: 96, qualityScore: 99, avgLeadTime: 110, contactEmail: 'transformers@abb.com', contactPhone: '+91-80-2294-9150' },
            { id: 'SUP006', name: 'L&T Construction', category: 'Hardware', rating: 4.6, onTimeDelivery: 90, qualityScore: 95, avgLeadTime: 18, contactEmail: 'procurement@lntecc.com', contactPhone: '+91-44-2254-6122' }
        ];

        // Current Inventory Levels (synced with forecasts)
        let inventoryData = [
            { materialId: 'MAT001', currentStock: 45, reserved: 20, available: 25, inTransit: 30, lastUpdated: '2025-11-27' },
            { materialId: 'MAT002', currentStock: 52, reserved: 15, available: 37, inTransit: 0, lastUpdated: '2025-11-27' },
            { materialId: 'MAT003', currentStock: 38, reserved: 10, available: 28, inTransit: 20, lastUpdated: '2025-11-26' },
            { materialId: 'MAT004', currentStock: 12000, reserved: 5000, available: 7000, inTransit: 8000, lastUpdated: '2025-11-27' },
            { materialId: 'MAT005', currentStock: 8500, reserved: 3000, available: 5500, inTransit: 0, lastUpdated: '2025-11-26' },
            { materialId: 'MAT006', currentStock: 850, reserved: 400, available: 450, inTransit: 500, lastUpdated: '2025-11-27' },
            { materialId: 'MAT007', currentStock: 920, reserved: 300, available: 620, inTransit: 0, lastUpdated: '2025-11-25' },
            { materialId: 'MAT008', currentStock: 4, reserved: 2, available: 2, inTransit: 3, lastUpdated: '2025-11-27' },
            { materialId: 'MAT009', currentStock: 11, reserved: 3, available: 8, inTransit: 0, lastUpdated: '2025-11-26' },
            { materialId: 'MAT010', currentStock: 2, reserved: 1, available: 1, inTransit: 2, lastUpdated: '2025-11-27' },
            { materialId: 'MAT011', currentStock: 5, reserved: 2, available: 3, inTransit: 0, lastUpdated: '2025-11-25' },
            { materialId: 'MAT012', currentStock: 6200, reserved: 2000, available: 4200, inTransit: 0, lastUpdated: '2025-11-26' },
            { materialId: 'MAT013', currentStock: 4500, reserved: 1500, available: 3000, inTransit: 2000, lastUpdated: '2025-11-27' },
            { materialId: 'MAT014', currentStock: 580, reserved: 150, available: 430, inTransit: 0, lastUpdated: '2025-11-24' }
        ];

        // Projects Data (enhanced with material requirements)
        /* let projectsData = [
            { 
                id: 'PRJ001', name: '765kV Transmission Line - Mumbai-Pune', region: 'West', location: 'Maharashtra', 
                budget: 125000000, status: 'In Progress', completion: 65, priority: 'High',
                projectType: 'Both', towerType: 'Type A - 765kV', substationType: '765kV GIS', lineLength: 280, 
                startDate: '2024-03-15', endDate: '2026-06-30',
                materialRequirements: [
                    { materialId: 'MAT001', quantity: 150, allocated: 98, pending: 52 },
                    { materialId: 'MAT004', quantity: 84000, allocated: 55000, pending: 29000 },
                    { materialId: 'MAT006', quantity: 3600, allocated: 2400, pending: 1200 },
                    { materialId: 'MAT008', quantity: 12, allocated: 8, pending: 4 },
                    { materialId: 'MAT010', quantity: 6, allocated: 4, pending: 2 }
                ],
                towerLocations: [{lat: 19.0760, lng: 72.8777}, {lat: 18.5204, lng: 73.8567}], 
                substationLocations: [{lat: 19.0760, lng: 72.8777}, {lat: 18.5204, lng: 73.8567}]
            },
            { 
                id: 'PRJ002', name: '400kV Substation - Delhi NCR', region: 'North', location: 'Delhi NCR', 
                budget: 89000000, status: 'In Progress', completion: 42, priority: 'Medium',
                projectType: 'Both', towerType: 'Type B - 400kV', substationType: '400kV AIS', lineLength: 120, 
                startDate: '2024-06-01', endDate: '2025-12-31',
                materialRequirements: [
                    { materialId: 'MAT002', quantity: 85, allocated: 40, pending: 45 },
                    { materialId: 'MAT005', quantity: 36000, allocated: 15000, pending: 21000 },
                    { materialId: 'MAT007', quantity: 2040, allocated: 850, pending: 1190 },
                    { materialId: 'MAT009', quantity: 8, allocated: 5, pending: 3 },
                    { materialId: 'MAT011', quantity: 4, allocated: 2, pending: 2 }
                ],
                towerLocations: [{lat: 28.7041, lng: 77.1025}], 
                substationLocations: [{lat: 28.7041, lng: 77.1025}]
            },
            { 
                id: 'PRJ003', name: '220kV Grid Extension - Bangalore', region: 'South', location: 'Karnataka', 
                budget: 67000000, status: 'Planning', completion: 15, priority: 'Low',
                projectType: 'Both', towerType: 'Type C - 220kV', substationType: '220kV Hybrid', lineLength: 185, 
                startDate: '2025-01-10', endDate: '2026-08-20',
                materialRequirements: [
                    { materialId: 'MAT003', quantity: 95, allocated: 15, pending: 80 },
                    { materialId: 'MAT005', quantity: 55500, allocated: 8000, pending: 47500 },
                    { materialId: 'MAT006', quantity: 2280, allocated: 350, pending: 1930 },
                    { materialId: 'MAT009', quantity: 6, allocated: 1, pending: 5 },
                    { materialId: 'MAT011', quantity: 3, allocated: 0, pending: 3 }
                ],
                towerLocations: [{lat: 12.9716, lng: 77.5946}], 
                substationLocations: [{lat: 12.9716, lng: 77.5946}]
            },
            { 
                id: 'PRJ004', name: '765kV HVDC Link - Chennai-Hyderabad', region: 'South', location: 'Tamil Nadu', 
                budget: 153000000, status: 'In Progress', completion: 78, priority: 'Critical',
                projectType: 'Both', towerType: 'Type A - 765kV', substationType: '765kV GIS', lineLength: 625, 
                startDate: '2023-09-01', endDate: '2025-11-30',
                materialRequirements: [
                    { materialId: 'MAT001', quantity: 220, allocated: 195, pending: 25 },
                    { materialId: 'MAT004', quantity: 187500, allocated: 165000, pending: 22500 },
                    { materialId: 'MAT006', quantity: 5280, allocated: 4620, pending: 660 },
                    { materialId: 'MAT008', quantity: 18, allocated: 16, pending: 2 },
                    { materialId: 'MAT010', quantity: 9, allocated: 8, pending: 1 }
                ],
                towerLocations: [{lat: 13.0827, lng: 80.2707}, {lat: 17.3850, lng: 78.4867}], 
                substationLocations: [{lat: 13.0827, lng: 80.2707}, {lat: 17.3850, lng: 78.4867}]
            }
        ]; */
        let projectsData = [];

        async function loadProjectsFromBackend(userID = 1) {
            const res = await fetch(`http://127.0.0.1:8000/projects/user/${userID}`);
            projectsData = await res.json();
            console.log(" Projects Loaded from Backend:", projectsData);
        }


        // Demand Forecasts (AI-generated, linked to projects)
        let forecastsData = [
            { id: 'FC001', projectId: 'PRJ001', materialId: 'MAT001', month: '2025-06', forecastedQty: 25, actualQty: 24, confidence: 94, accuracy: 96 },
            { id: 'FC002', projectId: 'PRJ001', materialId: 'MAT004', month: '2025-07', forecastedQty: 15000, actualQty: 14800, confidence: 92, accuracy: 98.7 },
            { id: 'FC003', projectId: 'PRJ002', materialId: 'MAT002', month: '2025-08', forecastedQty: 18, actualQty: 17, confidence: 89, accuracy: 94.4 },
            { id: 'FC004', projectId: 'PRJ004', materialId: 'MAT001', month: '2025-09', forecastedQty: 12, actualQty: 13, confidence: 96, accuracy: 91.7 },
            { id: 'FC005', projectId: 'PRJ001', materialId: 'MAT001', month: '2025-10', forecastedQty: 27, actualQty: 26, confidence: 93, accuracy: 96.3 },
            { id: 'FC006', projectId: 'PRJ003', materialId: 'MAT003', month: '2025-11', forecastedQty: 35, actualQty: 34, confidence: 88, accuracy: 97.1 },
            { id: 'FC007', projectId: 'PRJ001', materialId: 'MAT001', month: '2025-12', forecastedQty: 28, actualQty: null, confidence: 94 },
            { id: 'FC008', projectId: 'PRJ002', materialId: 'MAT004', month: '2026-01', forecastedQty: 16000, actualQty: null, confidence: 91 }
        ];

        // Procurement Orders (linked to inventory and forecasts)
        let procurementData = [
            { id: 'PO001', materialId: 'MAT001', supplierId: 'SUP001', quantity: 50, unitCost: 850000, totalCost: 42500000, orderDate: '2025-11-15', expectedDate: '2025-12-30', actualDate: null, status: 'Pending', projectId: 'PRJ001', triggerReason: 'Low Stock Alert' },
            { id: 'PO002', materialId: 'MAT004', supplierId: 'SUP002', quantity: 20000, unitCost: 450, totalCost: 9000000, orderDate: '2025-11-18', expectedDate: '2025-12-18', actualDate: null, status: 'In Transit', projectId: 'PRJ001', triggerReason: 'Forecast Demand' },
            { id: 'PO003', materialId: 'MAT010', supplierId: 'SUP005', quantity: 3, unitCost: 8500000, totalCost: 25500000, orderDate: '2025-11-10', expectedDate: '2026-03-10', actualDate: null, status: 'In Transit', projectId: 'PRJ001', triggerReason: 'Project Requirement' },
            { id: 'PO004', materialId: 'MAT006', supplierId: 'SUP003', quantity: 1500, unitCost: 1200, totalCost: 1800000, orderDate: '2025-11-20', expectedDate: '2025-12-15', actualDate: null, status: 'Pending', projectId: 'PRJ002', triggerReason: 'Safety Stock' },
            { id: 'PO005', materialId: 'MAT002', supplierId: 'SUP001', quantity: 40, unitCost: 520000, totalCost: 20800000, orderDate: '2025-11-22', expectedDate: '2026-01-06', actualDate: null, status: 'Approved', projectId: 'PRJ002', triggerReason: 'Forecast Demand' }
        ];

        // ========================================
        // INTEGRATED API WITH DATA SYNC
        // ========================================

        const api = {
            // Sync function: Recalculates all derived metrics
            syncAllData: function () {
                // Sync inventory with forecasts
                this.updateInventoryAlerts();
                // Sync procurement recommendations
                this.updateProcurementRecommendations();
                // Calculate forecast accuracy
                this.calculateForecastAccuracy();
            },

            updateInventoryAlerts: function () {
                inventoryData.forEach(inv => {
                    const material = materialMasterData.find(m => m.id === inv.materialId);
                    if (!material) return;

                    const totalAvailable = inv.currentStock + inv.inTransit;
                    const futureNeed = forecastsData
                        .filter(f => f.materialId === inv.materialId)
                        .reduce((sum, f) => sum + f.forecastedQty, 0);

                    // Check if projected stock will fall below safety level
                    inv.projectedShortfall = Math.max(0, (material.safetyStock + futureNeed) - totalAvailable);
                    inv.alertLevel = inv.projectedShortfall > 0 ? 'critical' :
                        (inv.available < material.reorderLevel ? 'warning' : 'good');
                });
            },

            updateProcurementRecommendations: function () {
                // Auto-generate recommended POs based on inventory + forecasts
                window.recommendedPOs = [];

                inventoryData.forEach(inv => {
                    const material = materialMasterData.find(m => m.id === inv.materialId);
                    if (!material) return;

                    const totalAvailable = inv.currentStock + inv.inTransit;
                    const futureNeed = forecastsData
                        .filter(f => f.materialId === inv.materialId)
                        .reduce((sum, f) => sum + f.forecastedQty, 0);

                    const requiredQty = (material.safetyStock + futureNeed + inv.reserved) - totalAvailable;

                    if (requiredQty > 0) {
                        const supplier = suppliersData.find(s => s.id === material.supplier);
                        const urgencyLevel = inv.alertLevel === 'critical' ? 'Critical' : inv.alertLevel === 'warning' ? 'High' : 'Medium';
                        window.recommendedPOs.push({
                            materialId: inv.materialId,
                            materialName: material.name,
                            recommendedQty: Math.ceil(requiredQty * 1.1), // 10% buffer
                            estimatedCost: Math.ceil(requiredQty * 1.1) * material.costPerUnit,
                            supplierName: supplier?.name || 'TBD',
                            supplierId: material.supplier,
                            urgency: urgencyLevel,
                            leadTime: material.leadTimeDays,
                            reason: inv.projectedShortfall > 0 ? `Projected shortfall of ${inv.projectedShortfall} units based on forecasted demand` : 'Stock below reorder level',
                            confidence: 85 + Math.random() * 10 // AI confidence score
                        });
                    }
                });
            },

            calculateForecastAccuracy: function () {
                const completedForecasts = forecastsData.filter(f => f.actualQty !== null);
                if (completedForecasts.length === 0) return 94.5; // Default

                let totalAccuracy = 0;
                completedForecasts.forEach(f => {
                    const accuracy = 100 - Math.abs((f.forecastedQty - f.actualQty) / f.forecastedQty * 100);
                    totalAccuracy += Math.max(0, accuracy);
                });

                return (totalAccuracy / completedForecasts.length).toFixed(1);
            },

            getDashboardStats: async () => {
                // Calculate real-time metrics
                const atRiskMaterials = inventoryData.filter(inv => inv.alertLevel === 'critical' || inv.alertLevel === 'warning').length;
                const criticalProjects = projectsData.filter(p => {
                    const fulfillment = api.calculateProjectFulfillment(p.id);
                    return fulfillment < 70;
                }).length;

                const monthlySpend = procurementData
                    .filter(po => {
                        const orderDate = new Date(po.orderDate);
                        const now = new Date();
                        return orderDate.getMonth() === now.getMonth() && orderDate.getFullYear() === now.getFullYear();
                    })
                    .reduce((sum, po) => sum + po.totalCost, 0);

                const pendingOrders = procurementData.filter(po => po.status === 'Pending' || po.status === 'Approved').length;

                return {
                    totalProjects: projectsData.length,
                    activeProjects: projectsData.filter(p => p.status === 'In Progress').length,
                    criticalProjects: criticalProjects,
                    totalMaterials: materialMasterData.length,
                    lowStockItems: atRiskMaterials,
                    pendingOrders: pendingOrders,
                    recommendedPOs: (window.recommendedPOs || []).length,
                    monthlySpend: monthlySpend,
                    forecastAccuracy: api.calculateForecastAccuracy(),
                    systemStatus: 'Online',
                    totalBudget: projectsData.reduce((sum, p) => sum + p.budget, 0),
                    totalSpend: procurementData.reduce((sum, po) => sum + po.totalCost, 0),
                    lastUpdated: new Date().toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' })
                };
            },

            calculateProjectFulfillment: (projectId) => {
                const project = projectsData.find(p => p.id === projectId);
                if (!project || !project.materialRequirements) return 100;

                let totalRequired = 0;
                let totalAllocated = 0;

                project.materialRequirements.forEach(req => {
                    totalRequired += req.quantity;
                    totalAllocated += req.allocated;
                });

                return totalRequired > 0 ? (totalAllocated / totalRequired * 100).toFixed(1) : 100;
            },
            createProject: async (projectData) => {
                await new Promise(resolve => setTimeout(resolve, 800));
                const newProject = {
                    id: 'PRJ' + String(projectsData.length + 1).padStart(3, '0'),
                    ...projectData,
                    status: 'Planning',
                    completion: 0,
                    priority: 'Medium',
                    materialRequirements: projectData.materialRequirements || [],
                    towerLocations: projectData.towerLocations || [],
                    substationLocations: projectData.substationLocations || []
                };
                projectsData.push(newProject);

                // Trigger: Update forecasts for new project
                api.generateForecastsForProject(newProject);
                api.syncAllData();

                return newProject;
            },

            updateProject: async (projectId, updates) => {
                const index = projectsData.findIndex(p => p.id === projectId);
                if (index === -1) return null;

                projectsData[index] = { ...projectsData[index], ...updates };

                // Trigger: Recalculate forecasts if material requirements changed
                if (updates.materialRequirements) {
                    api.generateForecastsForProject(projectsData[index]);
                }
                api.syncAllData();

                return projectsData[index];
            },

            getProjectsSummary: async () => {
                return projectsData.map(p => ({
                    ...p,
                    fulfillment: api.calculateProjectFulfillment(p.id)
                }));
            },

            getProjectById: async (id) => {
                const project = projectsData.find(p => p.id === id);
                if (!project) return null;

                return {
                    ...project,
                    fulfillment: api.calculateProjectFulfillment(id),
                    materialDetails: project.materialRequirements?.map(req => {
                        const material = materialMasterData.find(m => m.id === req.materialId);
                        const inventory = inventoryData.find(inv => inv.materialId === req.materialId);
                        return {
                            ...req,
                            materialName: material?.name,
                            available: inventory?.available || 0,
                            status: req.pending > (inventory?.available || 0) ? 'Shortage' : 'Available'
                        };
                    }) || []
                };
            },

            getMaterialsSummary: async () => {
                return materialMasterData.map(material => {
                    const inventory = inventoryData.find(inv => inv.materialId === material.id);
                    const supplier = suppliersData.find(s => s.id === material.supplier);

                    return {
                        id: material.id,
                        name: material.name,
                        category: material.category,
                        currentStock: inventory?.currentStock || 0,
                        available: inventory?.available || 0,
                        reserved: inventory?.reserved || 0,
                        inTransit: inventory?.inTransit || 0,
                        reorderLevel: material.reorderLevel,
                        safetyStock: material.safetyStock,
                        status: inventory?.alertLevel === 'critical' ? 'Critical' :
                            inventory?.alertLevel === 'warning' ? 'Low' : 'Good',
                        unit: material.unit,
                        costPerUnit: material.costPerUnit,
                        supplierName: supplier?.name || 'N/A',
                        leadTime: material.leadTimeDays,
                        projectedShortfall: inventory?.projectedShortfall || 0,
                        lastUpdated: inventory?.lastUpdated || new Date().toISOString().split('T')[0]
                    };
                });
            },

            getProcurementOrders: async () => {
                return procurementData.map(po => {
                    const material = materialMasterData.find(m => m.id === po.materialId);
                    const supplier = suppliersData.find(s => s.id === po.supplierId);
                    const project = projectsData.find(p => p.id === po.projectId);

                    return {
                        ...po,
                        materialName: material?.name || 'Unknown',
                        supplierName: supplier?.name || 'Unknown',
                        projectName: project?.name || 'General Stock',
                        daysUntilExpected: Math.ceil((new Date(po.expectedDate) - new Date()) / (1000 * 60 * 60 * 24))
                    };
                });
            },

            getRecommendedPOs: async () => {
                api.updateProcurementRecommendations();
                return window.recommendedPOs || [];
            },

            createProcurementOrder: async (poData) => {
                const newPO = {
                    id: 'PO' + String(procurementData.length + 1).padStart(3, '0'),
                    ...poData,
                    orderDate: new Date().toISOString().split('T')[0],
                    actualDate: null,
                    status: 'Pending'
                };
                procurementData.push(newPO);

                // Trigger: Update inventory in-transit
                const inventory = inventoryData.find(inv => inv.materialId === poData.materialId);
                if (inventory) {
                    inventory.inTransit += poData.quantity;
                }

                api.syncAllData();
                return newPO;
            },

            getSuppliers: async () => {
                return [...suppliersData];
            },

            getForecasts: async (filters = {}) => {
                let filtered = [...forecastsData];

                if (filters.projectId) {
                    filtered = filtered.filter(f => f.projectId === filters.projectId);
                }
                if (filters.materialId) {
                    filtered = filtered.filter(f => f.materialId === filters.materialId);
                }
                if (filters.month) {
                    filtered = filtered.filter(f => f.month === filters.month);
                }

                return filtered.map(f => {
                    const material = materialMasterData.find(m => m.id === f.materialId);
                    const project = projectsData.find(p => p.id === f.projectId);

                    return {
                        ...f,
                        materialName: material?.name || 'Unknown',
                        projectName: project?.name || 'Unknown',
                        variance: f.actualQty !== null ? f.actualQty - f.forecastedQty : null
                    };
                });
            },

            generateForecastsForProject: function (project) {
                // Auto-generate monthly forecasts based on project timeline
                if (!project.materialRequirements) return;

                const startDate = new Date(project.startDate);
                const endDate = new Date(project.endDate);
                const monthsDiff = (endDate.getFullYear() - startDate.getFullYear()) * 12 +
                    (endDate.getMonth() - startDate.getMonth());

                project.materialRequirements.forEach(req => {
                    const monthlyQty = Math.ceil(req.quantity / Math.max(monthsDiff, 1));

                    for (let i = 0; i < Math.min(monthsDiff, 6); i++) {
                        const forecastMonth = new Date(startDate);
                        forecastMonth.setMonth(forecastMonth.getMonth() + i);
                        const monthStr = forecastMonth.toISOString().slice(0, 7);

                        // Check if forecast already exists
                        const existingIndex = forecastsData.findIndex(f =>
                            f.projectId === project.id &&
                            f.materialId === req.materialId &&
                            f.month === monthStr
                        );

                        const newForecast = {
                            id: 'FC' + String(forecastsData.length + 1).padStart(3, '0'),
                            projectId: project.id,
                            materialId: req.materialId,
                            month: monthStr,
                            forecastedQty: monthlyQty,
                            actualQty: null,
                            confidence: 90 + Math.random() * 8
                        };

                        if (existingIndex >= 0) {
                            forecastsData[existingIndex] = newForecast;
                        } else {
                            forecastsData.push(newForecast);
                        }
                    }
                });
            },
            generateForecast: async (formData) => {
                // Simulate AI processing delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                const materials = [
                    { name: 'Washers', quantity: 5000, unit: 'Qty', costPerUnit: 2, totalCost: 10000 },

                    // High voltage equipment
                    { name: 'Current Transformers (CT)', quantity: 120, unit: 'Units', costPerUnit: 180000, totalCost: 21600000 },
                    { name: 'Control & Relay Panels', quantity: 40, unit: 'Units', costPerUnit: 250000, totalCost: 10000000 },
                    { name: 'PLCC System', quantity: 12, unit: 'Units', costPerUnit: 450000, totalCost: 5400000 },
                    { name: 'Battery Sets', quantity: 25, unit: 'Units', costPerUnit: 60000, totalCost: 1500000 },
                    { name: 'DG Sets', quantity: 15, unit: 'Units', costPerUnit: 550000, totalCost: 8250000 },
                    { name: 'Line Isolators', quantity: 80, unit: 'Units', costPerUnit: 150000, totalCost: 12000000 },
                    { name: 'Wave Traps', quantity: 18, unit: 'Units', costPerUnit: 95000, totalCost: 1710000 },
                    { name: 'Capacitive Voltage Transformers (CVT)', quantity: 50, unit: 'Units', costPerUnit: 350000, totalCost: 17500000 },
                    { name: 'AB Switches', quantity: 30, unit: 'Units', costPerUnit: 75000, totalCost: 2250000 },

                    // Civil + Tower Materials
                    { name: 'Tower Foundation Concrete', quantity: 1600, unit: 'Cubic Meter', costPerUnit: 5800, totalCost: 9280000 },
                    { name: 'Tower Erection Work', quantity: 120, unit: 'Units', costPerUnit: 50000, totalCost: 6000000 },

                    // Transmission Line Components
                    { name: 'Earthwire', quantity: 90, unit: 'KM', costPerUnit: 135000, totalCost: 12150000 },
                    { name: 'Insulator Discs', quantity: 26000, unit: 'Qty', costPerUnit: 95, totalCost: 2470000 },
                    { name: 'ACSR Conductors', quantity: 300, unit: 'KM', costPerUnit: 105000, totalCost: 31500000 },
                    { name: 'OPGW Cable', quantity: 80, unit: 'KM', costPerUnit: 145000, totalCost: 11600000 },
                    { name: 'Bolts & Nuts', quantity: 52000, unit: 'Kg', costPerUnit: 95, totalCost: 4940000 },

                    // Poles + Earth system
                    { name: 'RCC Poles', quantity: 350, unit: 'Units', costPerUnit: 9800, totalCost: 3430000 },
                    { name: 'AAC Conductors', quantity: 250, unit: 'KM', costPerUnit: 90000, totalCost: 22500000 },
                    { name: 'Earth Pits', quantity: 45, unit: 'Units', costPerUnit: 3200, totalCost: 144000 },

                    // Base construction material
                    { name: 'GI Earthing Rod', quantity: 12000, unit: 'Kg', costPerUnit: 90, totalCost: 1080000 },
                    { name: 'Cement (Grade 53)', quantity: 8000, unit: 'Bags', costPerUnit: 410, totalCost: 3280000 },
                    { name: 'Steel Rebars', quantity: 120, unit: 'Tonnes', costPerUnit: 68000, totalCost: 8160000 },
                    { name: 'River Sand', quantity: 2200, unit: 'Tons', costPerUnit: 1300, totalCost: 2860000 },

                    // Special equipment
                    { name: 'Smoothing Reactors', quantity: 8, unit: 'Units', costPerUnit: 1800000, totalCost: 14400000 },
                    { name: 'Shuttering Wood', quantity: 6000, unit: 'Sqm', costPerUnit: 70, totalCost: 420000 },
                    { name: 'Aggregates', quantity: 3000, unit: 'Tons', costPerUnit: 950, totalCost: 2850000 },
                    { name: 'Earthing Cable', quantity: 20000, unit: 'Meters', costPerUnit: 65, totalCost: 1300000 },

                    // Tower steel fabrication
                    { name: 'Angle Steel Sections', quantity: 25000, unit: 'Kg', costPerUnit: 70, totalCost: 1750000 },
                    { name: 'Tower Legs', quantity: 40000, unit: 'Kg', costPerUnit: 75, totalCost: 3000000 },
                    { name: 'Tower Body Members', quantity: 55000, unit: 'Kg', costPerUnit: 78, totalCost: 4290000 },
                    { name: 'Extension Pieces', quantity: 15000, unit: 'Kg', costPerUnit: 72, totalCost: 1080000 },
                    { name: 'Pack Plates', quantity: 10000, unit: 'Kg', costPerUnit: 70, totalCost: 700000 }
                ];


                const subtotal = materials.reduce((sum, m) => sum + m.totalCost, 0);
                const taxes = subtotal * 0.18; // 18% GST
                const total = subtotal + taxes;

                return {
                    materials,
                    costs: { subtotal, taxes, total },
                    chartData: {
                        labels: ['Jan 2025', 'Feb 2025', 'Mar 2025', 'Apr 2025', 'May 2025', 'Jun 2025', 'Jul 2025', 'Aug 2025', 'Sep 2025', 'Oct 2025', 'Nov 2025', 'Dec 2025'],
                        historicalData: [85, 92, 88, 95, 102, 98, null, null, null, null, null, null],
                        forecastedData: [null, null, null, null, null, 98, 105, 112, 118, 125, 132, 140]
                    },
                    confidence: 94.5,
                    recommendations: [
                        'Peak demand expected in December 2025 - consider early procurement',
                        'Steel tower demand will increase by 43% over the next 6 months',
                        'Recommend securing conductor supply contracts by July to avoid price surge',
                        'Transformer lead times are 4-6 months - order immediately for Q4 delivery',
                        'Budget allocation should prioritize critical path materials first'
                    ]
                };
            }
        };

        // --- Scroll Animation Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Scroll Reveal Observer
            const revealElements = document.querySelectorAll('.reveal-on-scroll');

            const revealObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    } else {
                        entry.target.classList.remove('is-visible');
                    }
                });
            }, { threshold: 0.15 });

            revealElements.forEach(el => revealObserver.observe(el));

            const heroSection = document.getElementById('hero-section');
            const mainHeader = document.getElementById('main-header');

            window.addEventListener('scroll', () => {
                if (!heroSection) return;

                const heroBottom = heroSection.getBoundingClientRect().bottom;

                // Show badge when hero scrolls out of view
                if (heroBottom < 0) {
                    mainHeader.classList.add('shadow-md', 'bg-white/95');
                } else {
                    mainHeader.classList.remove('shadow-md', 'bg-white/95');
                }
            });

            // --- Application Logic ---
            const appEl = document.getElementById('app');
            const loginPage = document.getElementById('login-page');
            const homePage = document.getElementById('home-page');

            // Auth Forms
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const authTabs = document.querySelectorAll('.auth-tab');

            // Buttons
            const homeSigninBtn = document.getElementById('home-signin-btn');
            const getStartedBtn = document.getElementById('get-started-btn');
            const learnMoreBtn = document.getElementById('learn-more-btn');
            const logoutButtons = document.querySelectorAll('#logout-button'); // Use class or all if ID duplicated
            const closeLoginBtn = document.getElementById('close-login-btn');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const switchToSignupBtn = document.getElementById('switch-to-signup');
            const switchToSigninBtn = document.getElementById('switch-to-signin');

            const mainContent = document.getElementById('main-content');
            const pageTitle = document.getElementById('page-title');
            const loadingOverlay = document.getElementById('loading-overlay');

            // --- Auth State Listener ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Check Verification Status First
                    if (!user.emailVerified) {
                        // If logged in but not verified (e.g. persisted session), force logout
                        signOut(auth);
                        return;
                    }

                    // User is signed in AND verified
                    homePage.classList.add('hidden');
                    loginPage.classList.add('hidden');
                    loginPage.classList.remove('flex');
                    appEl.classList.remove('hidden');

                    // Apply saved theme
                    const savedTheme = localStorage.getItem('dashboardTheme') || 'light';
                    applyTheme(savedTheme);

                    // Init Dashboard
                    if (pageTitle) pageTitle.textContent = "Dashboard Overview";
                    if (mainContent) renderDashboard();
                } else {
                    // User is signed out - ensure home page is shown and dashboard/login hidden
                    appEl.classList.add('hidden');
                    loginPage.classList.add('hidden');
                    loginPage.classList.remove('flex');
                    homePage.classList.remove('hidden');
                }
            });

            // --- Event Listeners ---

            // Tab Switching Helper
            function activateTab(tabName) {
                authTabs.forEach(t => {
                    if (t.dataset.tab === tabName) {
                        t.classList.add('active', 'text-teal-400', 'border-teal-400');
                        t.classList.remove('text-slate-400', 'border-transparent');
                    } else {
                        t.classList.remove('active', 'text-teal-400', 'border-teal-400');
                        t.classList.add('text-slate-400', 'border-transparent');
                    }
                });

                if (tabName === 'signin') {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                } else {
                    loginForm.classList.add('hidden');
                    signupForm.classList.remove('hidden');
                }
            }

            authTabs.forEach(tab => {
                tab.addEventListener('click', () => activateTab(tab.dataset.tab));
            });

            // Switch Links inside forms
            if (switchToSignupBtn) {
                switchToSignupBtn.addEventListener('click', () => activateTab('signup'));
            }
            if (switchToSigninBtn) {
                switchToSigninBtn.addEventListener('click', () => activateTab('signin'));
            }

            // Navigation Buttons
            const openLogin = () => {
                homePage.classList.add('hidden');
                loginPage.classList.remove('hidden');
                loginPage.classList.add('flex');
            };

            if (homeSigninBtn) homeSigninBtn.addEventListener('click', openLogin);
            if (getStartedBtn) getStartedBtn.addEventListener('click', openLogin);

            if (closeLoginBtn) {
                closeLoginBtn.addEventListener('click', () => {
                    loginPage.classList.add('hidden');
                    loginPage.classList.remove('flex');
                    homePage.classList.remove('hidden');
                });
            }

            if (learnMoreBtn) {
                learnMoreBtn.addEventListener('click', () => {
                    document.getElementById('challenges').scrollIntoView({ behavior: 'smooth' });
                });
            }

            // Login Handler
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const email = e.target['login-email'].value;
                    const password = e.target['login-password'].value;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.textContent;

                    submitBtn.disabled = true;
                    submitBtn.textContent = "Authenticating...";

                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        // Mandatory Email Verification Check
                        if (!user.emailVerified) {
                            await signOut(auth);
                            alert("Please verify your email address before logging in.");
                            return;
                        }
                        // onAuthStateChanged handles redirect
                    } catch (error) {
                        console.error("Login Error:", error);
                        let msg = "Login failed: " + error.message;
                        if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                            msg = "Invalid email or password.";
                        } else if (error.code === 'auth/too-many-requests') {
                            msg = "Too many failed attempts. Please try again later.";
                        }
                        alert(msg);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalBtnText;
                    }
                });
            }

            // Sign Up Handler (Updated: Added Verification)
            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const email = e.target['signup-email'].value;
                    const password = e.target['signup-password'].value;
                    const confirmPassword = e.target['signup-confirm-password'].value;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.textContent;

                    if (password !== confirmPassword) {
                        alert("Passwords do not match!");
                        return;
                    }

                    submitBtn.disabled = true;
                    submitBtn.textContent = "Creating Account...";

                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        // Mandatory Verification Step
                        await sendEmailVerification(user);

                        alert("Account created successfully! \n\nA verification email has been sent to " + email + ".\nPlease verify your email before logging in.");

                        // Force logout so they can't access dashboard without verifying (simulated mandatory)
                        await signOut(auth);

                        // Switch to login tab
                        activateTab('signin');

                    } catch (error) {
                        console.error("Signup Error:", error);
                        let msg = "Signup failed: " + error.message;
                        if (error.code === 'auth/email-already-in-use') {
                            msg = "This email is already registered.";
                        } else if (error.code === 'auth/weak-password') {
                            msg = "Password should be at least 6 characters.";
                        }
                        alert(msg);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalBtnText;
                    }
                });
            }

            // Forgot Password Handler
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', async () => {
                    const email = prompt("Please enter your email address to reset your password:");
                    if (email) {
                        try {
                            await sendPasswordResetEmail(auth, email);
                            // Important Note: Firebase does not send raw passwords. It sends a secure link to reset.
                            alert("A password reset link has been sent to your email.\n\nPlease check your inbox (and spam folder) to set a new password.");
                        } catch (error) {
                            console.error("Reset Error:", error);
                            alert("Failed to send reset email: " + error.message);
                        }
                    }
                });
            }

            // Logout Handler
            document.querySelectorAll('#logout-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        appEl.classList.add('hidden');
                        homePage.classList.remove('hidden');
                    } catch (error) {
                        console.error("Logout Error:", error);
                        alert("Failed to logout.");
                    }
                });
            });

            // --- Dashboard Page Rendering Functions ---

            // Global theme function
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else if (theme === 'light') {
                    document.body.classList.remove('dark-theme');
                } else if (theme === 'auto') {
                    // Check system preference
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.body.classList.add('dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                    }
                }
            }

            async function renderDashboard() {
                showLoading();
                const stats = await api.getDashboardStats();
                const projects = await api.getProjectsSummary();
                const materials = await api.getMaterialsSummary();

                // Update last updated display
                document.getElementById('last-updated').textContent = `Last updated: ${stats.lastUpdated}`;

                mainContent.innerHTML = `
                    <div class="fade-in">
                        <!-- Stats Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <div class="stat-card bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-teal-100 text-sm font-medium">Active Projects</p>
                                        <p class="text-4xl font-bold mt-2">${stats.activeProjects}</p>
                                        <p class="text-xs text-teal-100 mt-2">Out of ${stats.totalProjects} total</p>
                                    </div>
                                    <svg class="w-16 h-16 text-teal-200 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                </div>
                            </div>
                            
                            <div class="stat-card bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-slate-500 text-sm font-medium">Total Materials</p>
                                        <p class="text-4xl font-bold text-slate-800 mt-2">${stats.totalMaterials}</p>
                                        <p class="text-xs text-amber-600 mt-2 font-semibold">${stats.lowStockItems} Low Stock</p>
                                    </div>
                                    <svg class="w-16 h-16 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                                </div>
                            </div>
                            
                            <div class="stat-card bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-slate-500 text-sm font-medium">Pending Orders</p>
                                        <p class="text-4xl font-bold text-slate-800 mt-2">${stats.pendingOrders}</p>
                                        <p class="text-xs text-slate-500 mt-2">Procurement queue</p>
                                    </div>
                                    <svg class="w-16 h-16 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                </div>
                            </div>
                            
                            <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100 text-sm font-medium">Forecast Accuracy</p>
                                        <p class="text-4xl font-bold mt-2">${stats.forecastAccuracy}%</p>
                                        <p class="text-xs text-blue-100 mt-2">AI Model Performance</p>
                                    </div>
                                    <svg class="w-16 h-16 text-blue-200 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="mb-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Quick Actions</h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <button class="quick-action-btn bg-white p-4 rounded-xl border-2 border-slate-200 hover:border-teal-500 hover:shadow-lg transition-all text-left" data-page="forecast">
                                    <svg class="w-8 h-8 text-teal-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                    <p class="font-semibold text-slate-800">Generate Forecast</p>
                                    <p class="text-xs text-slate-500 mt-1">AI-powered predictions</p>
                                </button>
                                
                                <button class="quick-action-btn bg-white p-4 rounded-xl border-2 border-slate-200 hover:border-teal-500 hover:shadow-lg transition-all text-left" data-page="inventory">
                                    <svg class="w-8 h-8 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                                    <p class="font-semibold text-slate-800">View Inventory</p>
                                    <p class="text-xs text-slate-500 mt-1">Stock management</p>
                                </button>
                                
                                <button class="quick-action-btn bg-white p-4 rounded-xl border-2 border-slate-200 hover:border-teal-500 hover:shadow-lg transition-all text-left" data-page="procurement">
                                    <svg class="w-8 h-8 text-purple-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    <p class="font-semibold text-slate-800">New Order</p>
                                    <p class="text-xs text-slate-500 mt-1">Create procurement</p>
                                </button>
                                
                                <button class="quick-action-btn bg-white p-4 rounded-xl border-2 border-slate-200 hover:border-teal-500 hover:shadow-lg transition-all text-left" data-page="reports">
                                    <svg class="w-8 h-8 text-orange-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    <p class="font-semibold text-slate-800">View Reports</p>
                                    <p class="text-xs text-slate-500 mt-1">Analytics & exports</p>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Projects & Materials -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-slate-800">Active Projects</h3>
                                    <button class="text-teal-500 text-sm font-semibold hover:underline quick-action-btn" data-page="projects">View All</button>
                                </div>
                                <div class="space-y-3">
                                    ${projects.slice(0, 4).map(p => `
                                        <div class="p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors cursor-pointer">
                                            <div class="flex items-center justify-between mb-2">
                                                <p class="font-semibold text-slate-800 text-sm">${p.name}</p>
                                                <span class="badge badge-info text-xs">${p.status}</span>
                                            </div>
                                            <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
                                                <span>${p.location}</span>
                                                <span>${(p.budget / 10000000).toFixed(2)} Cr</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${p.completion}%"></div>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-1">${p.completion}% Complete</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-slate-800">Inventory Alerts</h3>
                                    <button class="text-teal-500 text-sm font-semibold hover:underline quick-action-btn" data-page="inventory">View All</button>
                                </div>
                                <div class="space-y-3">
                                    ${materials.filter(m => m.status !== 'Good').map(m => `
                                        <div class="material-card p-3 bg-slate-50 rounded-lg border-l-4 ${m.status === 'Critical' ? 'border-red-500' : 'border-amber-500'}">
                                            <div class="flex items-center justify-between mb-1">
                                                <p class="font-semibold text-slate-800 text-sm">${m.name}</p>
                                                <span class="badge ${m.status === 'Critical' ? 'badge-danger' : 'badge-warning'} text-xs">${m.status}</span>
                                            </div>
                                            <div class="flex items-center justify-between text-xs text-slate-500">
                                                <span>Stock: ${m.currentStock} ${m.unit}</span>
                                                <span>Reorder: ${m.reorderLevel}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${materials.filter(m => m.status === 'Good').slice(0, 2).map(m => `
                                        <div class="material-card p-3 bg-slate-50 rounded-lg border-l-4 border-green-500">
                                            <div class="flex items-center justify-between mb-1">
                                                <p class="font-semibold text-slate-800 text-sm">${m.name}</p>
                                                <span class="badge badge-success text-xs">${m.status}</span>
                                            </div>
                                            <div class="flex items-center justify-between text-xs text-slate-500">
                                                <span>Stock: ${m.currentStock} ${m.unit}</span>
                                                <span>Reorder: ${m.reorderLevel}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                hideLoading();
                attachQuickActionListeners();
            }

            async function renderForecastPage() {
                showLoading();
                pageTitle.textContent = "AI Demand Forecast";

                // Sync data and get latest info
                api.syncAllData();
                const projects = await api.getProjectsSummary();
                const forecasts = await api.getForecasts();
                const materials = await api.getMaterialsSummary();

                // Calculate forecast statistics
                const forecastStats = {
                    totalForecasts: forecasts.length,
                    activeForecasts: forecasts.filter(f => f.actualQty === null).length,
                    accuracy: api.calculateForecastAccuracy(),
                    projectedShortages: materials.filter(m => m.projectedShortfall > 0).length
                };

                hideLoading();

                mainContent.innerHTML = `
                    <div class="fade-in max-w-7xl">
                        <!-- Header with Stats -->
                        <div class="bg-gradient-to-r from-teal-500 to-blue-500 p-8 rounded-2xl shadow-lg text-white mb-6">
                            <h2 class="text-3xl font-bold mb-4">AI-Powered Material Demand Forecasting</h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-teal-100 text-sm font-medium">Active Forecasts</p>
                                    <p class="text-3xl font-bold mt-1">${forecastStats.activeForecasts}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-teal-100 text-sm font-medium">Forecast Accuracy</p>
                                    <p class="text-3xl font-bold mt-1">${forecastStats.accuracy}%</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-teal-100 text-sm font-medium">Projects Tracked</p>
                                    <p class="text-3xl font-bold mt-1">${projects.length}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-teal-100 text-sm font-medium">Projected Shortages</p>
                                    <p class="text-3xl font-bold mt-1">${forecastStats.projectedShortages}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabs: New Forecast vs Forecast History -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                            <div class="border-b border-slate-200">
                                <div class="flex">
                                    <button class="forecast-tab active" data-tab="new-forecast">
                                        New Forecast
                                    </button>
                                    <button class="forecast-tab" data-tab="forecast-history">
                                        Forecast History
                                    </button>
                                    <button class="forecast-tab" data-tab="material-forecast">
                                        Material Projections
                                    </button>
                                </div>
                            </div>
                            
                                        <button id="toggle-project-se
                            <!-- Tab Content Container -->
                            <div id="forecast-tab-content" class="p-8">
                                <!-- New Forecast Form (Default) -->
                                <div id="new-forecast-content" class="tab-content">

                                    <div id="forecast-form-container">
                                    <div class="flex items-center justify-between mb-6">
                                        <h3 class="text-xl font-bold text-slatlect" class="btn btn-outline text-sm"> Load Existing Project</button>
                                    </div>
                                    
                                    <!-- Project Selection Card -->
                                    <div id="project-selection-card" class="hidden mb-6 p-6 bg-gradient-to-r from-blue-50 to-teal-50 border-2 border-blue-200 rounded-xl">
                                        <div class="flex items-start gap-4">
                                            <div class="flex-shrink-0 bg-blue-500 text-white p-3 rounded-lg">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                </svg>
                                            </div>
                                            <div class="flex-1">
                                                <label class="block text-sm font-bold text-slate-800 mb-3">Select Project to Auto-Fill Forecast</label>
                                                <select id="project-selector" class="w-full mb-3">
                                                    <option value="">-- Choose a project --</option>
                                                    ${projects.map(p => `
                                                        <option value="${p.id}">
                                                            ${p.id} - ${p.name} (${p.completion}% complete, ${p.fulfillment}% materials ready)
                                                        </option>
                                                    `).join('')}
                                                </select>
                                                <p class="text-xs text-blue-700">
                                                    <strong> Synchronized:</strong> Selecting a project will load all parameters and link forecasts to inventory and procurement systems
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <form id="forecast-form" class="space-y-6">
                                        <input type="hidden" name="projectId" id="selected-project-id">
                                        
                                        <!-- Row 1: Project Name and Type -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Project Name *</label>
                                                <input type="text" name="projectName" required class="w-full" placeholder="e.g., 765kV Transmission Line">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Project Type *</label>
                                                <select name="projectType" id="forecast-project-type" required class="w-full">
                                                    <option value="">Select Project Type</option>
                                                    <option value="Tower">Tower Type</option>
                                                    <option value="Substation">Substation Type</option>
                                                    <option value="Both">Both (Tower & Substation)</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Row 2: Tower Type and/or Substation Type (conditional) -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div id="forecast-tower-type-field" class="hidden">
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Tower Type *</label>
                                                <select name="towerType" id="forecast-tower-type" class="w-full">
                                                    <option value="">Select Type</option>
                                                    <option value="Type A - 765kV">Type A - 765kV</option>
                                                    <option value="Type B - 400kV">Type B - 400kV</option>
                                                    <option value="Type C - 220kV">Type C - 220kV</option>
                                                    <option value="Type D - 132kV">Type D - 132kV</option>
                                                </select>
                                            </div>
                                            <div id="forecast-substation-type-field" class="hidden">
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Substation Type *</label>
                                                <select name="substationType" id="forecast-substation-type" class="w-full">
                                                    <option value="">Select Type</option>
                                                    <option value="765kV GIS">765kV GIS</option>
                                                    <option value="400kV AIS">400kV AIS</option>
                                                    <option value="220kV Hybrid">220kV Hybrid</option>
                                                    <option value="132kV Standard">132kV Standard</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Row 3: Budget (full width when tower/substation hidden) -->
                                        <div class="grid grid-cols-1 gap-6">
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Budget ( Crores) *</label>
                                                <input type="number" name="budget" required class="w-full" placeholder="e.g., 100" step="0.01">
                                                <p class="text-xs text-slate-500 mt-1">Enter budget in Crores</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Row 4: Region and Location -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Region *</label>
                                                <select name="region" id="forecast-region" required class="w-full">
                                                    <option value="">Select Region</option>
                                                    <option value="North">North India</option>
                                                    <option value="South">South India</option>
                                                    <option value="East">East India</option>
                                                    <option value="West">West India</option>
                                                    <option value="Central">Central India</option>
                                                    <option value="North East">North East India</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">State *</label>
                                                <select name="location" id="forecast-location" required class="w-full">
                                                    <option value="">Select Region First</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Row 5: Start Date and End Date -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Start Date *</label>
                                                <input type="date" name="startDate" required class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">End Date *</label>
                                                <input type="date" name="endDate" required class="w-full">
                                            </div>
                                        </div>
                                        
                                        <!-- Row 6: Line Length -->
                                        <div class="grid grid-cols-1 gap-6">
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Line Length (km)</label>
                                                <input type="number" name="lineLength" class="w-full" placeholder="Auto-calculated from map" step="0.01">
                                            </div>
                                        </div>
                                        
                                        <!-- Map Section -->
                                        <div class="space-y-4">
                                            <h4 class="text-lg font-bold text-slate-800">Location Planning</h4>
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                <div>
                                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Tower Locations (Click to add)</label>
                                                    <div class="map-container" id="tower-map">
                                                        <div class="map-placeholder">
                                                            <div class="text-center">
                                                                <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                                                </svg>
                                                                <p class="font-semibold">India Map - Towers</p>
                                                                <p class="text-xs mt-1 opacity-80">Click to mark positions</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="tower-coords" class="mt-2 text-xs text-slate-600"></div>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Substation Locations (Click to add)</label>
                                                    <div class="map-container" id="substation-map">
                                                        <div class="map-placeholder">
                                                            <div class="text-center">
                                                                <svg class="w-16 h-16 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                                                                </svg>
                                                                <p class="font-semibold">India Map - Substations</p>
                                                                <p class="text-xs mt-1 opacity-80">Click to mark positions</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="substation-coords" class="mt-2 text-xs text-slate-600"></div>
                                                </div>
                                            </div>
                                            <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                                                <div class="flex items-start gap-3">
                                                    <svg class="w-5 h-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                    <div class="flex-1">
                                                        <p class="text-sm font-semibold text-green-800">Calculated Distance</p>
                                                        <p id="calculated-distance" class="text-2xl font-bold text-green-700 mt-1">-- km</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="flex gap-4 pt-4">
                                            <button type="submit" class="btn btn-primary flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        Generate AI Forecast
    </button>
                                            <button type="reset" class="btn btn-secondary">Reset Form</button>
                                        </div>
                                    </form>

                                    </div>
                                    <div id="new-forecast-content" class="mt-6"></div>
                                </div>
                                
                                <!-- Forecast History Tab -->
                                <div id="forecast-history-content" class="tab-content hidden">
                                    <h3 class="text-xl font-bold text-slate-800 mb-6">Historical Forecasts & Accuracy Tracking</h3>
                                    
                                    ${forecasts.length > 0 ? `
                                        <div class="overflow-x-auto">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Month</th>
                                                        <th>Project</th>
                                                        <th>Material</th>
                                                        <th>Forecasted</th>
                                                        <th>Actual</th>
                                                        <th>Variance</th>
                                                        <th>Accuracy</th>
                                                        <th>Confidence</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${forecasts.map(f => {
                    const forecastedQty = f.forecastedQty || 0;
                    const actualQty = f.actualQty !== null ? f.actualQty : null;
                    const variance = actualQty !== null ? ((actualQty - forecastedQty) / forecastedQty * 100).toFixed(1) : null;
                    const accuracy = variance !== null ? (100 - Math.abs(parseFloat(variance))).toFixed(1) : null;
                    const confidence = f.confidence || 0;
                    return `
                                                            <tr>
                                                                <td class="font-mono">${f.month || 'N/A'}</td>
                                                                <td class="text-sm">${f.projectName || 'Unknown Project'}</td>
                                                                <td class="font-semibold">${f.materialName || 'Unknown Material'}</td>
                                                                <td class="text-blue-600 font-bold">${forecastedQty.toLocaleString()}</td>
                                                                <td class="${actualQty !== null ? 'text-green-600 font-bold' : 'text-slate-400'}">
                                                                    ${actualQty !== null ? actualQty.toLocaleString() : 'Pending'}
                                                                </td>
                                                                <td class="${variance !== null ? (Math.abs(variance) > 10 ? 'text-red-600' : 'text-green-600') : 'text-slate-400'} font-semibold">
                                                                    ${variance !== null ? (variance > 0 ? '+' : '') + variance + '%' : ''}
                                                                </td>
                                                                <td class="${accuracy !== null ? (accuracy >= 90 ? 'text-green-600' : accuracy >= 75 ? 'text-yellow-600' : 'text-red-600') : 'text-slate-400'} font-bold">
                                                                    ${accuracy !== null ? accuracy + '%' : ''}
                                                                </td>
                                                                <td>
                                                                    <div class="progress-bar" style="height: 4px;">
                                                                        <div class="progress-fill" style="width: ${confidence}%; background: linear-gradient(90deg, #14b8a6, #2dd4bf)"></div>
                                                                    </div>
                                                                    <span class="text-xs text-slate-600">${confidence.toFixed(0)}%</span>
                                                                </td>
                                                                <td>
                                                                    <span class="badge ${actualQty !== null ? 'badge-success' : 'badge-info'}">
                                                                        ${actualQty !== null ? 'Completed' : 'Active'}
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        `;
                }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : `
                                        <div class="text-center py-12 text-slate-500">
                                            <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                            <p class="text-lg font-semibold">No historical forecasts available</p>
                                            <p class="text-sm mt-2">Generate your first forecast to start tracking accuracy</p>
                                        </div>
                                    `}
                                </div>
                                
                                <!-- Material Projections Tab -->
                                <div id="material-forecast-content" class="tab-content hidden">
                                    <h3 class="text-xl font-bold text-slate-800 mb-6">Material-wise Demand Projections</h3>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        ${materials.filter(m => (m.projectedShortfall || 0) > 0 || (m.reserved || 0) > 0).map(m => {
                    const futureDemand = forecasts
                        .filter(f => f.materialId === m.id && f.actualQty === null)
                        .reduce((sum, f) => sum + (f.forecastedQty || 0), 0);
                    const reserved = m.reserved || 0;
                    const available = m.available || 0;
                    const inTransit = m.inTransit || 0;
                    const totalNeeded = reserved + futureDemand;
                    const totalAvailable = available + inTransit;
                    const shortfall = Math.max(0, totalNeeded - totalAvailable);

                    return `
                                                <div class="bg-white border-2 ${shortfall > 0 ? 'border-red-200' : 'border-green-200'} rounded-lg p-6">
                                                    <div class="flex justify-between items-start mb-4">
                                                        <div>
                                                            <h4 class="font-bold text-slate-800">${m.name || 'Unknown Material'}</h4>
                                                            <p class="text-xs text-slate-500 mt-1">${m.category || 'Uncategorized'}</p>
                                                        </div>
                                                        <span class="badge ${shortfall > 0 ? 'badge-danger' : 'badge-success'}">
                                                            ${shortfall > 0 ? 'Shortage Risk' : 'Adequate'}
                                                        </span>
                                                    </div>
                                                    
                                                    <div class="space-y-3 text-sm">
                                                        <div class="flex justify-between">
                                                            <span class="text-slate-600">Current Available:</span>
                                                            <span class="font-bold">${available} ${m.unit || 'units'}</span>
                                                        </div>
                                                        <div class="flex justify-between">
                                                            <span class="text-slate-600">Reserved for Projects:</span>
                                                            <span class="font-bold text-orange-600">${reserved} ${m.unit || 'units'}</span>
                                                        </div>
                                                        <div class="flex justify-between">
                                                            <span class="text-slate-600">In Transit:</span>
                                                            <span class="font-bold text-blue-600">${inTransit} ${m.unit || 'units'}</span>
                                                        </div>
                                                        <div class="flex justify-between">
                                                            <span class="text-slate-600">Forecasted Demand:</span>
                                                            <span class="font-bold text-purple-600">${futureDemand} ${m.unit || 'units'}</span>
                                                        </div>
                                                        <div class="border-t border-slate-200 pt-3 flex justify-between">
                                                            <span class="text-slate-800 font-semibold">Projected ${shortfall > 0 ? 'Shortfall' : 'Surplus'}:</span>
                                                            <span class="font-bold ${shortfall > 0 ? 'text-red-600' : 'text-green-600'}">
                                                                ${shortfall > 0 ? shortfall : totalAvailable - totalNeeded} ${m.unit || 'units'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    ${shortfall > 0 ? `
                                                        <div class="mt-4 pt-4 border-t border-red-200">
                                                            <p class="text-xs text-red-700 font-semibold mb-2"> Recommended Action:</p>
                                                            <button class="btn btn-primary text-xs w-full" onclick="navigateToPage('procurement')">
                                                                Create Purchase Order
                                                            </button>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                }).join('')}
                                    </div>
                                    
                                    ${materials.filter(m => (m.projectedShortfall || 0) > 0 || (m.reserved || 0) > 0).length === 0 ? `
                                        <div class="text-center py-12 text-slate-500">
                                            <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                            </svg>
                                            <p class="text-lg font-semibold">No material projections available</p>
                                            <p class="text-sm mt-2">Generate forecasts to see demand projections</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div id="forecast-results" class="hidden mt-6"></div>
                    </div>
                `;

                // Region-to-State mapping
                const regionStates = {
                    'North': ['Delhi NCR', 'Punjab', 'Haryana', 'Himachal Pradesh', 'Jammu & Kashmir', 'Uttarakhand', 'Uttar Pradesh', 'Rajasthan'],
                    'South': ['Karnataka', 'Tamil Nadu', 'Kerala', 'Andhra Pradesh', 'Telangana', 'Puducherry'],
                    'East': ['West Bengal', 'Bihar', 'Odisha', 'Jharkhand'],
                    'West': ['Maharashtra', 'Gujarat', 'Goa'],
                    'Central': ['Madhya Pradesh', 'Chhattisgarh'],
                    'North East': ['Assam', 'Arunachal Pradesh', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Tripura', 'Sikkim']
                };

                // Tab Switching for Forecast page
                document.querySelectorAll('.forecast-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        // Update active tab styling
                        document.querySelectorAll('.forecast-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        e.target.classList.add('active');

                        // Show corresponding content
                        document.querySelectorAll('#forecast-tab-content .tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });

                        const tabName = e.target.dataset.tab;
                        const targetContent = document.getElementById(`${tabName}-content`);
                        if (targetContent) {
                            targetContent.classList.remove('hidden');
                        }
                    });
                });

                // Project Type change handler for Forecast form
                const forecastProjectType = document.getElementById('forecast-project-type');
                const forecastTowerTypeField = document.getElementById('forecast-tower-type-field');
                const forecastSubstationTypeField = document.getElementById('forecast-substation-type-field');
                const forecastTowerTypeSelect = document.getElementById('forecast-tower-type');
                const forecastSubstationTypeSelect = document.getElementById('forecast-substation-type');

                forecastProjectType.addEventListener('change', (e) => {
                    const projectType = e.target.value;

                    // Hide all and remove required
                    forecastTowerTypeField.classList.add('hidden');
                    forecastSubstationTypeField.classList.add('hidden');
                    forecastTowerTypeSelect.removeAttribute('required');
                    forecastSubstationTypeSelect.removeAttribute('required');
                    forecastTowerTypeSelect.value = '';
                    forecastSubstationTypeSelect.value = '';

                    // Show relevant fields based on selection
                    if (projectType === 'Tower') {
                        forecastTowerTypeField.classList.remove('hidden');
                        forecastTowerTypeSelect.setAttribute('required', 'required');
                    } else if (projectType === 'Substation') {
                        forecastSubstationTypeField.classList.remove('hidden');
                        forecastSubstationTypeSelect.setAttribute('required', 'required');
                    } else if (projectType === 'Both') {
                        forecastTowerTypeField.classList.remove('hidden');
                        forecastSubstationTypeField.classList.remove('hidden');
                        forecastTowerTypeSelect.setAttribute('required', 'required');
                        forecastSubstationTypeSelect.setAttribute('required', 'required');
                    }
                });

                // Forecast form region-state filtering
                const forecastRegion = document.getElementById('forecast-region');
                const forecastLocation = document.getElementById('forecast-location');

                forecastRegion.addEventListener('change', (e) => {
                    const selectedRegion = e.target.value;
                    forecastLocation.innerHTML = '<option value="">Select State</option>';

                    if (selectedRegion && regionStates[selectedRegion]) {
                        regionStates[selectedRegion].forEach(state => {
                            const option = document.createElement('option');
                            option.value = state;
                            option.textContent = state;
                            forecastLocation.appendChild(option);
                        });
                    }
                });

                // // Project selection toggle
                // document.getElementById('toggle-project-select').addEventListener('click', () => {
                //     const card = document.getElementById('project-selection-card');
                //     card.classList.toggle('hidden');
                // });


                // Project auto-fill functionality
                let towerLocations = [];
                let substationLocations = [];

                document.getElementById('project-selector').addEventListener('change', async (e) => {
                    const projectId = e.target.value;
                    if (!projectId) {
                        document.getElementById('selected-project-id').value = '';
                        return;
                    }

                    showLoading();
                    const project = await api.getProjectById(projectId);
                    hideLoading();

                    if (project) {
                        const form = document.getElementById('forecast-form');

                        // Store project ID for linking forecast
                        document.getElementById('selected-project-id').value = projectId;

                        // Auto-fill all form fields
                        form.projectName.value = project.name;

                        // Auto-fill region and trigger state population
                        if (project.region) {
                            form.region.value = project.region;
                            form.region.dispatchEvent(new Event('change'));
                            setTimeout(() => {
                                form.location.value = project.location;
                            }, 100);
                        }

                        form.budget.value = (project.budget / 10000000).toFixed(2);
                        form.startDate.value = project.startDate;
                        form.endDate.value = project.endDate;

                        // Determine project type and set fields accordingly
                        let projectType = 'Both';
                        if (project.towerType && !project.substationType) {
                            projectType = 'Tower';
                        } else if (!project.towerType && project.substationType) {
                            projectType = 'Substation';
                        }

                        form.projectType.value = projectType;
                        form.projectType.dispatchEvent(new Event('change'));

                        setTimeout(() => {
                            if (project.towerType) {
                                form.towerType.value = project.towerType;
                            }
                            if (project.substationType) {
                                form.substationType.value = project.substationType;
                            }
                        }, 100);

                        if (project.lineLength) {
                            form.lineLength.value = project.lineLength;
                        }

                        // Load map locations if available
                        if (project.towerLocations && project.towerLocations.length > 0) {
                            towerLocations = [...project.towerLocations];
                        }
                        if (project.substationLocations && project.substationLocations.length > 0) {
                            substationLocations = [...project.substationLocations];
                        }

                        updateMapDisplay();
                        calculateDistance();

                        // Show success notification
                        const card = document.getElementById('project-selection-card');
                        const originalBg = card.className;
                        card.className = card.className.replace('from-blue-50 to-teal-50', 'from-green-50 to-emerald-50').replace('border-blue-200', 'border-green-400');
                        setTimeout(() => {
                            card.className = originalBg;
                        }, 2000);

                        // Show material requirements info if available
                        if (project.materialDetails && project.materialDetails.length > 0) {
                            const materialInfo = project.materialDetails.map(m =>
                                `${m.materialName}: ${m.quantity} needed, ${m.allocated} allocated, ${m.pending} pending`
                            ).join('\n');
                            console.log('Project Material Requirements:\n', materialInfo);
                        }
                    }
                });

                // Map interaction for tower locations
                // NOTE: Ready for Indian Map API integration - replace placeholder with actual map library (e.g., Leaflet, Google Maps)
                // When integrating API: Replace click coordinates with map.on('click') event and use e.latlng for real coordinates
                const towerMap = document.getElementById('tower-map');
                const substationMap = document.getElementById('substation-map');

                towerMap.addEventListener('click', (e) => {
                    // Skip if clicking on a marker for removal
                    if (e.target.classList.contains('location-marker')) return;

                    const rect = e.currentTarget.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;

                    // Simulated lat/lng (India bounds: lat 8-37, lng 68-97)
                    // TODO: Replace with actual map API coordinates when integrated
                    const lat = 37 - (y / 100) * 29;
                    const lng = 68 + (x / 100) * 29;

                    towerLocations.push({ lat: parseFloat(lat.toFixed(4)), lng: parseFloat(lng.toFixed(4)), x, y });
                    updateMapDisplay();
                    calculateDistance();
                });

                // Map interaction for substation locations
                substationMap.addEventListener('click', (e) => {
                    if (e.target.classList.contains('location-marker')) return;

                    const rect = e.currentTarget.getBoundingClientRect();
                    const x = ((e.clientX - rect.left) / rect.width) * 100;
                    const y = ((e.clientY - rect.top) / rect.height) * 100;

                    // Simulated lat/lng - replace when using real map API
                    const lat = 37 - (y / 100) * 29;
                    const lng = 68 + (x / 100) * 29;

                    substationLocations.push({ lat: parseFloat(lat.toFixed(4)), lng: parseFloat(lng.toFixed(4)), x, y });
                    updateMapDisplay();
                    calculateDistance();
                });

                function updateMapDisplay() {
                    // Update tower map
                    const towerMap = document.getElementById('tower-map');
                    const existingTowerMarkers = towerMap.querySelectorAll('.location-marker');
                    existingTowerMarkers.forEach(m => m.remove());

                    towerLocations.forEach((loc, idx) => {
                        const marker = document.createElement('div');
                        marker.className = 'location-marker';
                        marker.style.left = loc.x + '%';
                        marker.style.top = loc.y + '%';
                        marker.title = `Tower ${idx + 1}: ${loc.lat}, ${loc.lng} - Click to remove`;
                        marker.dataset.index = idx;
                        marker.dataset.type = 'tower';
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            towerLocations.splice(idx, 1);
                            updateMapDisplay();
                            calculateDistance();
                        });
                        towerMap.appendChild(marker);
                    });

                    document.getElementById('tower-coords').textContent =
                        towerLocations.length > 0 ? `${towerLocations.length} tower location(s) marked (click marker to remove)` : 'No locations marked yet';

                    // Update substation map
                    const substationMap = document.getElementById('substation-map');
                    const existingSubMarkers = substationMap.querySelectorAll('.location-marker');
                    existingSubMarkers.forEach(m => m.remove());

                    substationLocations.forEach((loc, idx) => {
                        const marker = document.createElement('div');
                        marker.className = 'location-marker';
                        marker.style.left = loc.x + '%';
                        marker.style.top = loc.y + '%';
                        marker.style.background = '#3b82f6';
                        marker.title = `Substation ${idx + 1}: ${loc.lat}, ${loc.lng} - Click to remove`;
                        marker.dataset.index = idx;
                        marker.dataset.type = 'substation';
                        marker.addEventListener('click', (e) => {
                            e.stopPropagation();
                            substationLocations.splice(idx, 1);
                            updateMapDisplay();
                            calculateDistance();
                        });
                        substationMap.appendChild(marker);
                    });

                    document.getElementById('substation-coords').textContent =
                        substationLocations.length > 0 ? `${substationLocations.length} substation location(s) marked (click marker to remove)` : 'No locations marked yet';
                }

                function calculateDistance() {
                    if (towerLocations.length < 2 && substationLocations.length < 2) {
                        document.getElementById('calculated-distance').textContent = '-- km';
                        return;
                    }

                    // Haversine formula for distance calculation
                    const haversine = (lat1, lon1, lat2, lon2) => {
                        const R = 6371; // Earth radius in km
                        const dLat = (lat2 - lat1) * Math.PI / 180;
                        const dLon = (lon2 - lon1) * Math.PI / 180;
                        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                            Math.sin(dLon / 2) * Math.sin(dLon / 2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        return R * c;
                    };

                    let totalDistance = 0;
                    const allLocations = [...towerLocations, ...substationLocations];

                    for (let i = 0; i < allLocations.length - 1; i++) {
                        totalDistance += haversine(
                            allLocations[i].lat, allLocations[i].lng,
                            allLocations[i + 1].lat, allLocations[i + 1].lng
                        );
                    }

                    document.getElementById('calculated-distance').textContent = totalDistance.toFixed(2) + ' km';

                    // Auto-fill line length in form
                    const form = document.getElementById('forecast-form');
                    if (!form.lineLength && totalDistance > 0) {
                        // Create hidden input for line length
                        let lineInput = document.querySelector('input[name="lineLength"]');
                        if (!lineInput) {
                            lineInput = document.createElement('input');
                            lineInput.type = 'hidden';
                            lineInput.name = 'lineLength';
                            form.appendChild(lineInput);
                        }
                        lineInput.value = Math.round(totalDistance);
                    }
                }
                // Find this section around line 3445 and REPLACE it completely:

                // Find the forecast submit handler section (around line 3445) and REPLACE it with this:



                // Clear forecast when form is reset
                document.getElementById('forecast-form').addEventListener('reset', () => {
                    towerLocations = [];
                    substationLocations = [];
                    updateMapDisplay();
                    calculateDistance();
                });
                // Attach handler AFTER form is rendered
                setTimeout(() => {
                    const form = document.getElementById("forecast-form");

                    if (!form) {
                        console.error(" STILL NO FORECAST FORM  then HTML is not inside renderForecastPage()");
                        return;
                    }

                    console.log(" Forecast form detected  Handler attached");

                    form.addEventListener("submit", async (e) => {
                        e.preventDefault();
                        showLoading();

                        const fd = new FormData(form);
                        const data = Object.fromEntries(fd);

                        const payload = {
                            project_category_main: data.projectType,
                            project_type: data.towerType || data.projectType,
                            project_budget_price_in_lake: Number(data.budget),
                            state: data.region,
                            terrain: "Plain",
                            Distance_from_Storage_unit: 50,
                            transmission_line_length_km: Number(data.lineLength),
                            location: data.location,
                            project_name: data.projectName
                        };

                        console.log(" SENDING ", payload);

                        const res = await fetch("http://127.0.0.1:8000/forecast/predict", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(payload)
                        });

                        const results = await res.json();
                        hideLoading();

                        // ======================= UI OUTPUT ===========================

                        const qtyRows = results
                            .filter(x => !x.material_name.includes("_price"))
                            .map(x => `
        <tr class="border-b">
            <td class="p-2 font-semibold">${x.material_name}</td>
            <td class="p-2 text-blue-700 font-bold">${x.predicted_value.toFixed(2)}</td>
        </tr>`).join("");

                        const priceRows = results
                            .filter(x => x.material_name.includes("_price"))
                            .map(x => `
        <tr class="border-b">
            <td class="p-2 font-semibold">${x.material_name.replace("_price", "")}</td>
            <td class="p-2 text-green-700 font-bold"> ${x.predicted_value.toLocaleString()}</td>
        </tr>`).join("");


                        document.getElementById("forecast-form-container").classList.add("hidden");
                        document.getElementById("new-forecast-content").innerHTML = `
<div class="bg-white shadow-2xl rounded-2xl p-8 mt-6">

    <h2 class="text-3xl font-extrabold text-center mb-6 text-green-700">
         AI Material Forecast Report
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- Quantity Table -->
        <div class="border rounded-xl p-6 shadow-sm bg-gray-50">
            <h3 class="text-xl font-bold mb-4">Predicted Quantities</h3>
            <table class="w-full text-sm">
                <tr class="border-b font-bold">
                    <td>Material</td><td>Quantity</td>
                </tr>
                ${qtyRows}
            </table>
        </div>

        <!-- Price Table -->
        <div class="border rounded-xl p-6 shadow-sm bg-gray-50">
            <h3 class="text-xl font-bold text-red-700 mb-4">Estimated Cost Output</h3>
            <table class="w-full text-sm">
                <tr class="border-b font-bold">
                    <td>Material</td><td>Predicted Cost</td>
                </tr>
                ${priceRows}
            </table>
        </div>

    </div>

    <button onclick="navigateToPage('forecast')" 
        class="mt-8 w-full bg-blue-600 text-white font-bold p-3 rounded-lg text-lg shadow">
         Run New Forecast
    </button>

</div>`;

                    });

                }, 300); // wait 0.3 sec to ensure DOM is painted

            }

            async function renderInventoryPage() {
                showLoading();
                pageTitle.textContent = "Inventory Management";

                // Sync all data to ensure accuracy
                api.syncAllData();

                const materials = await api.getMaterialsSummary();
                const forecasts = await api.getForecasts();
                const projects = await api.getProjectsSummary();
                const recommendedPOs = await api.getRecommendedPOs();

                // Calculate inventory health metrics
                const inventoryHealth = {
                    adequate: materials.filter(m => m.status === 'Good').length,
                    low: materials.filter(m => m.status === 'Low').length,
                    critical: materials.filter(m => m.status === 'Critical').length,
                    totalValue: materials.reduce((sum, m) => sum + (m.currentStock * m.costPerUnit), 0),
                    shortfallMaterials: materials.filter(m => {
                        const futureDemand = forecastsData.filter(f => f.materialId === m.id && f.actualQty === null).reduce((sum, f) => sum + f.forecastedQty, 0);
                        return (m.safetyStock + futureDemand) > (m.currentStock + m.inTransit);
                    }).length,
                    reservedValue: materials.reduce((sum, m) => sum + (m.reserved * m.costPerUnit), 0)
                };

                // Pagination state
                window.inventoryPagination = {
                    currentPage: 1,
                    itemsPerPage: 10,
                    totalItems: materials.length
                };

                hideLoading();

                mainContent.innerHTML = `
                    <div class="fade-in">
                        <!-- Inventory Health Dashboard -->
                        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-8 rounded-2xl shadow-lg text-white mb-6">
                            <h2 class="text-3xl font-bold mb-4">Inventory Health Monitor</h2>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-purple-100 text-sm font-medium">Total Materials</p>
                                    <p class="text-3xl font-bold mt-1">${materials.length}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-purple-100 text-sm font-medium">Adequate Stock</p>
                                    <p class="text-3xl font-bold mt-1 text-green-300">${inventoryHealth.adequate}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-purple-100 text-sm font-medium">Low Stock</p>
                                    <p class="text-3xl font-bold mt-1 text-yellow-300">${inventoryHealth.low}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-purple-100 text-sm font-medium">Critical Items</p>
                                    <p class="text-3xl font-bold mt-1 text-red-300">${inventoryHealth.critical}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-purple-100 text-sm font-medium">Projected Shortfalls</p>
                                    <p class="text-3xl font-bold mt-1 text-orange-300">${inventoryHealth.shortfallMaterials}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                            <div class="border-b border-slate-200">
                                <div class="flex gap-2 p-4">
                                    <button class="inventory-tab-btn px-6 py-3 font-semibold text-sm rounded-lg transition-all" data-tab="stock-overview">
                                         Stock Overview
                                    </button>
                                    <button class="inventory-tab-btn px-6 py-3 font-semibold text-sm rounded-lg transition-all" data-tab="project-view">
                                         Project-Wise View
                                    </button>
                                    <button class="inventory-tab-btn px-6 py-3 font-semibold text-sm rounded-lg transition-all" data-tab="shortfalls">
                                         Projected Shortfalls
                                    </button>
                                    <button class="inventory-tab-btn px-6 py-3 font-semibold text-sm rounded-lg transition-all" data-tab="forecast-timeline">
                                         Demand Forecast
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <!-- Stock Overview Tab -->
                                <div class="inventory-tab-content" id="stock-overview">
                                    <!-- Filter and Search -->
                                    <div class="bg-slate-50 p-4 rounded-lg mb-6">
                                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Search</label>
                                                <input type="text" id="inventory-search" placeholder="Material name..." class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Category</label>
                                                <select id="inventory-category-filter" class="w-full">
                                                    <option value="">All</option>
                                                    <option value="Towers">Towers</option>
                                                    <option value="Conductors">Conductors</option>
                                                    <option value="Insulators">Insulators</option>
                                                    <option value="Equipment">Equipment</option>
                                                    <option value="Hardware">Hardware</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                                <select id="inventory-status-filter" class="w-full">
                                                    <option value="">All</option>
                                                    <option value="Good">Good</option>
                                                    <option value="Low">Low</option>
                                                    <option value="Critical">Critical</option>
                                                </select>
                                            </div>
                                            <div class="flex items-end">
                                                <button id="reset-inventory-filters" class="btn btn-secondary w-full">Reset</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Cleaner Material Table -->
                                    <div class="overflow-x-auto mb-4" id="inventory-table-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Material</th>
                                                    <th>Category</th>
                                                    <th>Current Stock</th>
                                                    <th>Available</th>
                                                    <th>Reorder Level</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inventory-table-body">
                                                <!-- Populated by pagination -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Pagination Controls -->
                                    <div class="flex justify-between items-center mt-4">
                                        <div class="text-sm text-slate-600">
                                            Showing <span id="page-start">1</span>-<span id="page-end">10</span> of <span id="total-items">${materials.length}</span> materials
                                        </div>
                                        <div class="flex gap-2" id="pagination-controls">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Project-Wise View Tab -->
                                <div class="inventory-tab-content hidden" id="project-view">
                                    <div class="mb-6">
                                        <div class="flex justify-between items-center mb-4">
                                            <div>
                                                <h3 class="text-lg font-bold text-slate-800">Material Requirements by Project</h3>
                                                <p class="text-sm text-slate-600 mt-1">Select a project to view and manage its material allocations</p>
                                            </div>
                                            <button class="btn btn-primary text-sm" onclick="saveAllProjectAllocations()">
                                                 Save All Changes
                                            </button>
                                        </div>
                                        
                                        <!-- Project Selector -->
                                        <div class="bg-slate-50 p-4 rounded-lg mb-4">
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Select Project to View</label>
                                            <select id="project-selector" class="w-full md:w-1/2">
                                                <option value="">-- Choose a project --</option>
                                                ${projects.filter(p => p.status !== 'Completed').map(p =>
                    `<option value="${p.id}">${p.name || 'Unnamed Project'} - ${p.location || 'Location TBD'} (${p.progress || 0}%)</option>`
                ).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="selected-project-view">
                                        <div class="text-center py-12 text-slate-400">
                                            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                            </svg>
                                            <p class="text-lg font-medium">Select a project to view its materials</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Projected Shortfalls Tab -->
                                <div class="inventory-tab-content hidden" id="shortfalls">
                                    ${materials.filter(m => {
                    const futureDemand = forecastsData.filter(f => f.materialId === m.id && f.actualQty === null).reduce((sum, f) => sum + f.forecastedQty, 0);
                    return (m.safetyStock + futureDemand) > (m.currentStock + m.inTransit);
                }).length > 0 ? `
                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            ${materials.filter(m => {
                    const futureDemand = forecastsData.filter(f => f.materialId === m.id && f.actualQty === null).reduce((sum, f) => sum + f.forecastedQty, 0);
                    return (m.safetyStock + futureDemand) > (m.currentStock + m.inTransit);
                }).map(m => {
                    const futureDemand = forecastsData.filter(f => f.materialId === m.id && f.actualQty === null).reduce((sum, f) => sum + f.forecastedQty, 0);
                    const totalNeeded = m.safetyStock + futureDemand;
                    const totalAvailable = m.currentStock + m.inTransit;
                    const shortfall = totalNeeded - totalAvailable;
                    const recommendedOrder = Math.ceil(shortfall * 1.1);
                    const estimatedCost = recommendedOrder * m.costPerUnit;

                    return `
                                                    <div class="border-2 border-red-200 rounded-lg p-6 bg-red-50/50">
                                                        <div class="flex justify-between items-start mb-4">
                                                            <div>
                                                                <h4 class="font-bold text-slate-800 text-lg">${m.name}</h4>
                                                                <p class="text-sm text-slate-600 mt-1">${m.category}  Lead Time: ${m.leadTime} days</p>
                                                            </div>
                                                            <span class="badge badge-danger">Shortage Risk</span>
                                                        </div>
                                                        
                                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                                            <div class="bg-white rounded-lg p-3">
                                                                <p class="text-xs text-slate-500 mb-1">Current + In Transit</p>
                                                                <p class="text-xl font-bold text-blue-600">${totalAvailable.toLocaleString()} ${m.unit}</p>
                                                            </div>
                                                            <div class="bg-white rounded-lg p-3">
                                                                <p class="text-xs text-slate-500 mb-1">Safety + Forecast Need</p>
                                                                <p class="text-xl font-bold text-purple-600">${totalNeeded.toLocaleString()} ${m.unit}</p>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="bg-red-100 border border-red-300 rounded-lg p-4 mb-4">
                                                            <div class="flex justify-between items-center">
                                                                <div>
                                                                    <p class="text-sm font-semibold text-red-800">Projected Shortfall</p>
                                                                    <p class="text-2xl font-black text-red-600 mt-1">${shortfall.toLocaleString()} ${m.unit}</p>
                                                                </div>
                                                                <svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                                                </svg>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                                            <p class="text-sm font-semibold text-blue-800 mb-3"> Recommended Action</p>
                                                            <div class="grid grid-cols-2 gap-3 text-sm">
                                                                <div>
                                                                    <p class="text-blue-600 font-medium">Order Quantity</p>
                                                                    <p class="font-bold text-blue-900">${recommendedOrder.toLocaleString()} ${m.unit}</p>
                                                                </div>
                                                                <div>
                                                                    <p class="text-blue-600 font-medium">Estimated Cost</p>
                                                                    <p class="font-bold text-blue-900">${(estimatedCost / 100000).toFixed(2)}L</p>
                                                                </div>
                                                                <div>
                                                                    <p class="text-blue-600 font-medium">Supplier</p>
                                                                    <p class="font-bold text-blue-900">${m.supplierName}</p>
                                                                </div>
                                                                <div>
                                                                    <p class="text-blue-600 font-medium">Lead Time</p>
                                                                    <p class="font-bold text-blue-900">${m.leadTime} days</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="flex gap-3">
                                                            <button class="btn btn-primary flex-1 text-sm create-po-from-inventory" data-material-id="${m.id}">
                                                                 Create Purchase Order
                                                            </button>
                                                            <button class="btn btn-outline text-sm view-forecast-details" data-material-id="${m.id}">
                                                                 View Forecasts
                                                            </button>
                                                        </div>
                                                    </div>
                                                `;
                }).join('')}
                                        </div>
                                    ` : `
                                        <div class="text-center py-12 text-slate-500">
                                            <svg class="w-20 h-20 mx-auto mb-4 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-xl font-bold text-green-600"> No Projected Shortfalls</p>
                                            <p class="text-sm mt-2">Current inventory and in-transit orders are sufficient to meet forecasted demand</p>
                                        </div>
                                    `}
                                </div>
                                
                                <!-- Demand Forecast Timeline Tab -->
                                <div class="inventory-tab-content hidden" id="forecast-timeline">
                                    <div class="space-y-6">
                                        ${Array.from(new Set(forecastsData.map(f => f.month))).sort().slice(0, 6).map(month => `
                                            <div class="border border-slate-200 rounded-lg p-5">
                                                <h4 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                    </svg>
                                                    ${new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
                                                </h4>
                                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    ${forecastsData.filter(f => f.month === month).map(f => {
                    const material = materialMasterData.find(m => m.id === f.materialId);
                    const project = projectsData.find(p => p.id === f.projectId);
                    return `
                                                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                                                <div class="flex justify-between items-start mb-2">
                                                                    <p class="text-sm font-semibold text-slate-800">${material?.name || 'Unknown'}</p>
                                                                    <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700 font-semibold">
                                                                        ${f.confidence.toFixed(0)}%
                                                                    </span>
                                                                </div>
                                                                <p class="text-2xl font-black text-purple-600 mb-1">${f.forecastedQty.toLocaleString()}</p>
                                                                <p class="text-xs text-slate-600">${material?.unit || 'units'}  ${project?.name || 'Unknown Project'}</p>
                                                            </div>
                                                        `;
                }).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.querySelector('.forecast-tab[data-tab="new-forecast"]').click();

                hideLoading();

                // Store materials data for filtering and pagination
                window.inventoryFilterData = materials;
                window.filteredMaterials = materials;

                // Tab Switching
                document.querySelectorAll('.inventory-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tabId = btn.dataset.tab;

                        // Update button states
                        document.querySelectorAll('.inventory-tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        // Update content visibility
                        document.querySelectorAll('.inventory-tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        document.getElementById(tabId).classList.remove('hidden');
                    });
                });

                // Show first tab by default
                document.querySelector('.inventory-tab-btn[data-tab="stock-overview"]')?.classList.add('active');
                document.getElementById('stock-overview')?.classList.remove('hidden');

                // Pagination Functions
                function renderInventoryTable(page = 1) {
                    const start = (page - 1) * window.inventoryPagination.itemsPerPage;
                    const end = start + window.inventoryPagination.itemsPerPage;
                    const paginatedData = window.filteredMaterials.slice(start, end);

                    const tbody = document.getElementById('inventory-table-body');
                    tbody.innerHTML = paginatedData.map(m => {
                        const futureDemand = forecastsData
                            .filter(f => f.materialId === m.id && f.actualQty === null)
                            .reduce((sum, f) => sum + f.forecastedQty, 0);
                        const totalNeeded = m.safetyStock + futureDemand;
                        const totalAvailable = m.currentStock + m.inTransit;
                        const projectedGap = totalNeeded - totalAvailable;

                        return `
                            <tr class="inventory-row" data-material-id="${m.id}" data-category="${m.category}" data-status="${m.status}">
                                <td>
                                    <div>
                                        <p class="font-bold text-slate-800">${m.name}</p>
                                        <p class="text-xs text-slate-500">${m.id}</p>
                                    </div>
                                </td>
                                <td><span class="badge badge-info text-xs">${m.category}</span></td>
                                <td class="font-bold">${m.currentStock.toLocaleString()} ${m.unit}</td>
                                <td class="text-green-700 font-bold">${m.available.toLocaleString()} ${m.unit}</td>
                                <td class="text-orange-600 font-semibold">${m.reorderLevel.toLocaleString()} ${m.unit}</td>
                                <td>
                                    <span class="badge ${m.status === 'Critical' ? 'badge-danger' : m.status === 'Low' ? 'badge-warning' : 'badge-success'} text-xs">
                                        ${m.status}
                                    </span>
                                    ${projectedGap > 0 ? '<br><span class="badge badge-danger text-xs mt-1">Future Shortage</span>' : ''}
                                </td>
                                <td>
                                    <button class="text-teal-500 hover:text-teal-700 font-semibold text-xs view-material-details" data-material-id="${m.id}">
                                         Details
                                    </button>
                                    ${projectedGap > 0 ? `<br><button class="text-blue-500 hover:text-blue-700 font-semibold text-xs mt-1 create-po-from-inventory" data-material-id="${m.id}"> Create PO</button>` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('');

                    // Update pagination info
                    document.getElementById('page-start').textContent = start + 1;
                    document.getElementById('page-end').textContent = Math.min(end, window.filteredMaterials.length);
                    document.getElementById('total-items').textContent = window.filteredMaterials.length;

                    // Render pagination controls
                    renderPaginationControls();

                    // Reattach event listeners
                    attachInventoryEventListeners();
                }

                function renderPaginationControls() {
                    const totalPages = Math.ceil(window.filteredMaterials.length / window.inventoryPagination.itemsPerPage);
                    const currentPage = window.inventoryPagination.currentPage;
                    const controls = document.getElementById('pagination-controls');

                    let html = `
                        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
                             Prev
                        </button>
                    `;

                    // Show max 7 page numbers
                    let startPage = Math.max(1, currentPage - 3);
                    let endPage = Math.min(totalPages, startPage + 6);

                    if (endPage - startPage < 6) {
                        startPage = Math.max(1, endPage - 6);
                    }

                    if (startPage > 1) {
                        html += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                        if (startPage > 2) html += `<span class="px-2">...</span>`;
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                    }

                    if (endPage < totalPages) {
                        if (endPage < totalPages - 1) html += `<span class="px-2">...</span>`;
                        html += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
                    }

                    html += `
                        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
                            Next 
                        </button>
                    `;

                    controls.innerHTML = html;
                }

                window.changePage = function (page) {
                    const totalPages = Math.ceil(window.filteredMaterials.length / window.inventoryPagination.itemsPerPage);
                    if (page < 1 || page > totalPages) return;
                    window.inventoryPagination.currentPage = page;
                    renderInventoryTable(page);
                };

                // Initial render
                renderInventoryTable(1);

                // Attach event listeners to buttons in the table
                attachInventoryEventListeners();

                // Project Selector for Project-Wise View
                const projectSelector = document.getElementById('project-selector');
                projectSelector?.addEventListener('change', (e) => {
                    const projectId = e.target.value;
                    const projectViewContainer = document.getElementById('selected-project-view');

                    if (!projectId) {
                        projectViewContainer.innerHTML = `
                            <div class="text-center py-12 text-slate-400">
                                <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                <p class="text-lg font-medium">Select a project to view its materials</p>
                            </div>
                        `;
                        return;
                    }

                    const project = projectsData.find(p => p.id === projectId);
                    if (!project) return;

                    const projectMaterials = project.materialRequirements || [];

                    projectViewContainer.innerHTML = `
                        <div class="border-2 border-slate-200 rounded-lg overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 text-white">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-bold text-lg">${project.name || 'Unnamed Project'}</h4>
                                        <p class="text-sm text-indigo-100 mt-1">
                                            ${project.location || 'Location TBD'}  Progress: ${project.progress || 0}%  ${projectMaterials.length} materials
                                        </p>
                                    </div>
                                    <span class="badge ${project.health === 'On Track' ? 'badge-success' : project.health === 'At Risk' ? 'badge-warning' : 'badge-danger'}">
                                        ${project.health || 'Status Unknown'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-white">
                                ${projectMaterials.length > 0 ? `
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Material</th>
                                                <th>Required</th>
                                                <th>Allocated</th>
                                                <th>Pending</th>
                                                <th>Available Stock</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${projectMaterials.map(req => {
                        const material = materialMasterData.find(m => m.id === req.materialId);
                        if (!material) return '';

                        const required = req.required || 0;
                        const allocated = req.allocated || 0;
                        const pending = req.pending || 0;
                        const fulfillmentPct = required > 0 ? ((allocated / required) * 100).toFixed(0) : 0;
                        const canAllocateMore = (material.available || 0) >= pending;

                        const allocateBtn = pending > 0 && canAllocateMore ?
                            '<button class="text-green-600 hover:text-green-700 font-semibold text-xs allocate-material" data-project-id="' + project.id + '" data-material-id="' + req.materialId + '" data-pending="' + pending + '"> Allocate All</button>' : '';

                        const orderBtn = pending > 0 && !canAllocateMore ?
                            '<button class="text-blue-600 hover:text-blue-700 font-semibold text-xs create-po-from-project" data-project-id="' + project.id + '" data-material-id="' + req.materialId + '" data-shortage="' + (pending - (material.available || 0)) + '"> Order More</button>' : '';

                        return '<tr data-project-id="' + project.id + '" data-material-id="' + req.materialId + '">' +
                            '<td><div><p class="font-semibold text-slate-800">' + (material.name || 'Unknown Material') + '</p>' +
                            '<p class="text-xs text-slate-500">' + (material.category || 'Uncategorized') + '</p></div></td>' +
                            '<td class="font-bold text-slate-800">' + required.toLocaleString() + ' ' + (material.unit || 'units') + '</td>' +
                            '<td class="text-green-600 font-semibold"><input type="number" class="w-20 px-2 py-1 border border-green-300 rounded text-sm editable-allocated bg-green-50" value="' + allocated + '" data-project-id="' + project.id + '" data-material-id="' + req.materialId + '" data-max-available="' + (material.available || 0) + '" min="0" /> ' + (material.unit || 'units') + '</td>' +
                            '<td class="text-orange-600 font-semibold">' + pending.toLocaleString() + ' ' + (material.unit || 'units') + '</td>' +
                            '<td class="text-blue-600 font-bold">' + (material.available || 0).toLocaleString() + ' ' + (material.unit || 'units') + '</td>' +
                            '<td><div class="flex items-center gap-2"><div class="w-20 bg-slate-200 rounded-full h-2"><div class="bg-green-600 h-2 rounded-full" style="width: ' + fulfillmentPct + '%"></div></div>' +
                            '<span class="text-xs font-semibold text-slate-700">' + fulfillmentPct + '%</span></div>' +
                            (!canAllocateMore && pending > 0 ? '<span class="badge badge-danger text-xs mt-1">Insufficient Stock</span>' : '') + '</td>' +
                            '<td><div class="flex flex-col gap-1">' + allocateBtn + orderBtn +
                            '<button class="text-purple-600 hover:text-purple-700 font-semibold text-xs edit-allocation" data-project-id="' + project.id + '" data-material-id="' + req.materialId + '"> Edit</button>' +
                            '</div></td></tr>';
                    }).join('')}
                                        </tbody>
                                    </table>
                                ` : `
                                    <div class="text-center py-8 text-slate-500">
                                        <p class="text-lg font-medium">No materials assigned to this project yet</p>
                                        <p class="text-sm mt-2">Materials will appear here once they are linked to this project</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    `;

                    // Reattach event listeners for the newly created elements
                    attachInventoryEventListeners();
                });

                // Filter functionality
                window.inventoryFilterData = materials;

                // Filter functionality
                const searchInput = document.getElementById('inventory-search');
                const categoryFilter = document.getElementById('inventory-category-filter');
                const statusFilter = document.getElementById('inventory-status-filter');
                const resetButton = document.getElementById('reset-inventory-filters');

                function applyInventoryFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const category = categoryFilter.value;
                    const status = statusFilter.value;

                    window.filteredMaterials = window.inventoryFilterData.filter(material => {
                        const matchesSearch = !searchTerm ||
                            material.name.toLowerCase().includes(searchTerm) ||
                            material.id.toLowerCase().includes(searchTerm);
                        const matchesCategory = !category || material.category === category;
                        const matchesStatus = !status || material.status === status;

                        return matchesSearch && matchesCategory && matchesStatus;
                    });

                    // Reset to page 1 and re-render
                    window.inventoryPagination.currentPage = 1;
                    renderInventoryTable(1);
                }

                searchInput?.addEventListener('input', applyInventoryFilters);
                categoryFilter?.addEventListener('change', applyInventoryFilters);
                statusFilter?.addEventListener('change', applyInventoryFilters);
                resetButton?.addEventListener('click', () => {
                    searchInput.value = '';
                    categoryFilter.value = '';
                    statusFilter.value = '';
                    window.filteredMaterials = window.inventoryFilterData;
                    window.inventoryPagination.currentPage = 1;
                    renderInventoryTable(1);
                });

                // Function to attach event listeners to table buttons
                function attachInventoryEventListeners() {
                    // View Material Details
                    document.querySelectorAll('.view-material-details').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const materialId = btn.dataset.materialId;
                            const material = window.inventoryFilterData.find(m => m.id === materialId);

                            // Show detailed modal with reservation details
                            const reservations = projectsData
                                .filter(p => p.materialRequirements?.some(r => r.materialId === materialId))
                                .map(p => {
                                    const req = p.materialRequirements.find(r => r.materialId === materialId);
                                    return { project: p.name, allocated: req.allocated, pending: req.pending };
                                });

                            const forecasts = forecastsData
                                .filter(f => f.materialId === materialId && f.actualQty === null)
                                .map(f => ({ month: f.month, qty: f.forecastedQty, confidence: f.confidence }));

                            alert(`Material Details: ${material.name}\n\nReservations:\n${reservations.map(r => `- ${r.project}: ${r.allocated} units allocated, ${r.pending} pending`).join('\n')}\n\nUpcoming Forecasts:\n${forecasts.map(f => `- ${f.month}: ${f.qty} units (${f.confidence.toFixed(0)}% confidence)`).join('\n')}`);
                        });
                    });

                    // Create PO from Inventory
                    document.querySelectorAll('.create-po-from-inventory').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const materialId = btn.dataset.materialId;
                            const material = window.inventoryFilterData.find(m => m.id === materialId);

                            const futureDemand = forecastsData
                                .filter(f => f.materialId === materialId && f.actualQty === null)
                                .reduce((sum, f) => sum + f.forecastedQty, 0);
                            const totalNeeded = material.safetyStock + futureDemand;
                            const totalAvailable = material.currentStock + material.inTransit;
                            const shortfall = totalNeeded - totalAvailable;
                            const recommendedQty = Math.ceil(shortfall * 1.1);

                            // Navigate to Procurement and pre-fill PO
                            window.prepopulatedPO = {
                                materialId: materialId,
                                materialName: material.name,
                                quantity: recommendedQty,
                                supplierId: material.supplierId,
                                supplierName: material.supplierName,
                                estimatedCost: recommendedQty * material.costPerUnit,
                                triggerReason: `Inventory Shortfall: Projected gap of ${shortfall} ${material.unit}`
                            };

                            navigateToPage('procurement');

                            // Show success notification
                            setTimeout(() => {
                                alert(` Navigated to Procurement\n\nPre-filled PO Details:\n- Material: ${material.name}\n- Quantity: ${recommendedQty.toLocaleString()} ${material.unit}\n- Supplier: ${material.supplierName}\n- Estimated Cost: ${(recommendedQty * material.costPerUnit / 100000).toFixed(2)}L`);
                            }, 500);
                        });
                    });

                    // View Forecast Details
                    document.querySelectorAll('.view-forecast-details').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const materialId = btn.dataset.materialId;
                            window.selectedMaterialForForecast = materialId;
                            navigateToPage('forecast');
                        });
                    });

                    // Project-wise view: Allocate Material
                    document.querySelectorAll('.allocate-material').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const projectId = btn.dataset.projectId;
                            const materialId = btn.dataset.materialId;
                            const pending = parseInt(btn.dataset.pending);

                            if (confirm(`Allocate ${pending.toLocaleString()} units to this project?`)) {
                                // Update allocation (in real app, this would be an API call)
                                const project = projectsData.find(p => p.id === projectId);
                                const material = materialMasterData.find(m => m.id === materialId);
                                const req = project.materialRequirements.find(r => r.materialId === materialId);

                                req.allocated += pending;
                                req.pending = 0;
                                material.available -= pending;
                                material.reserved += pending;

                                alert(` Successfully allocated ${pending.toLocaleString()} units of ${material.name} to ${project.name}`);
                                renderInventoryPage(); // Refresh view
                            }
                        });
                    });

                    // Project-wise view: Create PO from project shortage
                    document.querySelectorAll('.create-po-from-project').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const projectId = btn.dataset.projectId;
                            const materialId = btn.dataset.materialId;
                            const shortage = parseInt(btn.dataset.shortage);

                            const project = projectsData.find(p => p.id === projectId);
                            const material = materialMasterData.find(m => m.id === materialId);
                            const recommendedQty = Math.ceil(shortage * 1.1);

                            window.prepopulatedPO = {
                                materialId: materialId,
                                materialName: material.name,
                                quantity: recommendedQty,
                                supplierId: material.supplierId,
                                supplierName: material.supplierName,
                                estimatedCost: recommendedQty * material.costPerUnit,
                                triggerReason: `Project ${project.name}: Shortage of ${shortage.toLocaleString()} ${material.unit}`
                            };

                            navigateToPage('procurement');
                        });
                    });

                    // Project-wise view: Edit allocation
                    document.querySelectorAll('.edit-allocation').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const projectId = btn.dataset.projectId;
                            const materialId = btn.dataset.materialId;

                            const project = projectsData.find(p => p.id === projectId);
                            const material = materialMasterData.find(m => m.id === materialId);
                            const req = project.materialRequirements.find(r => r.materialId === materialId);

                            const newAllocated = prompt(`Edit allocated quantity for ${material.name}:\n\nCurrent: ${req.allocated.toLocaleString()} ${material.unit}\nAvailable stock: ${material.available.toLocaleString()} ${material.unit}`, req.allocated);

                            if (newAllocated !== null) {
                                const allocatedNum = parseInt(newAllocated);
                                if (!isNaN(allocatedNum) && allocatedNum >= 0 && allocatedNum <= req.required) {
                                    const difference = allocatedNum - req.allocated;

                                    if (difference > material.available) {
                                        alert(` Cannot allocate ${difference.toLocaleString()} units. Only ${material.available.toLocaleString()} units available.`);
                                        return;
                                    }

                                    req.allocated = allocatedNum;
                                    req.pending = req.required - allocatedNum;
                                    material.available -= difference;
                                    material.reserved += difference;

                                    alert(` Updated allocation for ${material.name} to ${allocatedNum.toLocaleString()} units`);
                                    renderInventoryPage();
                                } else {
                                    alert('Invalid quantity entered');
                                }
                            }
                        });
                    });

                    // Project-wise view: Edit allocated quantity inline
                    document.querySelectorAll('.editable-allocated').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const projectId = e.target.dataset.projectId;
                            const materialId = e.target.dataset.materialId;
                            const maxAvailable = parseInt(e.target.dataset.maxAvailable) || 0;
                            const newAllocated = parseInt(e.target.value);

                            const project = projectsData.find(p => p.id === projectId);
                            const material = materialMasterData.find(m => m.id === materialId);
                            const req = project.materialRequirements.find(r => r.materialId === materialId);

                            if (!isNaN(newAllocated) && newAllocated >= 0) {
                                const oldAllocated = req.allocated || 0;
                                const difference = newAllocated - oldAllocated;

                                // Check if we're allocating more
                                if (difference > 0) {
                                    if (difference > (material.available || 0)) {
                                        alert(` Cannot allocate ${difference.toLocaleString()} more units.\nOnly ${(material.available || 0).toLocaleString()} units available in stock.`);
                                        e.target.value = oldAllocated;
                                        return;
                                    }

                                    if (newAllocated > (req.required || 0)) {
                                        if (!confirm(` You're allocating ${newAllocated.toLocaleString()} units but only ${(req.required || 0).toLocaleString()} units are required.\n\nContinue anyway?`)) {
                                            e.target.value = oldAllocated;
                                            return;
                                        }
                                    }
                                }

                                // Update allocation
                                req.allocated = newAllocated;
                                req.pending = Math.max(0, (req.required || 0) - newAllocated);
                                material.available = (material.available || 0) - difference;
                                material.reserved = (material.reserved || 0) + difference;

                                // Visual feedback
                                e.target.style.backgroundColor = '#dcfce7'; // Light green
                                setTimeout(() => e.target.style.backgroundColor = '#f0fdf4', 500);

                                console.log(`Updated allocation for ${material.name} in ${project.name}: ${oldAllocated}  ${newAllocated} ( ${difference})`);
                            } else {
                                e.target.value = req.allocated || 0;
                                alert('Invalid quantity');
                            }
                        });
                    });
                }

                // Global function to save all project allocations
                window.saveAllProjectAllocations = function () {
                    // In a real app, this would make API calls to persist changes
                    const changedData = {
                        timestamp: new Date().toISOString(),
                        projects: projectsData.filter(p => p.status !== 'Completed').map(p => ({
                            id: p.id,
                            name: p.name,
                            materials: p.materialRequirements
                        }))
                    };

                    console.log('Saving project allocations:', changedData);
                    alert(` All Changes Saved!\n\n${changedData.projects.length} projects updated\nTimestamp: ${new Date().toLocaleString()}\n\nNote: In production, this would sync with the backend database.`);
                };

                // Add Material button functionality
                document.querySelector('.add-material-btn')?.addEventListener('click', () => {
                    alert('Add New Material form will open here. Feature coming soon!');
                });
            }

            // Export Inventory Data function
            function exportInventoryData() {
                alert('Export to Excel functionality will download comprehensive inventory report with:\n- Current stock levels\n- Reserved quantities by project\n- In-transit orders\n- Forecasted demand\n- Projected shortfalls\n- Supplier information\n\nFeature coming soon!');
            }

            async function renderProjectsPage() {
                showLoading();
                pageTitle.textContent = "Project Management";
                // Fetch projects list from backend API Change 2
                const response = await fetch("http://127.0.0.1:8000/projects/user/1");
                let projects = await response.json();
                console.log("Projects from backend:", projects);
                // Change 4 // Change 6
                projects = projects.map(p => ({
                    id: p.id,
                    name: p.project_name,
                    budget: p.project_budget,
                    location: p.location,
                    projectType: p.category,
                    towerType: p.tower_type,
                    region: p.terrain,
                    userId: p.user_id,
                    createdAt: p.created_at?.split("T")[0] || "",

                    //  actual usable dates
                    startDate: p.start_date || p.created_at?.split("T")[0] || "Not Provided",
                    endDate: p.end_date || "Not Provided",

                    // required for UI
                    status: "Planning",
                    completion: 0
                }));




                // Store for filtering
                window.projectsFilterData = projects;

                mainContent.innerHTML = `
                    <div class="fade-in">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-slate-800">Active Projects</h2>
                                <button id="create-project-btn" class="btn btn-primary">Create New Project</button>
                            </div>
                            
                            <!-- Project Filters -->
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                                <h3 class="text-sm font-bold text-slate-700 mb-3">Filter Projects</h3>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-600 mb-1">Region</label>
                                        <select id="project-filter-region" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-jungle-green focus:border-jungle-green">
                                            <option value="">All Regions</option>
                                            <option value="North">North</option>
                                            <option value="South">South</option>
                                            <option value="East">East</option>
                                            <option value="West">West</option>
                                            <option value="Central">Central</option>
                                            <option value="North East">North East</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-600 mb-1">Status</label>
                                        <select id="project-filter-status" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-jungle-green focus:border-jungle-green">
                                            <option value="">All Status</option>
                                            <option value="Planning">Planning</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Completed">Completed</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-600 mb-1">Min Completion %</label>
                                        <input type="number" id="project-filter-min-completion" min="0" max="100" placeholder="0" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-jungle-green focus:border-jungle-green">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-600 mb-1">Max Completion %</label>
                                        <input type="number" id="project-filter-max-completion" min="0" max="100" placeholder="100" class="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-jungle-green focus:border-jungle-green">
                                    </div>
                                    <div class="md:col-span-4">
                                        <button id="reset-project-filters" class="btn btn-outline text-sm">Clear All Filters</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="projects-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                ${projects.map(p => `
                                    <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 hover:shadow-lg transition-all">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="font-mono text-xs text-slate-500">${p.id}</span>
                                            <span class="badge ${p.status === 'In Progress' ? 'badge-info' : 'badge-warning'}">${p.status}</span>
                                        </div>
                                        <h3 class="text-lg font-bold text-slate-800 mb-2">${p.name}</h3>
                                        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                            <div>
                                                <p class="text-slate-500">Region</p>
                                                <p class="font-semibold text-slate-700">${p.region || 'N/A'}</p>
                                            </div>
                                            <div>
                                                <p class="text-slate-500">Location</p>
                                                <p class="font-semibold text-slate-700">${p.location}</p>
                                            </div>
                                            <div>
                                                <p class="text-slate-500">Budget</p>
                                                <p class="font-semibold text-slate-700">${p.budget} Cr</p>

                                            </div>
                                            <div>
                                                <p class="text-slate-500">Project Type</p>
                                                <p class="font-semibold text-slate-700">${p.projectType || 'Both'}</p>
                                            </div>
                                            <div>
                                                <p class="text-slate-500">Start Date</p>
                                                <p class="font-semibold text-slate-700">${p.startDate}</p>
                                            </div>
                                            <div>
                                                <p class="text-slate-500">End Date</p>
                                                <p class="font-semibold text-slate-700">${p.endDate}</p>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="flex items-center justify-between text-sm mb-1">
                                                <span class="text-slate-600">Progress</span>
                                                <span class="font-bold text-teal-600">${p.completion}%</span>
                                            </div>
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${p.completion}%"></div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 mt-4">
                                            <button class="flex-1 btn btn-outline text-sm use-in-forecast" data-project-id="${p.id}">Use in Forecast</button>
                                            <button class="btn btn-secondary text-sm view-project-details" data-project='${JSON.stringify(p)}'>View Details</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                hideLoading();

                // Project filter listeners - auto-apply on change
                document.getElementById('project-filter-region').addEventListener('change', applyProjectFilters);
                document.getElementById('project-filter-status').addEventListener('change', applyProjectFilters);
                document.getElementById('project-filter-min-completion').addEventListener('input', applyProjectFilters);
                document.getElementById('project-filter-max-completion').addEventListener('input', applyProjectFilters);

                document.getElementById('reset-project-filters').addEventListener('click', () => {
                    document.getElementById('project-filter-region').value = '';
                    document.getElementById('project-filter-status').value = '';
                    document.getElementById('project-filter-min-completion').value = '';
                    document.getElementById('project-filter-max-completion').value = '';
                    renderProjectGrid(window.projectsFilterData);
                });

                // Create Project Modal
                document.getElementById('create-project-btn').addEventListener('click', () => {
                    const modalContent = document.getElementById('modal-content');
                    modalContent.innerHTML = `
                        <div class="mb-6 pb-4 border-b-2 border-teal-200">
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Create New Project
                            </h2>
                            <p class="text-sm text-slate-600 mt-1">Fill in the details below to create a new transmission project</p>
                        </div>
                        <form id="new-project-form" class="space-y-5">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Project Name *</label>
                                    <input type="text" name="name" required class="w-full" placeholder="e.g., 400kV Transmission Line">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Region *</label>
                                    <select name="region" id="project-region" required class="w-full">
                                        <option value="">Select Region</option>
                                        <option value="North">North India</option>
                                        <option value="South">South India</option>
                                        <option value="East">East India</option>
                                        <option value="West">West India</option>
                                        <option value="Central">Central India</option>
                                        <option value="North East">North East India</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">State *</label>
                                    <select name="location" id="project-location" required class="w-full">
                                        <option value="">Select Region First</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Project Type *</label>
                                    <select name="projectType" id="project-type" required class="w-full">
                                        <option value="">Select Project Type</option>
                                        <option value="Tower">Tower Type</option>
                                        <option value="Substation">Substation Type</option>
                                        <option value="Both">Both</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Budget ( Crores) *</label>
                                    <input type="number" name="budget" required class="w-full" placeholder="100" step="0.01">
                                    <p class="text-xs text-slate-500 mt-1">Enter budget in Crores (e.g., 100 for 100 Crores)</p>
                                </div>
                                <div id="project-tower-type-field" class="hidden">
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Tower Type *</label>
                                    <select name="towerType" id="project-tower-type" class="w-full">
                                        <option value="">Select Type</option>
                                        <option value="Type A - 765kV">Type A - 765kV</option>
                                        <option value="Type B - 400kV">Type B - 400kV</option>
                                        <option value="Type C - 220kV">Type C - 220kV</option>
                                        <option value="Type D - 132kV">Type D - 132kV</option>
                                    </select>
                                </div>
                                <div id="project-substation-type-field" class="hidden">
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Substation Type *</label>
                                    <select name="substationType" id="project-substation-type" class="w-full">
                                        <option value="">Select Type</option>
                                        <option value="765kV GIS">765kV GIS</option>
                                        <option value="400kV AIS">400kV AIS</option>
                                        <option value="220kV Hybrid">220kV Hybrid</option>
                                        <option value="132kV Standard">132kV Standard</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Line Length (km) *</label>
                                    <input type="number" name="lineLength" required class="w-full" min="1" placeholder="250">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Start Date *</label>
                                    <input type="date" name="startDate" required class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">End Date *</label>
                                    <input type="date" name="endDate" required class="w-full">
                                </div>
                            </div>
                            <div class="flex gap-3 pt-6 mt-6 border-t border-slate-200">
                                <button type="submit" class="flex-1 btn btn-primary py-3 text-base font-semibold">
                                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Create Project
                                </button>
                                <button type="button" id="cancel-create" class="btn btn-secondary px-8 py-3">
                                    Cancel
                                </button>
                            </div>
                        </form>
                        </div>
                    `;
                    document.getElementById('modal-overlay').classList.remove('hidden');

                    // Region-to-State mapping
                    const regionStates = {
                        'North': ['Delhi NCR', 'Punjab', 'Haryana', 'Himachal Pradesh', 'Jammu & Kashmir', 'Uttarakhand', 'Uttar Pradesh', 'Rajasthan'],
                        'South': ['Karnataka', 'Tamil Nadu', 'Kerala', 'Andhra Pradesh', 'Telangana', 'Puducherry'],
                        'East': ['West Bengal', 'Bihar', 'Odisha', 'Jharkhand'],
                        'West': ['Maharashtra', 'Gujarat', 'Goa'],
                        'Central': ['Madhya Pradesh', 'Chhattisgarh'],
                        'North East': ['Assam', 'Arunachal Pradesh', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Tripura', 'Sikkim']
                    };

                    // Project form region-state filtering
                    const projectRegion = document.getElementById('project-region');
                    const projectLocation = document.getElementById('project-location');

                    projectRegion.addEventListener('change', (e) => {
                        const selectedRegion = e.target.value;
                        projectLocation.innerHTML = '<option value="">Select State</option>';

                        if (selectedRegion && regionStates[selectedRegion]) {
                            regionStates[selectedRegion].forEach(state => {
                                const option = document.createElement('option');
                                option.value = state;
                                option.textContent = state;
                                projectLocation.appendChild(option);
                            });
                        }
                    });

                    // Project Type change handler for Projects form
                    const projectTypeSelect = document.getElementById('project-type');
                    const projectTowerTypeField = document.getElementById('project-tower-type-field');
                    const projectSubstationTypeField = document.getElementById('project-substation-type-field');
                    const projectTowerTypeSelect = document.getElementById('project-tower-type');
                    const projectSubstationTypeSelect = document.getElementById('project-substation-type');

                    projectTypeSelect.addEventListener('change', (e) => {
                        const projectType = e.target.value;

                        // Hide all and remove required
                        projectTowerTypeField.classList.add('hidden');
                        projectSubstationTypeField.classList.add('hidden');
                        projectTowerTypeSelect.removeAttribute('required');
                        projectSubstationTypeSelect.removeAttribute('required');
                        projectTowerTypeSelect.value = '';
                        projectSubstationTypeSelect.value = '';

                        // Show relevant fields based on selection
                        if (projectType === 'Tower') {
                            projectTowerTypeField.classList.remove('hidden');
                            projectTowerTypeSelect.setAttribute('required', 'required');
                        } else if (projectType === 'Substation') {
                            projectSubstationTypeField.classList.remove('hidden');
                            projectSubstationTypeSelect.setAttribute('required', 'required');
                        } else if (projectType === 'Both') {
                            projectTowerTypeField.classList.remove('hidden');
                            projectSubstationTypeField.classList.remove('hidden');
                            projectTowerTypeSelect.setAttribute('required', 'required');
                            projectSubstationTypeSelect.setAttribute('required', 'required');
                        }
                    });

                    document.getElementById('cancel-create').addEventListener('click', () => {
                        document.getElementById('modal-overlay').classList.add('hidden');
                    });

                    document.getElementById('new-project-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        showLoading();

                        const formData = new FormData(e.target);
                        // change-5
                        const projectData = {
                            project_name: formData.get('name'),
                            project_budget: parseFloat(formData.get('budget')),
                            location: formData.get('location'),
                            category: formData.get('projectType'),
                            tower_type: formData.get('towerType') || null,
                            terrain: formData.get('region'),
                            user_id: 1
                        };

                        // change 3
                        await fetch("http://127.0.0.1:8000/projects/create", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(projectData)
                        });
                        document.getElementById('modal-overlay').classList.add('hidden');
                        hideLoading();

                        // Show success and refresh
                        alert('Project created successfully!');
                        renderProjectsPage();
                    });
                });

                // Use in Forecast buttons
                document.querySelectorAll('.use-in-forecast').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const projectId = btn.dataset.projectId;
                        localStorage.setItem('selectedProjectForForecast', projectId);
                        navigateToPage('forecast');
                    });
                });

                // View Details buttons
                document.querySelectorAll('.view-project-details').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const project = JSON.parse(btn.dataset.project);
                        showProjectDetailModal(project);
                    });
                });
            }

            // Function to filter and re-render project grid
            function applyProjectFilters() {
                const region = document.getElementById('project-filter-region').value;
                const status = document.getElementById('project-filter-status').value;
                const minCompletion = parseInt(document.getElementById('project-filter-min-completion').value) || 0;
                const maxCompletion = parseInt(document.getElementById('project-filter-max-completion').value) || 100;

                let filtered = window.projectsFilterData.filter(p => {
                    const matchRegion = !region || p.region === region;
                    const matchStatus = !status || p.status === status;
                    const matchCompletion = p.completion >= minCompletion && p.completion <= maxCompletion;
                    return matchRegion && matchStatus && matchCompletion;
                });

                renderProjectGrid(filtered);
            }

            function renderProjectGrid(projects) {
                const grid = document.getElementById('projects-grid');
                grid.innerHTML = projects.map(p => `
                    <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 hover:shadow-lg transition-all">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-mono text-xs text-slate-500">${p.id}</span>
                            <span class="badge ${p.status === 'In Progress' ? 'badge-info' : 'badge-warning'}">${p.status}</span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 mb-2">${p.name}</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                            <div>
                                <p class="text-slate-500">Region</p>
                                <p class="font-semibold text-slate-700">${p.region || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">Location</p>
                                <p class="font-semibold text-slate-700">${p.location}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">Budget</p>
                                <p class="font-semibold text-slate-700">${(p.budget / 10000000).toFixed(2)}Cr</p>
                            </div>
                            <div>
                                <p class="text-slate-500">Project Type</p>
                                <p class="font-semibold text-slate-700">${p.projectType || 'Both'}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">Start Date</p>
                                <p class="font-semibold text-slate-700">${p.startDate}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">End Date</p>
                                <p class="font-semibold text-slate-700">${p.endDate}</p>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span class="text-slate-600">Progress</span>
                                <span class="font-bold text-teal-600">${p.completion}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${p.completion}%"></div>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button class="flex-1 btn btn-outline text-sm use-in-forecast" data-project-id="${p.id}">Use in Forecast</button>
                            <button class="btn btn-secondary text-sm view-project-details" data-project='${JSON.stringify(p)}'>View Details</button>
                        </div>
                    </div>
                `).join('');

                // Re-attach event listeners
                document.querySelectorAll('.use-in-forecast').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const projectId = btn.dataset.projectId;
                        localStorage.setItem('selectedProjectForForecast', projectId);
                        navigateToPage('forecast');
                    });
                });

                document.querySelectorAll('.view-project-details').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const project = JSON.parse(btn.dataset.project);
                        showProjectDetailModal(project);
                    });
                });
            }

            // Function to show detailed project view modal
            function showProjectDetailModal(project) {
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <div class="space-y-5">
                        <!-- Project Header -->
                        <div class="bg-gradient-to-r from-teal-600 to-blue-600 text-white p-5 rounded-lg shadow-md -m-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold mb-1">${project.name}</h2>
                                    <p class="text-teal-100 text-sm font-medium">Project ID: ${project.id}</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-3 py-1.5 rounded-full text-xs font-bold ${project.status === 'In Progress' ? 'bg-blue-400 text-blue-900' : project.status === 'Planning' ? 'bg-yellow-400 text-yellow-900' : 'bg-green-400 text-green-900'}">
                                        ${project.status}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Overview -->
                        <div class="bg-gradient-to-r from-teal-50 to-blue-50 p-4 rounded-lg border border-teal-200">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-slate-800">Project Progress</h3>
                                <span class="text-3xl font-bold text-teal-600">${project.completion}%</span>
                            </div>
                            <div class="progress-bar h-3">
                                <div class="progress-fill h-3" style="width: ${project.completion}%"></div>
                            </div>
                        </div>
                        
                        <!-- Key Information Grid -->
                        <div class="mb-5">
                            <h3 class="text-base font-bold text-slate-800 mb-3">Project Details</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p class="text-xs text-slate-500 mb-0.5">Region</p>
                                    <p class="text-sm font-bold text-slate-800">${project.region || 'N/A'}</p>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p class="text-xs text-slate-500 mb-0.5">State</p>
                                    <p class="text-sm font-bold text-slate-800">${project.location}</p>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p class="text-xs text-slate-500 mb-0.5">Budget</p>
                                    <p class="text-sm font-bold text-green-600">${(project.budget / 10000000).toFixed(2)} Cr</p>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p class="text-xs text-slate-500 mb-0.5">Tower Type</p>
                                    <p class="text-sm font-bold text-slate-800">${project.towerType}</p>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p class="text-xs text-slate-500 mb-0.5">Substation</p>
                                    <p class="text-sm font-bold text-slate-800">${project.substationType}</p>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p class="text-xs text-slate-500 mb-0.5">Project Type</p>
                                    <p class="text-sm font-bold text-slate-800">${project.projectType || 'Both'}</p>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                    <p class="text-xs text-slate-500 mb-0.5">Line Length</p>
                                    <p class="text-sm font-bold text-slate-800">${project.lineLength} km</p>
                                </div>
                                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 col-span-2">
                                    <p class="text-xs text-slate-500 mb-0.5">Duration</p>
                                    <p class="text-sm font-bold text-slate-800">${Math.ceil((new Date(project.endDate) - new Date(project.startDate)) / (1000 * 60 * 60 * 24 * 30))} months</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Timeline -->
                        <div class="bg-white border border-slate-200 rounded-lg p-4 mb-4">
                            <h3 class="text-base font-bold text-slate-800 mb-3">Project Timeline</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">Start Date</p>
                                    <p class="text-base font-bold text-blue-600">${new Date(project.startDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-slate-500 mb-1">End Date</p>
                                    <p class="text-base font-bold text-purple-600">${new Date(project.endDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Location Info -->
                        <div class="bg-white border border-slate-200 rounded-lg p-4 mb-4">
                            <h3 class="text-base font-bold text-slate-800 mb-2">Location Details</h3>
                            <div class="space-y-1.5 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Tower Locations:</span>
                                    <span class="font-semibold text-slate-800">${project.towerLocations?.length || 0} points</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-600">Substation Locations:</span>
                                    <span class="font-semibold text-slate-800">${project.substationLocations?.length || 0} points</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex gap-3 pt-4 border-t border-slate-200">
                            <button onclick="localStorage.setItem('selectedProjectForForecast', '${project.id}'); navigateToPage('forecast'); document.getElementById('modal-overlay').classList.add('hidden');" class="flex-1 btn btn-primary py-2.5 text-sm font-semibold">
                                <svg class="w-4 h-4 inline-block mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Use in Forecast
                            </button>
                            <button onclick="document.getElementById('modal-overlay').classList.add('hidden');" class="btn btn-secondary px-6 py-2.5 text-sm">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('modal-overlay').classList.remove('hidden');
            }

            async function renderAnalyticsPage() {
                showLoading();
                pageTitle.textContent = "Analytics Dashboard";

                // Sync all data for accurate metrics
                api.syncAllData();

                const projects = await api.getProjectsSummary();
                const materials = await api.getMaterialsSummary();
                const forecasts = await api.getForecasts();
                const orders = await api.getProcurementOrders();
                const recommendedPOs = await api.getRecommendedPOs();

                // Calculate comprehensive health metrics
                const healthMetrics = {
                    // Inventory Health
                    inventoryHealth: ((materials.filter(m => m.status === 'Good').length / materials.length) * 100).toFixed(1),
                    criticalMaterials: materials.filter(m => m.status === 'Critical').length,
                    totalInventoryValue: materials.reduce((sum, m) => sum + (m.currentStock * m.costPerUnit), 0),

                    // Project Readiness
                    avgProjectCompletion: (projects.reduce((sum, p) => sum + p.completion, 0) / projects.length).toFixed(1),
                    atRiskProjects: projects.filter(p => {
                        const fulfillment = api.calculateProjectFulfillment(p.id);
                        return fulfillment < 70;
                    }).length,
                    onTrackProjects: projects.filter(p => p.completion >= 50 && p.completion < 100).length,

                    // Forecast Accuracy
                    forecastAccuracy: api.calculateForecastAccuracy(),
                    totalForecasts: forecasts.length,
                    accurateForecasts: forecastsData.filter(f => f.actualQty && Math.abs(f.variance || 0) < 10).length,

                    // Procurement Efficiency
                    activeOrders: orders.filter(o => o.status === 'In Transit').length,
                    avgDeliveryTime: orders.filter(o => o.deliveryDays).reduce((sum, o) => sum + o.deliveryDays, 0) / Math.max(1, orders.filter(o => o.deliveryDays).length),
                    onTimeDelivery: ((orders.filter(o => o.deliveryDays && o.deliveryDays <= 30).length / Math.max(1, orders.filter(o => o.deliveryDays).length)) * 100).toFixed(1),

                    // Cost Metrics
                    totalBudget: projects.reduce((sum, p) => sum + p.budget, 0),
                    totalSpent: procurementData.reduce((sum, po) => sum + po.totalCost, 0),
                    budgetUtilization: ((procurementData.reduce((sum, po) => sum + po.totalCost, 0) / projects.reduce((sum, p) => sum + p.budget, 0)) * 100).toFixed(1),

                    // Alerts & Recommendations
                    urgentAlerts: recommendedPOs.filter(r => r.urgency === 'Critical').length,
                    totalRecommendations: recommendedPOs.length
                };

                hideLoading();

                // Store original data for filtering
                window.analyticsData = { projects, materials, forecasts, orders, healthMetrics };

                mainContent.innerHTML = `
                    <div class="fade-in">
                        <!-- Overall Health Score -->
                        <div class="bg-gradient-to-r from-teal-500 to-blue-600 p-8 rounded-2xl shadow-lg text-white mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h2 class="text-3xl font-bold mb-2"> Supply Chain Health Dashboard</h2>
                                    <p class="text-teal-100 text-sm">Real-time performance metrics across all operations</p>
                                </div>
                                <div class="text-center bg-white/10 backdrop-blur-sm rounded-2xl px-8 py-6">
                                    <p class="text-sm text-teal-100 mb-1">Overall Health Score</p>
                                    <p class="text-5xl font-black">${Math.round((parseFloat(healthMetrics.inventoryHealth) + parseFloat(healthMetrics.forecastAccuracy) + parseFloat(healthMetrics.onTimeDelivery) + parseFloat(healthMetrics.avgProjectCompletion)) / 4)}%</p>
                                    <p class="text-xs text-teal-200 mt-2">Excellent Performance</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Critical Alerts Section -->
                        ${healthMetrics.urgentAlerts > 0 || healthMetrics.atRiskProjects > 0 || healthMetrics.criticalMaterials > 0 ? `
                        <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6 mb-6">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 bg-red-500 text-white p-3 rounded-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-red-900 mb-2"> Urgent Attention Required</h3>
                                    <div class="space-y-2">
                                        ${healthMetrics.criticalMaterials > 0 ? `<p class="text-red-800"> <strong>${healthMetrics.criticalMaterials}</strong> material(s) at critical stock levels</p>` : ''}
                                        ${healthMetrics.atRiskProjects > 0 ? `<p class="text-red-800"> <strong>${healthMetrics.atRiskProjects}</strong> project(s) at risk due to material shortages</p>` : ''}
                                        ${healthMetrics.urgentAlerts > 0 ? `<p class="text-red-800"> <strong>${healthMetrics.urgentAlerts}</strong> critical procurement recommendation(s) pending</p>` : ''}
                                    </div>
                                    <div class="flex gap-3 mt-4">
                                        <button class="btn btn-primary text-sm" onclick="navigateToPage('inventory')">View Inventory</button>
                                        <button class="btn btn-outline text-sm" onclick="navigateToPage('procurement')">Check Procurement</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- 4 Pillars of Health -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <!-- Inventory Health -->
                            <div class="bg-white rounded-xl shadow-sm border-2 border-purple-200 p-6 hover:shadow-lg transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="bg-purple-100 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-black text-purple-600">${healthMetrics.inventoryHealth}%</span>
                                </div>
                                <h3 class="font-bold text-slate-800 mb-2">Inventory Health</h3>
                                <div class="space-y-1 text-sm">
                                    <p class="text-slate-600">Total Value: <span class="font-bold">${(healthMetrics.totalInventoryValue / 10000000).toFixed(1)}Cr</span></p>
                                    <p class="text-slate-600">Critical Items: <span class="font-bold text-red-600">${healthMetrics.criticalMaterials}</span></p>
                                    <p class="text-slate-600">Total Materials: <span class="font-bold">${materials.length}</span></p>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-purple-600 h-2 rounded-full" style="width: ${healthMetrics.inventoryHealth}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Project Readiness -->
                            <div class="bg-white rounded-xl shadow-sm border-2 border-teal-200 p-6 hover:shadow-lg transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="bg-teal-100 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-black text-teal-600">${healthMetrics.avgProjectCompletion}%</span>
                                </div>
                                <h3 class="font-bold text-slate-800 mb-2">Project Readiness</h3>
                                <div class="space-y-1 text-sm">
                                    <p class="text-slate-600">Total Projects: <span class="font-bold">${projects.length}</span></p>
                                    <p class="text-slate-600">At Risk: <span class="font-bold text-red-600">${healthMetrics.atRiskProjects}</span></p>
                                    <p class="text-slate-600">On Track: <span class="font-bold text-green-600">${healthMetrics.onTrackProjects}</span></p>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-teal-600 h-2 rounded-full" style="width: ${healthMetrics.avgProjectCompletion}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Forecast Accuracy -->
                            <div class="bg-white rounded-xl shadow-sm border-2 border-blue-200 p-6 hover:shadow-lg transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="bg-blue-100 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-black text-blue-600">${healthMetrics.forecastAccuracy}%</span>
                                </div>
                                <h3 class="font-bold text-slate-800 mb-2">Forecast Accuracy</h3>
                                <div class="space-y-1 text-sm">
                                    <p class="text-slate-600">Total Forecasts: <span class="font-bold">${healthMetrics.totalForecasts}</span></p>
                                    <p class="text-slate-600">Accurate: <span class="font-bold text-green-600">${healthMetrics.accurateForecasts}</span></p>
                                    <p class="text-slate-600">AI Confidence: <span class="font-bold">High</span></p>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full" style="width: ${healthMetrics.forecastAccuracy}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Procurement Efficiency -->
                            <div class="bg-white rounded-xl shadow-sm border-2 border-orange-200 p-6 hover:shadow-lg transition-all">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="bg-orange-100 p-3 rounded-lg">
                                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-2xl font-black text-orange-600">${healthMetrics.onTimeDelivery}%</span>
                                </div>
                                <h3 class="font-bold text-slate-800 mb-2">Procurement Efficiency</h3>
                                <div class="space-y-1 text-sm">
                                    <p class="text-slate-600">Active Orders: <span class="font-bold">${healthMetrics.activeOrders}</span></p>
                                    <p class="text-slate-600">Avg Delivery: <span class="font-bold">${healthMetrics.avgDeliveryTime.toFixed(0)} days</span></p>
                                    <p class="text-slate-600">On-Time Rate: <span class="font-bold text-green-600">${healthMetrics.onTimeDelivery}%</span></p>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-orange-600 h-2 rounded-full" style="width: ${healthMetrics.onTimeDelivery}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cost & Budget Overview -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 p-6">
                            <h3 class="text-xl font-bold text-slate-800 mb-6"> Cost & Budget Overview</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="text-center p-6 bg-blue-50 rounded-lg border-2 border-blue-200">
                                    <p class="text-sm text-blue-600 font-semibold mb-2">Total Budget</p>
                                    <p class="text-4xl font-black text-blue-700">${(healthMetrics.totalBudget / 10000000).toFixed(1)}Cr</p>
                                    <p class="text-xs text-blue-500 mt-2">Allocated across ${projects.length} projects</p>
                                </div>
                                <div class="text-center p-6 bg-purple-50 rounded-lg border-2 border-purple-200">
                                    <p class="text-sm text-purple-600 font-semibold mb-2">Total Spent</p>
                                    <p class="text-4xl font-black text-purple-700">${(healthMetrics.totalSpent / 10000000).toFixed(1)}Cr</p>
                                    <p class="text-xs text-purple-500 mt-2">Procurement to date</p>
                                </div>
                                <div class="text-center p-6 bg-teal-50 rounded-lg border-2 border-teal-200">
                                    <p class="text-sm text-teal-600 font-semibold mb-2">Budget Utilization</p>
                                    <p class="text-4xl font-black text-teal-700">${healthMetrics.budgetUtilization}%</p>
                                    <div class="w-full bg-slate-200 rounded-full h-3 mt-3">
                                        <div class="bg-teal-600 h-3 rounded-full" style="width: ${healthMetrics.budgetUtilization}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Drill-Down Sections -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <!-- Project Health by Region -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-lg font-bold text-slate-800 mb-4"> Project Health by Region</h3>
                                <div class="space-y-3">
                                    ${Array.from(new Set(projects.map(p => p.region))).map(region => {
                    const regionProjects = projects.filter(p => p.region === region);
                    const avgCompletion = (regionProjects.reduce((sum, p) => sum + p.completion, 0) / regionProjects.length).toFixed(1);
                    const atRisk = regionProjects.filter(p => api.calculateProjectFulfillment(p.id) < 70).length;
                    return `
                                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg border border-slate-200">
                                                <div class="flex-1">
                                                    <p class="font-bold text-slate-800">${region}</p>
                                                    <p class="text-xs text-slate-600">${regionProjects.length} project(s)  ${atRisk} at risk</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-2xl font-black ${parseFloat(avgCompletion) >= 70 ? 'text-green-600' : 'text-orange-600'}">${avgCompletion}%</p>
                                                    <div class="w-24 bg-slate-200 rounded-full h-2 mt-1">
                                                        <div class="bg-teal-600 h-2 rounded-full" style="width: ${avgCompletion}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                }).join('')}
                                </div>
                            </div>
                            
                            <!-- Top Materials by Value -->
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <h3 class="text-lg font-bold text-slate-800 mb-4"> Top Materials by Inventory Value</h3>
                                <div class="space-y-3">
                                    ${materials
                        .map(m => ({ ...m, value: m.currentStock * m.costPerUnit }))
                        .sort((a, b) => b.value - a.value)
                        .slice(0, 6)
                        .map((m, idx) => `
                                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                <div class="flex items-center gap-3">
                                                    <div class="bg-purple-100 text-purple-700 font-black w-8 h-8 rounded-lg flex items-center justify-center text-sm">
                                                        ${idx + 1}
                                                    </div>
                                                    <div>
                                                        <p class="font-bold text-slate-800 text-sm">${m.name}</p>
                                                        <p class="text-xs text-slate-600">${m.currentStock.toLocaleString()} ${m.unit} in stock</p>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <p class="font-black text-purple-600">${(m.value / 100000).toFixed(1)}L</p>
                                                    <span class="text-xs px-2 py-1 rounded-full ${m.status === 'Good' ? 'bg-green-100 text-green-700' : m.status === 'Low' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">
                                                        ${m.status}
                                                    </span>
                                                </div>
                                            </div>
                                        `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Forecast Accuracy Trend -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                            <h3 class="text-lg font-bold text-slate-800 mb-4"> AI Forecast Accuracy Trend</h3>
                            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                                ${forecasts
                        .filter(f => f.actualQty !== null && f.actualQty !== undefined)
                        .slice(-6)
                        .map(f => {
                            const accuracy = f.accuracy || (100 - Math.abs((f.forecastedQty - f.actualQty) / f.forecastedQty * 100));
                            return `
                                            <div class="text-center p-4 bg-slate-50 rounded-lg border border-slate-200">
                                                <p class="text-xs text-slate-600 mb-2">${f.month || 'N/A'}</p>
                                                <p class="text-3xl font-black ${accuracy >= 90 ? 'text-green-600' : accuracy >= 80 ? 'text-blue-600' : 'text-orange-600'}">${accuracy.toFixed(0)}%</p>
                                                <div class="w-full bg-slate-200 rounded-full h-2 mt-2">
                                                    <div class="bg-teal-600 h-2 rounded-full" style="width: ${accuracy}%"></div>
                                                </div>
                                            </div>
                                        `;
                        }).join('')}
                                ${forecasts.filter(f => f.actualQty !== null && f.actualQty !== undefined).length === 0 ? `
                                    <div class="col-span-6 text-center py-8 text-slate-500">
                                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <p class="text-lg font-semibold">No forecast accuracy data available</p>
                                        <p class="text-sm mt-2">Generate forecasts with actual data to see accuracy trends</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Supplier Performance -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h3 class="text-lg font-bold text-slate-800 mb-4"> Supplier Performance Scorecard</h3>
                            <div class="overflow-x-auto">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Supplier</th>
                                            <th>Category</th>
                                            <th>Rating</th>
                                            <th>On-Time Delivery</th>
                                            <th>Quality Score</th>
                                            <th>Active Orders</th>
                                            <th>Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${suppliersData.map(supplier => {
                            const activeOrders = procurementData.filter(po => po.supplierId === supplier.id && po.status === 'In Transit').length;
                            const overallScore = ((supplier.rating / 5 * 100) + supplier.onTimeDelivery + supplier.qualityScore) / 3;
                            return `
                                                <tr>
                                                    <td class="font-bold text-slate-800">${supplier.name}</td>
                                                    <td>${supplier.category}</td>
                                                    <td>
                                                        <span class="text-yellow-500 font-bold"> ${supplier.rating}</span>
                                                        <span class="text-xs text-slate-500">/ 5.0</span>
                                                    </td>
                                                    <td>
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-20 bg-slate-200 rounded-full h-2">
                                                                <div class="bg-green-600 h-2 rounded-full" style="width: ${supplier.onTimeDelivery}%"></div>
                                                            </div>
                                                            <span class="text-sm font-semibold">${supplier.onTimeDelivery}%</span>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-20 bg-slate-200 rounded-full h-2">
                                                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${supplier.qualityScore}%"></div>
                                                            </div>
                                                            <span class="text-sm font-semibold">${supplier.qualityScore}%</span>
                                                        </div>
                                                    </td>
                                                    <td class="font-bold text-teal-600">${activeOrders}</td>
                                                    <td>
                                                        <span class="badge ${overallScore >= 90 ? 'badge-success' : overallScore >= 75 ? 'badge-info' : 'badge-warning'}">
                                                            ${overallScore >= 90 ? 'Excellent' : overallScore >= 75 ? 'Good' : 'Fair'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `;
                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                hideLoading();
            }

            async function renderProcurementPage() {
                showLoading();
                pageTitle.textContent = "Procurement Orders";

                // Sync all data
                api.syncAllData();

                const orders = await api.getProcurementOrders();
                const recommendedPOs = await api.getRecommendedPOs();
                const materials = await api.getMaterialsSummary();
                const suppliers = suppliersData;

                // Calculate procurement metrics
                const procurementMetrics = {
                    totalActive: orders.filter(o => o.status === 'In Transit').length,
                    totalPending: orders.filter(o => o.status === 'Pending').length,
                    totalDelivered: orders.filter(o => o.status === 'Delivered').length,
                    totalValue: orders.reduce((sum, o) => sum + o.totalValue, 0),
                    avgDeliveryDays: orders.filter(o => o.status === 'Delivered').reduce((sum, o) => sum + o.deliveryDays, 0) / Math.max(1, orders.filter(o => o.status === 'Delivered').length),
                    recommendedCount: recommendedPOs.length,
                    urgentRecommendations: recommendedPOs.filter(r => r.urgency === 'Critical').length
                };

                hideLoading();

                mainContent.innerHTML = `
                    <div class="fade-in">
                        <!-- Procurement Dashboard -->
                        <div class="bg-gradient-to-r from-blue-500 to-teal-600 p-8 rounded-2xl shadow-lg text-white mb-6">
                            <h2 class="text-3xl font-bold mb-4">Procurement Control Center</h2>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-blue-100 text-sm font-medium">Active POs</p>
                                    <p class="text-3xl font-bold mt-1">${procurementMetrics.totalActive}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-blue-100 text-sm font-medium">Pending Approval</p>
                                    <p class="text-3xl font-bold mt-1 text-yellow-300">${procurementMetrics.totalPending}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-blue-100 text-sm font-medium">AI Recommendations</p>
                                    <p class="text-3xl font-bold mt-1 text-orange-300">${procurementMetrics.recommendedCount}</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-blue-100 text-sm font-medium">Total Value</p>
                                    <p class="text-3xl font-bold mt-1">${(procurementMetrics.totalValue / 10000000).toFixed(1)}Cr</p>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                                    <p class="text-blue-100 text-sm font-medium">Avg Delivery</p>
                                    <p class="text-3xl font-bold mt-1">${procurementMetrics.avgDeliveryDays.toFixed(0)} days</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Recommended Purchase Orders -->
                        ${recommendedPOs.length > 0 ? `
                        <div class="bg-orange-50 border-l-4 border-orange-500 rounded-lg p-6 mb-6">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 bg-orange-500 text-white p-3 rounded-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-orange-900 mb-2"> AI-Powered Procurement Recommendations</h3>
                                    <p class="text-orange-800 mb-3">
                                        Our AI has identified <strong>${recommendedPOs.length}</strong> recommended purchase orders based on inventory shortfalls, 
                                        demand forecasts, and project timelines.
                                    </p>
                                    <button class="btn btn-primary text-sm" onclick="document.getElementById('ai-recommendations').scrollIntoView({behavior: 'smooth'})">
                                        View Recommendations
                                    </button>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Tabs -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                            <div class="border-b border-slate-200">
                                <div class="flex gap-2 p-2">
                                    <button class="procurement-tab-btn active" data-tab="recommendations">
                                         AI Recommendations (${recommendedPOs.length})
                                    </button>
                                    <button class="procurement-tab-btn" data-tab="active">
                                         Active POs (${procurementMetrics.totalActive})
                                    </button>
                                    <button class="procurement-tab-btn" data-tab="create">
                                         Create New PO
                                    </button>
                                    <button class="procurement-tab-btn" data-tab="suppliers">
                                         Supplier Scorecards
                                    </button>
                                    <button class="procurement-tab-btn" data-tab="history">
                                         PO History
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <!-- AI Recommendations Tab -->
                                <div class="procurement-tab-content" id="recommendations">
                                    ${recommendedPOs.length > 0 ? `
                                        <div id="ai-recommendations" class="space-y-6">
                                            ${recommendedPOs.map((rec, idx) => {
                    const material = materialMasterData.find(m => m.id === rec.materialId) || {
                        name: 'Unknown Material',
                        unit: 'units',
                        currentStock: 0,
                        safetyStock: 0,
                        leadTime: 0
                    };
                    const supplier = suppliersData.find(s => s.id === rec.supplierId);

                    const urgencyStyles = rec.urgency === 'Critical'
                        ? 'border-red-200 bg-red-50'
                        : rec.urgency === 'High'
                            ? 'border-orange-200 bg-orange-50'
                            : 'border-yellow-200 bg-yellow-50';

                    return `
                                                    <div class="border-2 ${urgencyStyles} rounded-lg p-6">
                                                        <div class="flex justify-between items-start mb-4">
                                                            <div class="flex-1">
                                                                <div class="flex items-center gap-3 mb-2">
                                                                    <h4 class="font-bold text-slate-800 text-lg">${material.name || 'Unknown Material'}</h4>
                                                                    <span class="badge badge-${rec.urgency === 'Critical' ? 'danger' : rec.urgency === 'High' ? 'warning' : 'info'} text-xs">
                                                                        ${rec.urgency || 'Medium'} Priority
                                                                    </span>
                                                                    <span class="text-xs px-3 py-1 rounded-full bg-purple-100 text-purple-700 font-semibold">
                                                                        AI Score: ${rec.confidence.toFixed(0)}%
                                                                    </span>
                                                                </div>
                                                                <p class="text-sm text-slate-600 mb-3">
                                                                    <strong>Reason:</strong> ${rec.reason}
                                                                </p>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                                            <div class="bg-white rounded-lg p-3 border border-slate-200">
                                                                <p class="text-xs text-slate-500 mb-1">Recommended Qty</p>
                                                                <p class="text-xl font-bold text-teal-600">${(rec.recommendedQty || 0).toLocaleString()} ${material.unit || 'units'}</p>
                                                            </div>
                                                            <div class="bg-white rounded-lg p-3 border border-slate-200">
                                                                <p class="text-xs text-slate-500 mb-1">Estimated Cost</p>
                                                                <p class="text-xl font-bold text-blue-600">${((rec.estimatedCost || 0) / 100000).toFixed(2)}L</p>
                                                            </div>
                                                            <div class="bg-white rounded-lg p-3 border border-slate-200">
                                                                <p class="text-xs text-slate-500 mb-1">Preferred Supplier</p>
                                                                <p class="text-lg font-bold text-slate-800">${supplier ? supplier.name : 'N/A'}</p>
                                                                <p class="text-xs text-green-600">${supplier ? ` ${supplier.rating}/5.0` : ''}</p>
                                                            </div>
                                                            <div class="bg-white rounded-lg p-3 border border-slate-200">
                                                                <p class="text-xs text-slate-500 mb-1">Lead Time</p>
                                                                <p class="text-xl font-bold text-orange-600">${material.leadTime || 0} days</p>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="bg-white border border-slate-200 rounded-lg p-4 mb-4">
                                                            <p class="text-sm font-semibold text-slate-700 mb-2"> Impact Analysis</p>
                                                            <div class="grid grid-cols-3 gap-3 text-sm">
                                                                <div>
                                                                    <p class="text-slate-600">Current Stock</p>
                                                                    <p class="font-bold text-slate-800">${(material.currentStock || 0).toLocaleString()} ${material.unit || 'units'}</p>
                                                                </div>
                                                                <div>
                                                                    <p class="text-slate-600">After PO</p>
                                                                    <p class="font-bold text-green-600">+${((material.currentStock || 0) + (rec.recommendedQty || 0)).toLocaleString()} ${material.unit || 'units'}</p>
                                                                </div>
                                                                <div>
                                                                    <p class="text-slate-600">Safety Stock</p>
                                                                    <p class="font-bold ${((material.currentStock || 0) + (rec.recommendedQty || 0)) >= (material.safetyStock || 0) ? 'text-green-600' : 'text-red-600'}">
                                                                        ${(material.safetyStock || 0).toLocaleString()} ${material.unit || 'units'}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="flex gap-3">
                                                            <button class="btn btn-primary flex-1 approve-recommended-po" data-rec-index="${idx}">
                                                                 Approve & Create PO
                                                            </button>
                                                            <button class="btn btn-outline edit-recommended-po" data-rec-index="${idx}">
                                                                 Modify
                                                            </button>
                                                            <button class="btn btn-secondary dismiss-recommended-po" data-rec-index="${idx}">
                                                                 Dismiss
                                                            </button>
                                                        </div>
                                                    </div>
                                                `;
                }).join('')}
                                        </div>
                                    ` : `
                                        <div class="text-center py-12 text-slate-500">
                                            <svg class="w-20 h-20 mx-auto mb-4 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-xl font-bold text-green-600"> All Clear!</p>
                                            <p class="text-sm mt-2">No urgent procurement recommendations at this time</p>
                                            <p class="text-xs mt-1 text-slate-400">Our AI monitors inventory 24/7 and will alert you when action is needed</p>
                                        </div>
                                    `}
                                </div>
                                
                                <!-- Active POs Tab -->
                                <div class="procurement-tab-content hidden" id="active">
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>PO Number</th>
                                                    <th>Material</th>
                                                    <th>Quantity</th>
                                                    <th>Supplier</th>
                                                    <th>Order Date</th>
                                                    <th>Expected Delivery</th>
                                                    <th>Days Remaining</th>
                                                    <th>Total Value</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${orders.filter(o => o.status === 'In Transit').map(o => {
                    const daysRemaining = Math.ceil((new Date(o.expectedDate) - new Date()) / (1000 * 60 * 60 * 24));
                    return `
                                                        <tr>
                                                            <td class="font-mono text-xs font-bold">${o.id || 'N/A'}</td>
                                                            <td class="font-semibold">${o.material || 'N/A'}</td>
                                                            <td>${(o.quantity || 0).toLocaleString()}</td>
                                                            <td>${o.supplier || 'N/A'}</td>
                                                            <td class="text-sm">${o.orderDate ? new Date(o.orderDate).toLocaleDateString() : 'N/A'}</td>
                                                            <td class="text-sm">${o.expectedDate ? new Date(o.expectedDate).toLocaleDateString() : 'N/A'}</td>
                                                            <td class="font-bold ${daysRemaining < 7 ? 'text-orange-600' : 'text-slate-600'}">${daysRemaining} days</td>
                                                            <td class="font-bold">${((o.totalValue || 0) / 100000).toFixed(2)}L</td>
                                                            <td><span class="badge badge-info">${o.status || 'Unknown'}</span></td>
                                                            <td><button class="text-teal-500 hover:text-teal-700 font-semibold text-sm">Track</button></td>
                                                        </tr>
                                                    `;
                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Create New PO Tab -->
                                <div class="procurement-tab-content hidden" id="create">
                                    <form id="new-po-form" class="space-y-6 max-w-3xl">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Material *</label>
                                                <select id="po-material-select" required class="w-full">
                                                    <option value="">Select Material</option>
                                                    ${materials.map(m => `<option value="${m.id}">${m.name} (Current: ${m.currentStock} ${m.unit})</option>`).join('')}
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Quantity *</label>
                                                <input type="number" id="po-quantity" required min="1" class="w-full" placeholder="Enter quantity">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Supplier *</label>
                                                <select id="po-supplier-select" required class="w-full">
                                                    <option value="">Select Supplier</option>
                                                    ${suppliers.map(s => `<option value="${s.id}">${s.name} (Rating: ${s.rating}/5.0)</option>`).join('')}
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Expected Delivery Date *</label>
                                                <input type="date" id="po-delivery-date" required class="w-full">
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Notes</label>
                                            <textarea id="po-notes" rows="3" class="w-full" placeholder="Additional notes or requirements..."></textarea>
                                        </div>
                                        <div class="flex gap-3">
                                            <button type="submit" class="btn btn-primary">Create Purchase Order</button>
                                            <button type="reset" class="btn btn-secondary">Clear Form</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Supplier Scorecards Tab -->
                                <div class="procurement-tab-content hidden" id="suppliers">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        ${suppliers.map(supplier => `
                                            <div class="border-2 border-slate-200 rounded-lg p-6 hover:shadow-lg transition-all">
                                                <div class="flex justify-between items-start mb-4">
                                                    <div>
                                                        <h4 class="font-bold text-slate-800 text-lg">${supplier.name}</h4>
                                                        <p class="text-sm text-slate-600">${supplier.category}</p>
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="text-2xl font-black text-teal-600">${supplier.rating}</p>
                                                        <p class="text-xs text-slate-500">/ 5.0</p>
                                                    </div>
                                                </div>
                                                
                                                <div class="space-y-3 mb-4">
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm text-slate-600">On-Time Delivery</span>
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-32 bg-slate-200 rounded-full h-2">
                                                                <div class="bg-green-500 h-2 rounded-full" style="width: ${supplier.onTimeDelivery}%"></div>
                                                            </div>
                                                            <span class="font-bold text-sm text-green-600">${supplier.onTimeDelivery}%</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm text-slate-600">Quality Score</span>
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-32 bg-slate-200 rounded-full h-2">
                                                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${supplier.qualityScore}%"></div>
                                                            </div>
                                                            <span class="font-bold text-sm text-blue-600">${supplier.qualityScore}%</span>
                                                        </div>
                                                    </div>
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-sm text-slate-600">Response Time</span>
                                                        <span class="font-bold text-sm text-slate-800">${supplier.responseTime}h</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="pt-4 border-t border-slate-200">
                                                    <p class="text-xs text-slate-500 mb-2">Active POs: ${orders.filter(o => o.supplierId === supplier.id && o.status === 'In Transit').length}</p>
                                                    <button class="btn btn-outline w-full text-sm">View Supplier Details</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- PO History Tab -->
                                <div class="procurement-tab-content hidden" id="history">
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>PO Number</th>
                                                    <th>Material</th>
                                                    <th>Quantity</th>
                                                    <th>Supplier</th>
                                                    <th>Order Date</th>
                                                    <th>Delivered Date</th>
                                                    <th>Delivery Days</th>
                                                    <th>Total Value</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${orders.map(o => `
                                                    <tr>
                                                        <td class="font-mono text-xs font-bold">${o.id}</td>
                                                        <td class="font-semibold">${o.material}</td>
                                                        <td>${o.quantity.toLocaleString()}</td>
                                                        <td>${o.supplier}</td>
                                                        <td class="text-sm">${new Date(o.orderDate).toLocaleDateString()}</td>
                                                        <td class="text-sm">${o.deliveredDate ? new Date(o.deliveredDate).toLocaleDateString() : '-'}</td>
                                                        <td class="font-bold ${o.deliveryDays > 30 ? 'text-red-600' : 'text-green-600'}">${o.deliveryDays || '-'}</td>
                                                        <td class="font-bold">${(o.totalValue / 100000).toFixed(2)}L</td>
                                                        <td><span class="badge ${o.status === 'Delivered' ? 'badge-success' : o.status === 'In Transit' ? 'badge-info' : 'badge-warning'}">${o.status}</span></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Tab switching functionality
                const tabBtns = document.querySelectorAll('.procurement-tab-btn');
                const tabContents = document.querySelectorAll('.procurement-tab-content');

                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetTab = btn.dataset.tab;

                        tabBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        tabContents.forEach(content => {
                            content.classList.add('hidden');
                            if (content.id === targetTab) {
                                content.classList.remove('hidden');
                            }
                        });
                    });
                });

                // Show the first tab (recommendations) by default
                const firstTab = document.querySelector('.procurement-tab-content#recommendations');
                if (firstTab) {
                    firstTab.classList.remove('hidden');
                }

                // Check if there's a prepopulated PO from Inventory page
                if (window.prepopulatedPO) {
                    const poData = window.prepopulatedPO;

                    // Switch to Create PO tab
                    document.querySelector('[data-tab="create"]').click();

                    // Pre-fill form
                    setTimeout(() => {
                        document.getElementById('po-material-select').value = poData.materialId;
                        document.getElementById('po-quantity').value = poData.quantity;
                        document.getElementById('po-supplier-select').value = poData.supplierId;
                        document.getElementById('po-notes').value = poData.triggerReason;

                        // Clear the prepopulated data
                        delete window.prepopulatedPO;
                    }, 100);
                }

                // Approve Recommended PO
                document.querySelectorAll('.approve-recommended-po').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const recIndex = parseInt(btn.dataset.recIndex);
                        const rec = recommendedPOs[recIndex];

                        // Create the PO
                        alert(` Purchase Order Created!\n\nPO #: PO-${Date.now()}\nMaterial: ${rec.materialName}\nQuantity: ${rec.recommendedQty}\nSupplier: ${rec.supplierName}\nEstimated Cost: ${(rec.estimatedCost / 100000).toFixed(2)}L\n\nThe PO has been submitted for approval and the supplier has been notified.`);

                        // Remove from recommendations
                        btn.closest('div[class*="border-2"]').style.opacity = '0.3';
                        btn.innerHTML = ' Approved';
                        btn.disabled = true;
                    });
                });

                // Dismiss Recommended PO
                document.querySelectorAll('.dismiss-recommended-po').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (confirm('Are you sure you want to dismiss this recommendation?')) {
                            btn.closest('div[class*="border-2"]').style.display = 'none';
                        }
                    });
                });

                // Edit Recommended PO
                document.querySelectorAll('.edit-recommended-po').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const recIndex = parseInt(btn.dataset.recIndex);
                        const rec = recommendedPOs[recIndex];

                        // Switch to Create tab and pre-fill
                        document.querySelector('[data-tab="create"]').click();

                        setTimeout(() => {
                            document.getElementById('po-material-select').value = rec.materialId;
                            document.getElementById('po-quantity').value = rec.recommendedQty;
                            document.getElementById('po-supplier-select').value = rec.supplierId;
                            document.getElementById('po-notes').value = `Modified from AI recommendation: ${rec.reason}`;
                        }, 100);
                    });
                });

                // New PO Form submission
                document.getElementById('new-po-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();

                    const materialId = document.getElementById('po-material-select').value;
                    const quantity = document.getElementById('po-quantity').value;
                    const supplierId = document.getElementById('po-supplier-select').value;
                    const deliveryDate = document.getElementById('po-delivery-date').value;
                    const notes = document.getElementById('po-notes').value;

                    const material = materials.find(m => m.id === materialId);
                    const supplier = suppliers.find(s => s.id === supplierId);

                    const estimatedCost = quantity * (material.costPerUnit || 1000);

                    alert(` Purchase Order Created Successfully!\n\nMaterial: ${material.name}\nQuantity: ${parseInt(quantity).toLocaleString()} ${material.unit}\nSupplier: ${supplier.name}\nExpected Delivery: ${new Date(deliveryDate).toLocaleDateString()}\nEstimated Cost: ${(estimatedCost / 100000).toFixed(2)}L\n\nPO #: PO-${Date.now()}\n\nThe purchase order has been submitted for approval.`);

                    e.target.reset();
                });
            }

            // Global print and download functions
            window.printReport = function () {
                setTimeout(() => {
                    window.print();
                }, 100);
            };

            window.downloadReport = function () {
                alert('To save as PDF:\n\n1. Click OK to open Print dialog\n2. Select "Save as PDF" or "Microsoft Print to PDF" as printer\n3. Click Save');
                window.printReport();
            };

            async function renderReportsPage() {
                pageTitle.textContent = "Reports & Analytics";
                const projects = await api.getProjectsSummary();
                const materials = await api.getMaterialsSummary();

                mainContent.innerHTML = `
                    <div class="fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all cursor-pointer">
                                <svg class="w-12 h-12 text-teal-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <h3 class="text-lg font-bold text-slate-800 mb-2">Inventory Report</h3>
                                <p class="text-sm text-slate-600 mb-4">Complete stock analysis and valuation</p>
                                <button class="btn btn-outline w-full text-sm report-btn" data-report="inventory">Generate Report</button>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all cursor-pointer">
                                <svg class="w-12 h-12 text-blue-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <h3 class="text-lg font-bold text-slate-800 mb-2">Financial Summary</h3>
                                <p class="text-sm text-slate-600 mb-4">Procurement costs and budget analysis</p>
                                <button class="btn btn-outline w-full text-sm report-btn" data-report="financial">Generate Report</button>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all cursor-pointer">
                                <svg class="w-12 h-12 text-purple-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                                <h3 class="text-lg font-bold text-slate-800 mb-2">Forecast Performance</h3>
                                <p class="text-sm text-slate-600 mb-4">AI model accuracy metrics</p>
                                <button class="btn btn-outline w-full text-sm report-btn" data-report="forecast">Generate Report</button>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all cursor-pointer">
                                <svg class="w-12 h-12 text-orange-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                <h3 class="text-lg font-bold text-slate-800 mb-2">Procurement Performance</h3>
                                <p class="text-sm text-slate-600 mb-4">Order status and delivery analytics</p>
                                <button class="btn btn-outline w-full text-sm report-btn" data-report="procurement">Generate Report</button>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all cursor-pointer">
                                <svg class="w-12 h-12 text-indigo-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                <h3 class="text-lg font-bold text-slate-800 mb-2">Supplier Analysis</h3>
                                <p class="text-sm text-slate-600 mb-4">Vendor performance and reliability</p>
                                <button class="btn btn-outline w-full text-sm report-btn" data-report="supplier">Generate Report</button>
                            </div>
                            
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg transition-all cursor-pointer">
                                <svg class="w-12 h-12 text-cyan-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <h3 class="text-lg font-bold text-slate-800 mb-2">Project Performance</h3>
                                <p class="text-sm text-slate-600 mb-4">Overall project health dashboard</p>
                                <button class="btn btn-outline w-full text-sm report-btn" data-report="project">Generate Report</button>
                            </div>
                        </div>
                        
                        <div id="report-display" class="hidden"></div>
                    </div>
                `;

                // Add report generation functionality
                document.querySelectorAll('.report-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const reportType = btn.dataset.report;
                        const reportDisplay = document.getElementById('report-display');

                        btn.innerHTML = '<svg class="animate-spin h-5 w-5 inline" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';

                        await new Promise(resolve => setTimeout(resolve, 1500));

                        btn.innerHTML = ' Report Generated';
                        btn.classList.add('bg-green-500', 'text-white', 'border-green-500');

                        // Generate report content based on type
                        let reportHTML = '';
                        const reportDate = new Date().toLocaleDateString('en-IN', { dateStyle: 'long' });

                        if (reportType === 'inventory') {
                            const totalValue = materials.reduce((sum, m) => sum + (m.currentStock * 5000), 0);
                            const criticalItems = materials.filter(m => m.status === 'Critical').length;
                            const lowStockItems = materials.filter(m => m.status === 'Low').length;

                            reportHTML = `
                                <div class="printable-report fade-in bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-slate-200">
                                        <div>
                                            <h2 class="text-3xl font-bold text-slate-800">Inventory Analysis Report</h2>
                                            <p class="text-sm text-slate-500 mt-1">Generated on ${reportDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='40' viewBox='0 0 120 40'%3E%3Ctext x='0' y='25' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='%23064E3B'%3EPOWERGRID%3C/text%3E%3C/svg%3E" alt="POWERGRID">
                                            <p class="text-xs text-slate-500 mt-1">Report ID: INV-${Date.now()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Materials</p>
                                            <p class="text-3xl font-bold mt-2">${materials.length}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Value</p>
                                            <p class="text-3xl font-bold mt-2">${(totalValue / 10000000).toFixed(1)}Cr</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Low Stock</p>
                                            <p class="text-3xl font-bold mt-2">${lowStockItems}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Critical Items</p>
                                            <p class="text-3xl font-bold mt-2">${criticalItems}</p>
                                        </div>
                                    </div>
                                    
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">Detailed Stock Analysis</h3>
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Material ID</th>
                                                    <th>Material Name</th>
                                                    <th>Category</th>
                                                    <th>Current Stock</th>
                                                    <th>Reorder Level</th>
                                                    <th>Status</th>
                                                    <th>Est. Value ()</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${materials.map(m => `
                                                    <tr>
                                                        <td class="font-mono text-xs">${m.id}</td>
                                                        <td class="font-semibold">${m.name}</td>
                                                        <td>${m.category}</td>
                                                        <td>${m.currentStock.toLocaleString()} ${m.unit}</td>
                                                        <td>${m.reorderLevel.toLocaleString()}</td>
                                                        <td><span class="badge ${m.status === 'Good' ? 'badge-success' : m.status === 'Low' ? 'badge-warning' : 'badge-danger'}">${m.status}</span></td>
                                                        <td>${(m.currentStock * 5000).toLocaleString()}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-8 flex gap-4 no-print">
                                        <button class="btn btn-primary" onclick="window.printReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            Print Report
                                        </button>
                                        <button class="btn btn-outline" onclick="window.downloadReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Download PDF
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else if (reportType === 'financial') {
                            const totalBudget = projects.reduce((sum, p) => sum + p.budget, 0);
                            const avgProjectCost = totalBudget / projects.length;
                            const completedProjects = projects.filter(p => p.completion === 100).length;

                            reportHTML = `
                                <div class="printable-report fade-in bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-slate-200">
                                        <div>
                                            <h2 class="text-3xl font-bold text-slate-800">Financial Summary Report</h2>
                                            <p class="text-sm text-slate-500 mt-1">Generated on ${reportDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='40' viewBox='0 0 120 40'%3E%3Ctext x='0' y='25' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='%23064E3B'%3EPOWERGRID%3C/text%3E%3C/svg%3E" alt="POWERGRID">
                                            <p class="text-xs text-slate-500 mt-1">Report ID: FIN-${Date.now()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Investment</p>
                                            <p class="text-3xl font-bold mt-2">${(totalBudget / 10000000).toFixed(1)}Cr</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Avg Project Cost</p>
                                            <p class="text-3xl font-bold mt-2">${(avgProjectCost / 10000000).toFixed(1)}Cr</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Active Projects</p>
                                            <p class="text-3xl font-bold mt-2">${projects.length}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">ROI Estimate</p>
                                            <p class="text-3xl font-bold mt-2">18.5%</p>
                                        </div>
                                    </div>
                                    
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">Project Budget Breakdown</h3>
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Project ID</th>
                                                    <th>Project Name</th>
                                                    <th>Location</th>
                                                    <th>Budget ()</th>
                                                    <th>Completion</th>
                                                    <th>Spent ()</th>
                                                    <th>Remaining ()</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${projects.map(p => {
                                const spent = (p.budget * p.completion / 100);
                                const remaining = p.budget - spent;
                                return `
                                                        <tr>
                                                            <td class="font-mono text-xs">${p.id}</td>
                                                            <td class="font-semibold">${p.name}</td>
                                                            <td>${p.location}</td>
                                                            <td>${(p.budget / 10000000).toFixed(2)}Cr</td>
                                                            <td><span class="badge badge-info">${p.completion}%</span></td>
                                                            <td>${(spent / 10000000).toFixed(2)}Cr</td>
                                                            <td>${(remaining / 10000000).toFixed(2)}Cr</td>
                                                        </tr>
                                                    `;
                            }).join('')}
                                            </tbody>
                                            <tfoot>
                                                <tr class="bg-slate-50 font-bold text-lg">
                                                    <td colspan="3" class="text-right">Total:</td>
                                                    <td>${(totalBudget / 10000000).toFixed(2)}Cr</td>
                                                    <td colspan="3"></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div class="bg-slate-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-slate-800 mb-3">Budget Utilization</h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Materials & Equipment</span>
                                                        <span class="font-bold">45%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 45%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Labor & Contractors</span>
                                                        <span class="font-bold">30%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 30%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Transportation & Logistics</span>
                                                        <span class="font-bold">15%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 15%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Miscellaneous</span>
                                                        <span class="font-bold">10%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 10%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-slate-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-slate-800 mb-3">Key Financial Metrics</h4>
                                            <div class="space-y-4">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">Cost Variance</span>
                                                    <span class="font-bold text-green-600">-2.3%</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">Schedule Performance</span>
                                                    <span class="font-bold text-teal-600">98.5%</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">Budget Utilization Rate</span>
                                                    <span class="font-bold text-blue-600">67.8%</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">Forecasted Completion</span>
                                                    <span class="font-bold text-purple-600">Q4 2025</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-8 flex gap-4 no-print">
                                        <button class="btn btn-primary" onclick="window.printReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            Print Report
                                        </button>
                                        <button class="btn btn-outline" onclick="window.downloadReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Download PDF
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else if (reportType === 'procurement') {
                            const orders = await api.getProcurementOrders();
                            const activeOrders = orders.filter(o => o.status === 'In Transit');
                            const completedOrders = orders.filter(o => o.status === 'Delivered');
                            const pendingOrders = orders.filter(o => o.status === 'Pending');
                            const avgDeliveryTime = completedOrders.length > 0 ? completedOrders.reduce((sum, o) => sum + o.deliveryDays, 0) / completedOrders.length : 0;
                            const totalValue = orders.reduce((sum, o) => sum + o.totalValue, 0);

                            reportHTML = `
                                <div class="printable-report fade-in bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-slate-200">
                                        <div>
                                            <h2 class="text-3xl font-bold text-slate-800">Procurement Performance Report</h2>
                                            <p class="text-sm text-slate-500 mt-1">Generated on ${reportDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='40' viewBox='0 0 120 40'%3E%3Ctext x='0' y='25' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='%23064E3B'%3EPOWERGRID%3C/text%3E%3C/svg%3E" alt="POWERGRID">
                                            <p class="text-xs text-slate-500 mt-1">Report ID: PRO-${Date.now()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Orders</p>
                                            <p class="text-3xl font-bold mt-2">${orders.length}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Active Orders</p>
                                            <p class="text-3xl font-bold mt-2">${activeOrders.length}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Value</p>
                                            <p class="text-3xl font-bold mt-2">${(totalValue / 10000000).toFixed(1)}Cr</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Avg Delivery</p>
                                            <p class="text-3xl font-bold mt-2">${avgDeliveryTime.toFixed(1)} days</p>
                                        </div>
                                    </div>
                                    
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">Order Status Breakdown</h3>
                                    <div class="overflow-x-auto mb-6">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>PO Number</th>
                                                    <th>Material</th>
                                                    <th>Supplier</th>
                                                    <th>Quantity</th>
                                                    <th>Value ()</th>
                                                    <th>Status</th>
                                                    <th>Delivery Days</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${orders.slice(0, 15).map(o => `
                                                    <tr>
                                                        <td class="font-mono text-xs">${o.poNumber || 'N/A'}</td>
                                                        <td class="font-semibold">${o.materialName || 'N/A'}</td>
                                                        <td>${o.supplierName || 'N/A'}</td>
                                                        <td>${(o.quantity || 0).toLocaleString()} ${o.unit || ''}</td>
                                                        <td>${(o.totalValue || 0).toLocaleString()}</td>
                                                        <td><span class="badge ${o.status === 'Delivered' ? 'badge-success' : o.status === 'In Transit' ? 'badge-warning' : 'badge-info'}">${o.status || 'Unknown'}</span></td>
                                                        <td>${o.deliveryDays || 'Pending'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                        <div class="bg-slate-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-slate-800 mb-4">Delivery Performance</h4>
                                            <div class="space-y-3">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">On-Time Delivery Rate</span>
                                                    <span class="font-bold text-green-600">87.5%</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">Average Delay (Late Orders)</span>
                                                    <span class="font-bold text-amber-600">3.2 days</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">Orders in Transit</span>
                                                    <span class="font-bold text-blue-600">${activeOrders.length}</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-slate-600">Completed This Quarter</span>
                                                    <span class="font-bold text-teal-600">${completedOrders.length}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-slate-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-slate-800 mb-4">Cost Analysis</h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Conductors & Cables</span>
                                                        <span class="font-bold">35%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 35%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Transformers</span>
                                                        <span class="font-bold">28%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 28%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Steel & Towers</span>
                                                        <span class="font-bold">22%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 22%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Others</span>
                                                        <span class="font-bold">15%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 15%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-8 flex gap-4 no-print">
                                        <button class="btn btn-primary" onclick="window.printReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            Print Report
                                        </button>
                                        <button class="btn btn-outline" onclick="window.downloadReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Download PDF
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else if (reportType === 'supplier') {
                            const orders = await api.getProcurementOrders();
                            const supplierPerformance = suppliersData.map(s => {
                                const supplierOrders = orders.filter(o => o.supplierId === s.id);
                                const completedOrders = supplierOrders.filter(o => o.status === 'Delivered');
                                const onTimeOrders = completedOrders.filter(o => o.deliveryDays <= o.expectedDeliveryDays);
                                return {
                                    ...s,
                                    totalOrders: supplierOrders.length,
                                    completedOrders: completedOrders.length,
                                    onTimeRate: completedOrders.length > 0 ? (onTimeOrders.length / completedOrders.length * 100) : 0,
                                    totalValue: supplierOrders.reduce((sum, o) => sum + o.totalValue, 0)
                                };
                            }).sort((a, b) => b.totalValue - a.totalValue);

                            reportHTML = `
                                <div class="printable-report fade-in bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-slate-200">
                                        <div>
                                            <h2 class="text-3xl font-bold text-slate-800">Supplier Performance Analysis</h2>
                                            <p class="text-sm text-slate-500 mt-1">Generated on ${reportDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='40' viewBox='0 0 120 40'%3E%3Ctext x='0' y='25' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='%23064E3B'%3EPOWERGRID%3C/text%3E%3C/svg%3E" alt="POWERGRID">
                                            <p class="text-xs text-slate-500 mt-1">Report ID: SUP-${Date.now()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Active Suppliers</p>
                                            <p class="text-3xl font-bold mt-2">${suppliersData.length}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Avg Rating</p>
                                            <p class="text-3xl font-bold mt-2">${(suppliersData.reduce((sum, s) => sum + s.rating, 0) / suppliersData.length).toFixed(1)}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Avg On-Time Rate</p>
                                            <p class="text-3xl font-bold mt-2">${(supplierPerformance.reduce((sum, s) => sum + s.onTimeRate, 0) / supplierPerformance.length).toFixed(1)}%</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Contracts</p>
                                            <p class="text-3xl font-bold mt-2">${(supplierPerformance.reduce((sum, s) => sum + s.totalValue, 0) / 10000000).toFixed(1)}Cr</p>
                                        </div>
                                    </div>
                                    
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">Supplier Performance Matrix</h3>
                                    <div class="overflow-x-auto mb-6">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Supplier Name</th>
                                                    <th>Specialization</th>
                                                    <th>Rating</th>
                                                    <th>Total Orders</th>
                                                    <th>On-Time Rate</th>
                                                    <th>Contract Value</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${supplierPerformance.map(s => `
                                                    <tr>
                                                        <td class="font-semibold">${s.name}</td>
                                                        <td>${s.specialization}</td>
                                                        <td>
                                                            <div class="flex items-center gap-1">
                                                                <span class="font-bold">${s.rating.toFixed(1)}</span>
                                                                <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                                            </div>
                                                        </td>
                                                        <td>${s.totalOrders}</td>
                                                        <td>
                                                            <span class="badge ${s.onTimeRate >= 90 ? 'badge-success' : s.onTimeRate >= 75 ? 'badge-warning' : 'badge-danger'}">
                                                                ${s.onTimeRate.toFixed(1)}%
                                                            </span>
                                                        </td>
                                                        <td>${(s.totalValue / 10000000).toFixed(2)}Cr</td>
                                                        <td><span class="badge badge-success">Active</span></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="bg-teal-50 border-l-4 border-teal-500 p-6 rounded-lg mb-6">
                                        <div class="flex items-start gap-3">
                                            <svg class="w-6 h-6 text-teal-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <div class="flex-1">
                                                <h4 class="font-bold text-teal-800 mb-2">Top Performer</h4>
                                                <p class="text-sm text-teal-700">${supplierPerformance[0].name} leads with ${supplierPerformance[0].onTimeRate.toFixed(1)}% on-time delivery rate and ${(supplierPerformance[0].totalValue / 10000000).toFixed(1)}Cr in contracts.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-8 flex gap-4 no-print">
                                        <button class="btn btn-primary" onclick="window.printReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            Print Report
                                        </button>
                                        <button class="btn btn-outline" onclick="window.downloadReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Download PDF
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else if (reportType === 'project') {
                            const avgCompletion = projects.reduce((sum, p) => sum + p.completion, 0) / projects.length;
                            const onSchedule = projects.filter(p => p.status === 'On Track').length;
                            const delayed = projects.filter(p => p.status === 'Delayed').length;

                            reportHTML = `
                                <div class="printable-report fade-in bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-slate-200">
                                        <div>
                                            <h2 class="text-3xl font-bold text-slate-800">Project Performance Dashboard</h2>
                                            <p class="text-sm text-slate-500 mt-1">Generated on ${reportDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='40' viewBox='0 0 120 40'%3E%3Ctext x='0' y='25' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='%23064E3B'%3EPOWERGRID%3C/text%3E%3C/svg%3E" alt="POWERGRID">
                                            <p class="text-xs text-slate-500 mt-1">Report ID: PRJ-${Date.now()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Projects</p>
                                            <p class="text-3xl font-bold mt-2">${projects.length}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">On Schedule</p>
                                            <p class="text-3xl font-bold mt-2">${onSchedule}</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Avg Completion</p>
                                            <p class="text-3xl font-bold mt-2">${avgCompletion.toFixed(1)}%</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Total Budget</p>
                                            <p class="text-3xl font-bold mt-2">${(projects.reduce((sum, p) => sum + p.budget, 0) / 10000000).toFixed(0)}Cr</p>
                                        </div>
                                    </div>
                                    
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">Project Status Overview</h3>
                                    <div class="overflow-x-auto mb-6">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Project Name</th>
                                                    <th>Region</th>
                                                    <th>Completion</th>
                                                    <th>Project Type</th>
                                                    <th>Budget</th>
                                                    <th>Status</th>
                                                    <th>Health</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${projects.map(p => `
                                                    <tr>
                                                        <td class="font-semibold">${p.name}</td>
                                                        <td>${p.region}</td>
                                                        <td>
                                                            <div class="flex items-center gap-2">
                                                                <div class="progress-bar h-2 flex-1" style="min-width: 60px">
                                                                    <div class="progress-fill" style="width: ${p.completion}%"></div>
                                                                </div>
                                                                <span class="text-xs font-bold">${p.completion}%</span>
                                                            </div>
                                                        </td>
                                                        <td>${p.projectType || 'Both'}</td>
                                                        <td>${(p.budget / 10000000).toFixed(1)}Cr</td>
                                                        <td>
                                                            <span class="badge ${p.status === 'On Track' ? 'badge-success' :
                                    p.status === 'Delayed' ? 'badge-danger' :
                                        p.status === 'At Risk' ? 'badge-warning' : 'badge-info'
                                }">${p.status}</span>
                                                        </td>
                                                        <td>
                                                            <span class="text-2xl">${p.completion >= 80 ? '' :
                                    p.completion >= 50 ? '' : ''
                                }</span>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                        <div class="bg-green-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-green-800 mb-2"> On Track</h4>
                                            <p class="text-3xl font-bold text-green-600">${onSchedule}</p>
                                            <p class="text-sm text-green-700 mt-1">${((onSchedule / projects.length) * 100).toFixed(1)}% of projects</p>
                                        </div>
                                        <div class="bg-amber-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-amber-800 mb-2"> At Risk</h4>
                                            <p class="text-3xl font-bold text-amber-600">${projects.filter(p => p.status === 'At Risk').length}</p>
                                            <p class="text-sm text-amber-700 mt-1">Require attention</p>
                                        </div>
                                        <div class="bg-red-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-red-800 mb-2"> Delayed</h4>
                                            <p class="text-3xl font-bold text-red-600">${delayed}</p>
                                            <p class="text-sm text-red-700 mt-1">Behind schedule</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-8 flex gap-4 no-print">
                                        <button class="btn btn-primary" onclick="window.printReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            Print Report
                                        </button>
                                        <button class="btn btn-outline" onclick="window.downloadReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Download PDF
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else if (reportType === 'forecast') {
                            reportHTML = `
                                <div class="printable-report fade-in bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                                    <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-slate-200">
                                        <div>
                                            <h2 class="text-3xl font-bold text-slate-800">AI Forecast Performance Report</h2>
                                            <p class="text-sm text-slate-500 mt-1">Generated on ${reportDate}</p>
                                        </div>
                                        <div class="text-right">
                                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='40' viewBox='0 0 120 40'%3E%3Ctext x='0' y='25' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='%23064E3B'%3EPOWERGRID%3C/text%3E%3C/svg%3E" alt="POWERGRID">
                                            <p class="text-xs text-slate-500 mt-1">Report ID: FC-${Date.now()}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Model Accuracy</p>
                                            <p class="text-3xl font-bold mt-2">96.2%</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-teal-500 to-teal-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Forecasts Generated</p>
                                            <p class="text-3xl font-bold mt-2">1,247</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Cost Savings</p>
                                            <p class="text-3xl font-bold mt-2">12.5Cr</p>
                                        </div>
                                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                                            <p class="text-sm opacity-90">Avg Confidence</p>
                                            <p class="text-3xl font-bold mt-2">94.8%</p>
                                        </div>
                                    </div>
                                    
                                    <h3 class="text-xl font-bold text-slate-800 mb-4">Monthly Accuracy Trends</h3>
                                    <div class="bg-slate-50 p-6 rounded-xl mb-6">
                                        <canvas id="forecast-performance-chart" height="100"></canvas>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                        <div class="bg-slate-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-slate-800 mb-4">Prediction Accuracy by Category</h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Steel & Towers</span>
                                                        <span class="font-bold text-green-600">97.5%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill bg-green-500" style="width: 97.5%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Conductors & Cables</span>
                                                        <span class="font-bold text-green-600">95.8%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill bg-green-500" style="width: 95.8%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Transformers</span>
                                                        <span class="font-bold text-green-600">94.2%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill bg-green-500" style="width: 94.2%"></div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="flex justify-between text-sm mb-1">
                                                        <span>Insulators</span>
                                                        <span class="font-bold text-teal-600">96.7%</span>
                                                    </div>
                                                    <div class="progress-bar h-3">
                                                        <div class="progress-fill" style="width: 96.7%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-slate-50 p-6 rounded-xl">
                                            <h4 class="font-bold text-slate-800 mb-4">AI Model Insights</h4>
                                            <div class="space-y-3">
                                                <div class="flex items-start gap-3">
                                                    <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                    <span class="text-sm text-slate-700">Accuracy improved by 2.3% this quarter</span>
                                                </div>
                                                <div class="flex items-start gap-3">
                                                    <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                    <span class="text-sm text-slate-700">Reduced forecasting time by 45%</span>
                                                </div>
                                                <div class="flex items-start gap-3">
                                                    <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                    <span class="text-sm text-slate-700">Zero critical forecast failures</span>
                                                </div>
                                                <div class="flex items-start gap-3">
                                                    <svg class="w-5 h-5 text-teal-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                                    <span class="text-sm text-slate-700">Model trained on 50,000+ historical data points</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                                        <div class="flex items-start gap-3">
                                            <svg class="w-6 h-6 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <div class="flex-1">
                                                <h4 class="font-bold text-blue-800 mb-2">Recommendation</h4>
                                                <p class="text-sm text-blue-700">The AI model is performing exceptionally well with 96.2% accuracy. Consider expanding the training dataset with regional variations to improve accuracy for North East projects.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-8 flex gap-4 no-print">
                                        <button class="btn btn-primary" onclick="window.printReport()">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                            Print Report
                                        </button>
                                        <button class="btn btn-outline">
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                            Download PDF
                                        </button>
                                    </div>
                                </div>
                            `;
                        }

                        reportDisplay.innerHTML = reportHTML;
                        reportDisplay.classList.remove('hidden');
                        reportDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        // Render chart for forecast performance report
                        if (reportType === 'forecast') {
                            setTimeout(() => {
                                const ctx = document.getElementById('forecast-performance-chart')?.getContext('2d');
                                if (ctx) {
                                    new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                                            datasets: [{
                                                label: 'Accuracy %',
                                                data: [92.1, 93.5, 94.2, 94.8, 95.1, 95.4, 95.8, 96.0, 96.1, 96.0, 96.2, 96.2],
                                                borderColor: '#2dd4bf',
                                                backgroundColor: 'rgba(45, 212, 191, 0.1)',
                                                tension: 0.4,
                                                fill: true,
                                                borderWidth: 3
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: true,
                                            plugins: {
                                                legend: { display: false }
                                            },
                                            scales: {
                                                y: {
                                                    beginAtZero: false,
                                                    min: 90,
                                                    max: 100
                                                }
                                            }
                                        }
                                    });
                                }
                            }, 100);
                        }

                        // Reset button after some time
                        setTimeout(() => {
                            btn.innerHTML = 'Generate Report';
                            btn.classList.remove('bg-green-500', 'text-white', 'border-green-500');
                        }, 3000);
                    });
                });
            }

            async function renderSettingsPage() {
                pageTitle.textContent = "Settings";
                const currentUser = auth.currentUser;

                mainContent.innerHTML = `
                    <div class="fade-in max-w-4xl">
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Account Settings</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Email Address</label>
                                    <input type="email" value="${currentUser?.email || 'user@powergrid.in'}" disabled class="w-full bg-slate-100" />
                                    <p class="text-xs text-slate-500 mt-1">Email cannot be changed</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">User ID</label>
                                    <input type="text" value="${currentUser?.uid?.substring(0, 16) || 'N/A'}..." disabled class="w-full bg-slate-100" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Account Created</label>
                                    <input type="text" value="${currentUser?.metadata?.creationTime || 'N/A'}" disabled class="w-full bg-slate-100" />
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Notification Preferences</h2>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                    <div>
                                        <p class="font-semibold text-slate-800">Low Stock Alerts</p>
                                        <p class="text-sm text-slate-600">Get notified when materials reach reorder level</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                    <div>
                                        <p class="font-semibold text-slate-800">Project Updates</p>
                                        <p class="text-sm text-slate-600">Receive updates on project milestones</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                                    <div>
                                        <p class="font-semibold text-slate-800">Forecast Reports</p>
                                        <p class="text-sm text-slate-600">Weekly AI forecast accuracy reports</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Display Settings</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Dashboard Theme</label>
                                    <select id="theme-selector" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-jungle-green focus:border-jungle-green">
                                        <option value="light" selected>Light Mode</option>
                                        <option value="dark">Dark Mode</option>
                                        <option value="auto">Auto (System)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Date Format</label>
                                    <select id="date-format-selector" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-jungle-green focus:border-jungle-green">
                                        <option value="dd-mm-yyyy" selected>DD-MM-YYYY</option>
                                        <option value="mm-dd-yyyy">MM-DD-YYYY</option>
                                        <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Currency Display</label>
                                    <select id="currency-selector" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-jungle-green focus:border-jungle-green">
                                        <option value="inr" selected>Indian Rupee ()</option>
                                        <option value="usd">US Dollar ($)</option>
                                    </select>
                                </div>
                                <div class="pt-4">
                                    <button id="save-display-settings" class="btn btn-primary w-full">Apply Settings</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <h2 class="text-2xl font-bold text-slate-800 mb-6">Data Management</h2>
                            <div class="space-y-4">
                                <button class="w-full btn btn-outline flex items-center justify-center gap-2 export-data-btn">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Export All Data
                                </button>
                                <button class="w-full btn btn-outline flex items-center justify-center gap-2 import-data-btn">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    Import Project Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 p-8 rounded-xl">
                            <h2 class="text-2xl font-bold text-red-800 mb-4">Danger Zone</h2>
                            <p class="text-sm text-red-700 mb-4">These actions are irreversible. Please proceed with caution.</p>
                            <button class="btn text-white bg-red-600 hover:bg-red-700 border-none">Delete Account</button>
                        </div>
                        
                        <div class="flex justify-end gap-4 mt-6">
                            <button class="btn btn-secondary">Cancel</button>
                            <button class="btn btn-primary">Save Changes</button>
                        </div>
                    </div>
                `;

                // Load saved settings
                const savedTheme = localStorage.getItem('dashboardTheme') || 'light';
                const savedDateFormat = localStorage.getItem('dateFormat') || 'dd-mm-yyyy';
                const savedCurrency = localStorage.getItem('currency') || 'inr';

                document.getElementById('theme-selector').value = savedTheme;
                document.getElementById('date-format-selector').value = savedDateFormat;
                document.getElementById('currency-selector').value = savedCurrency;

                // Apply current theme
                applyTheme(savedTheme);

                // Theme selector change
                document.getElementById('theme-selector').addEventListener('change', (e) => {
                    const theme = e.target.value;
                    applyTheme(theme);
                });

                // Save display settings
                document.getElementById('save-display-settings')?.addEventListener('click', () => {
                    const theme = document.getElementById('theme-selector').value;
                    const dateFormat = document.getElementById('date-format-selector').value;
                    const currency = document.getElementById('currency-selector').value;

                    localStorage.setItem('dashboardTheme', theme);
                    localStorage.setItem('dateFormat', dateFormat);
                    localStorage.setItem('currency', currency);

                    applyTheme(theme);

                    alert('Display settings saved successfully!');
                });

                // Export data functionality
                document.querySelector('.export-data-btn')?.addEventListener('click', () => {
                    const data = JSON.stringify(projectsData, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `powergrid-data-${Date.now()}.json`;
                    a.click();
                    alert('Data exported successfully!');
                });

                // Import data functionality
                document.querySelector('.import-data-btn')?.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const imported = JSON.parse(event.target.result);
                                projectsData.push(...imported);
                                alert('Data imported successfully!');
                            } catch (err) {
                                alert('Error importing data: ' + err.message);
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                });
            }

            function attachQuickActionListeners() {
                document.querySelectorAll('.quick-action-btn, [data-page]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = btn.dataset.page;
                        if (page) navigateToPage(page);
                    });
                });
            }

            function navigateToPage(page) {
                // Update nav active state
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.page === page) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });

                // Sync data before rendering pages for fresh data
                api.syncAllData();

                // Render appropriate page
                switch (page) {
                    case 'dashboard': renderDashboard(); break;
                    case 'forecast':
                        renderForecastPage().then(() => {
                            // Auto-select project if coming from project page
                            const selectedProjectId = localStorage.getItem('selectedProjectForForecast');
                            if (selectedProjectId) {
                                const selector = document.getElementById('project-selector');
                                if (selector) {
                                    selector.value = selectedProjectId;
                                    selector.dispatchEvent(new Event('change'));
                                    document.getElementById('project-selection-card').classList.remove('hidden');
                                }
                                localStorage.removeItem('selectedProjectForForecast');
                            }
                            // setTimeout(() => {
                            //     attachForecastSubmitListener();
                            // }, 300);

                        });
                        break;
                    case 'inventory': renderInventoryPage(); break;
                    case 'projects': renderProjectsPage(); break;
                    case 'analytics': renderAnalyticsPage(); break;
                    case 'procurement': renderProcurementPage(); break;
                    case 'reports': renderReportsPage(); break;
                    case 'settings': renderSettingsPage(); break;
                }
            }

            // Attach nav listeners
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToPage(link.dataset.page);
                });
            });

            // Sidebar toggle functionality
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                });
            }

            // Modal close button
            const modalClose = document.getElementById('modal-close');
            const modalOverlay = document.getElementById('modal-overlay');

            if (modalClose) {
                modalClose.addEventListener('click', () => {
                    modalOverlay.classList.add('hidden');
                });
            }

            // Click outside modal to close
            if (modalOverlay) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        modalOverlay.classList.add('hidden');
                    }
                });
            }

            function showLoading() {
                loadingOverlay.classList.remove('hidden');
            }

            function hideLoading() {
                loadingOverlay.classList.add('hidden');
            }

            // Global utility functions
            window.navigateToPage = navigateToPage;
            window.showLoading = showLoading;
            window.hideLoading = hideLoading;

            // Global function for "Change Page" buttons in pagination
            window.changePage = function (page) {
                const event = new CustomEvent('pageChange', { detail: { page } });
                document.dispatchEvent(event);
            };

            // Global function for saving project allocations
            window.saveAllProjectAllocations = async function () {
                showLoading();
                const allocations = [];
                document.querySelectorAll('.material-allocation-input').forEach(input => {
                    allocations.push({
                        projectId: input.dataset.projectId,
                        materialId: input.dataset.materialId,
                        allocated: parseInt(input.value) || 0
                    });
                });

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoading();
                alert(`Successfully saved ${allocations.length} material allocations!`);
            };
        });
    </script>

</body>

</html>